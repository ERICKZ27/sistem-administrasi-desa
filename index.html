<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistem Administrasi Desa - Profesional</title>
    <!-- Memuat Tailwind CSS untuk styling utilitas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat Chart.js untuk visualisasi grafik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Memuat XLSX untuk fungsionalitas ekspor dan impor ke Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <!-- Memuat Font Awesome untuk ikon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <!-- Memuat Font Inter dari Google Fonts untuk tipografi profesional -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
    <!-- Menambahkan Font untuk KTP / OCR A Std (simulasi) -->
    <link href="https://fonts.googleapis.com/css2?family=OCR+A+Std&display=swap" rel="stylesheet" />

    <!-- Firebase SDK (Pastikan versi terbaru. Saat ini menggunakan 10.0.0, periksa jika ada versi yang lebih baru) -->
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-storage-compat.js"></script>

    <script>
      // Konfigurasi Firebase Anda (Ganti dengan konfigurasi proyek Anda yang sebenarnya dari Firebase Console)
      const firebaseConfig = {
        apiKey: "AIzaSyAuCgLHRo4MvNRmx0sNjfoZKf4Tw37mW4w",
        authDomain: "sistem-administrasi-desa.firebaseapp.com", // Ganti ini dengan nilai AKTUAL dari Firebase Console Anda!
        projectId: "sistem-administrasi-desa",
        storageBucket: "sistem-administrasi-desa.appspot.com", // Ganti ini dengan nilai AKTUAL dari Firebase Console Anda!
        messagingSenderId: "139088027532",
        appId: "1:139088027532:web:fa6d3ce9c9abe236ad40a9",
        measurementId: "G-XXXXXXXXXX", // Opsional, jika Anda menggunakan Google Analytics, ganti dengan ID Anda. Jika tidak, bisa dihapus.
      };

      // Inisialisasi Firebase
      firebase.initializeApp(firebaseConfig);

      // Ekspor layanan yang sering digunakan untuk akses global di aplikasi Anda
      const db = firebase.firestore();
      const auth = firebase.auth();
      const storage = firebase.storage();

      console.log("Firebase initialized successfully!"); // Untuk debugging
    </script>


    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6; /* Warna latar belakang default */
        color: #374151; /* Warna teks default */
      }
      .dark body {
        background-color: #1a202c; /* Warna latar belakang gelap */
        color: #e2e8f0; /* Warna teks gelap */
      }
      .header-search-input:focus,
      .form-input:focus,
      .form-select:focus,
      .form-textarea:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5); /* Blue-500 with opacity */
        border-color: #4299e1; /* Blue-500 */
      }
      .sidebar-link.active {
        background-color: #e0e7ff; /* Indigo-100 */
        color: #4338ca; /* Indigo-700 */
        font-weight: 600;
      }
      .dark .sidebar-link.active {
        background-color: #374151; /* Gray-700 */
        color: #818cf8; /* Indigo-400 */
      }
      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .toast {
        background-color: #fff;
        color: #333;
        padding: 10px 15px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 10px;
        opacity: 0;
        transform: translateY(-20px);
        transition: opacity 0.3s ease-out, transform 0.3s ease-out;
      }
      .dark .toast {
        background-color: #2d3748;
        color: #e2e8f0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }
      .toast .icon {
        font-size: 1.2em;
      }
      .toast span {
        font-weight: 500;
      }
      .ocr-font {
        font-family: "OCR A Std", monospace;
      }
      /* Custom scrollbar for Webkit browsers */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px; /* For horizontal scrollbars */
      }

      ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }

      .dark::-webkit-scrollbar-track {
        background: #2d3748;
      }

      ::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
      }

      .dark::-webkit-scrollbar-thumb {
        background: #555;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #555;
      }

      .dark::-webkit-scrollbar-thumb:hover {
        background: #777;
      }

      /* Untuk tabel dengan overflow scroll */
      .table-container {
        overflow-x: auto;
      }

      /* Card styling */
      .card {
        background-color: #ffffff;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        padding: 1.5rem;
      }

      .dark .card {
        background-color: #2d3748;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.2), 0 1px 2px 0 rgba(0, 0, 0, 0.12);
      }

      /* Modal backdrop */
      .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      /* Modal content */
      .modal-content {
        background-color: #fff;
        padding: 2rem;
        border-radius: 0.5rem;
        max-width: 90%;
        max-height: 90%;
        overflow-y: auto;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        position: relative;
        z-index: 1000;
      }
      .dark .modal-content {
        background-color: #2d3748;
      }

      /* Loader */
      .loader {
        border: 4px solid #f3f3f3; /* Light grey */
        border-top: 4px solid #3498db; /* Blue */
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200 flex h-screen">

    <!-- Login Form -->
    <div id="loginForm" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl w-96">
            <h2 class="text-3xl font-bold text-center text-indigo-700 dark:text-indigo-400 mb-6">Login Admin Desa</h2>
            <form id="adminLoginForm" class="space-y-4">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email Admin</label>
                    <input type="email" id="loginEmail" name="email" required class="form-input mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 text-gray-800 dark:text-gray-200" />
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Kata Sandi</label>
                    <input
                      type="password"
                      id="loginPassword"
                      name="password"
                      required
                      class="form-input mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 text-gray-800 dark:text-gray-200"
                    />
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">Login</button>
                <p id="loginError" class="text-red-500 text-sm mt-2 text-center hidden">Email atau kata sandi salah.</p>
            </form>
            <p class="text-center text-gray-600 dark:text-gray-400 mt-4">
                Belum punya akun? <a href="#" id="showRegisterModalLink" class="text-indigo-600 hover:underline">Daftar di sini</a>
            </p>
        </div>
    </div>

    <!-- Register Modal (Baru ditambahkan) -->
    <div id="registerModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl w-96">
            <h2 class="text-3xl font-bold text-center text-indigo-700 dark:text-indigo-400 mb-6">Daftar Admin Baru</h2>
            <form id="adminRegisterForm" class="space-y-4">
                <div>
                    <label for="registerEmail" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email</label>
                    <input type="email" id="registerEmail" name="email" required class="form-input mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 text-gray-800 dark:text-gray-200" />
                </div>
                <div>
                    <label for="registerPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Kata Sandi (min. 6 karakter)</label>
                    <input
                      type="password"
                      id="registerPassword"
                      name="password"
                      required
                      class="form-input mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 text-gray-800 dark:text-gray-200"
                    />
                </div>
                <div>
                    <label for="registerConfirmPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Konfirmasi Kata Sandi</label>
                    <input
                      type="password"
                      id="registerConfirmPassword"
                      name="confirmPassword"
                      required
                      class="form-input mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 text-gray-800 dark:text-gray-200"
                    />
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">Daftar</button>
                <p id="registerError" class="text-red-500 text-sm mt-2 text-center hidden"></p>
            </form>
            <p class="text-center text-gray-600 dark:text-gray-400 mt-4">
                Sudah punya akun? <a href="#" id="showLoginModalLink" class="text-indigo-600 hover:underline">Login di sini</a>
            </p>
        </div>
    </div>


    <!-- Main App Content (Sembunyikan sampai login berhasil) -->
    <div id="appContent" class="flex h-screen w-full hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-white dark:bg-gray-800 shadow-md flex flex-col justify-between">
          <div class="p-6">
            <h1 class="text-2xl font-extrabold text-indigo-700 dark:text-indigo-400 mb-8">Desa Digital</h1>
            <nav>
              <ul class="space-y-2">
                <li><a href="#dashboard" class="sidebar-link active flex items-center p-3 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200"><i class="fas fa-chart-line mr-3"></i>Dashboard</a></li>
                <li><a href="#warga" class="sidebar-link flex items-center p-3 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200"><i class="fas fa-users mr-3"></i>Data Warga</a></li>
                <li><a href="#surat" class="sidebar-link flex items-center p-3 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200"><i class="fas fa-envelope mr-3"></i>Surat-Menyurat</a></li>
                <li><a href="#tanah" class="sidebar-link flex items-center p-3 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200"><i class="fas fa-map-marked-alt mr-3"></i>Data Tanah</a></li>
                <li><a href="#kegiatan" class="sidebar-link flex items-center p-3 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200"><i class="fas fa-calendar-alt mr-3"></i>Kegiatan Desa</a></li>
                <li><a href="#keuangan" class="sidebar-link flex items-center p-3 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200"><i class="fas fa-cash-register mr-3"></i>Keuangan Desa</a></li>
                <li><a href="#pengaturan" class="sidebar-link flex items-center p-3 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200"><i class="fas fa-cogs mr-3"></i>Pengaturan</a></li>
              </ul>
            </nav>
          </div>
          <div class="p-6 border-t border-gray-200 dark:border-gray-700">
            <button id="logoutButton" class="w-full flex items-center justify-center p-3 text-red-600 dark:text-red-400 rounded-lg hover:bg-red-50 dark:hover:bg-red-900 transition-colors duration-200">
              <i class="fas fa-sign-out-alt mr-3"></i>Keluar
            </button>
          </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-8 overflow-y-auto">
          <!-- Header -->
          <header class="flex justify-between items-center mb-8">
            <h2 class="text-3xl font-bold text-gray-900 dark:text-gray-100" id="currentModuleTitle">Dashboard</h2>
            <div class="flex items-center space-x-4">
              <label for="darkModeToggle" class="flex items-center cursor-pointer">
                <span class="mr-2 text-gray-700 dark:text-gray-300">Mode Gelap</span>
                <div class="relative">
                  <input type="checkbox" id="darkModeToggle" class="sr-only">
                  <div class="block bg-gray-600 w-14 h-8 rounded-full"></div>
                  <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"></div>
                </div>
              </label>
              <div class="relative">
                <input type="text" placeholder="Cari..." class="header-search-input bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-full py-2 pl-4 pr-10 text-gray-800 dark:text-gray-200 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                <i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
              </div>
              <img src="https://via.placeholder.com/40" alt="Avatar Admin" class="w-10 h-10 rounded-full border-2 border-indigo-500">
            </div>
          </header>

          <!-- Toast Container -->
          <div id="toast-container" class="toast-container"></div>

          <!-- Content Area (This will change dynamically) -->
          <div id="contentArea">
            <!-- Dashboard Content -->
            <section id="dashboard" class="module-content">
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="card flex items-center justify-between">
                  <div>
                    <h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Total Warga</h3>
                    <p class="text-3xl font-bold text-indigo-700 dark:text-indigo-400" id="totalWarga">0</p>
                  </div>
                  <i class="fas fa-users text-5xl text-indigo-200 dark:text-indigo-800"></i>
                </div>
                <div class="card flex items-center justify-between">
                  <div>
                    <h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Surat Terbit</h3>
                    <p class="text-3xl font-bold text-green-700 dark:text-green-400" id="totalSurat">0</p>
                  </div>
                  <i class="fas fa-envelope-open-text text-5xl text-green-200 dark:text-green-800"></i>
                </div>
                <div class="card flex items-center justify-between">
                  <div>
                    <h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Kegiatan Aktif</h3>
                    <p class="text-3xl font-bold text-yellow-700 dark:text-yellow-400" id="totalKegiatan">0</p>
                  </div>
                  <i class="fas fa-calendar-check text-5xl text-yellow-200 dark:text-yellow-800"></i>
                </div>
                <div class="card flex items-center justify-between">
                  <div>
                    <h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Keuangan (Saldo)</h3>
                    <p class="text-3xl font-bold text-red-700 dark:text-red-400" id="totalKeuangan">Rp 0</p>
                  </div>
                  <i class="fas fa-wallet text-5xl text-red-200 dark:text-red-800"></i>
                </div>
              </div>

              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card">
                  <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200">Statistik Demografi Warga</h3>
                  <canvas id="demografiChart"></canvas>
                </div>
                <div class="card">
                  <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200">Aktivitas Surat Terakhir</h3>
                  <ul id="recentSuratList" class="space-y-2 text-gray-700 dark:text-gray-300">
                    <!-- Data surat terbaru akan dimuat di sini -->
                    <li><i class="fas fa-circle-info text-blue-500 mr-2"></i>Belum ada data surat.</li>
                  </ul>
                </div>
                <div class="card lg:col-span-2">
                  <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200">Log Aktivitas Terbaru</h3>
                  <div class="table-container">
                      <table class="min-w-full bg-white dark:bg-gray-700 rounded-lg shadow overflow-hidden">
                          <thead class="bg-gray-100 dark:bg-gray-600">
                              <tr>
                                  <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Waktu</th>
                                  <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Aktivitas</th>
                                  <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Pengguna</th>
                              </tr>
                          </thead>
                          <tbody id="auditLogsTableBody" class="divide-y divide-gray-200 dark:divide-gray-600">
                              <!-- Log aktivitas akan dimuat di sini -->
                              <tr>
                                  <td colspan="3" class="py-4 px-4 text-center text-gray-500 dark:text-gray-400">Belum ada log aktivitas.</td>
                              </tr>
                          </tbody>
                      </table>
                  </div>
                </div>
              </div>
            </section>

            <!-- Warga Module Content -->
            <section id="warga" class="module-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Manajemen Data Warga</h3>
                    <button id="tambahWargaBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center">
                        <i class="fas fa-plus mr-2"></i> Tambah Warga Baru
                    </button>
                </div>

                <!-- Filter dan Search -->
                <div class="card mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="filterStatus" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
                            <select id="filterStatus" class="form-select w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
                                <option value="">Semua</option>
                                <option value="Aktif">Aktif</option>
                                <option value="Non-Aktif">Non-Aktif</option>
                                <option value="Meninggal">Meninggal</option>
                                <option value="Pindah">Pindah</option>
                            </select>
                        </div>
                        <div>
                            <label for="filterGender" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Jenis Kelamin</label>
                            <select id="filterGender" class="form-select w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
                                <option value="">Semua</option>
                                <option value="Laki-laki">Laki-laki</option>
                                <option value="Perempuan">Perempuan</option>
                            </select>
                        </div>
                        <div>
                            <label for="searchWarga" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Cari Warga (Nama/NIK)</label>
                            <input type="text" id="searchWarga" placeholder="Cari nama atau NIK..." class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
                        </div>
                    </div>
                </div>

                <!-- Tombol Aksi Massal & Impor/Ekspor -->
                <div class="flex justify-between items-center mb-6">
                    <div class="flex space-x-3">
                        <button id="exportWargaBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center">
                            <i class="fas fa-file-excel mr-2"></i> Ekspor Data
                        </button>
                        <label for="importWargaInput" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center cursor-pointer">
                            <i class="fas fa-file-import mr-2"></i> Impor Data
                        </label>
                        <input type="file" id="importWargaInput" accept=".xlsx, .xls" class="hidden">
                    </div>
                    <button id="hapusWargaTerpilihBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center">
                        <i class="fas fa-trash-alt mr-2"></i> Hapus Terpilih
                    </button>
                </div>

                <!-- Tabel Data Warga -->
                <div class="card table-container">
                    <table class="min-w-full bg-white dark:bg-gray-700 rounded-lg shadow overflow-hidden">
                        <thead class="bg-gray-100 dark:bg-gray-600">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"><input type="checkbox" id="selectAllWarga"></th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Foto</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Nama Lengkap</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">NIK</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="wargaTableBody" class="divide-y divide-gray-200 dark:divide-gray-600">
                            <!-- Data warga akan dimuat di sini -->
                            <tr>
                                <td colspan="6" class="py-4 px-4 text-center text-gray-500 dark:text-gray-400">Belum ada data warga.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="flex justify-between items-center mt-6">
                    <button id="prevWargaPage" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg transition-colors duration-200" disabled>Sebelumnya</button>
                    <span id="currentPageWarga" class="text-gray-700 dark:text-gray-300">Halaman 1</span>
                    <button id="nextWargaPage" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg transition-colors duration-200" disabled>Berikutnya</button>
                </div>
            </section>

            <!-- Surat Module Content -->
            <section id="surat" class="module-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Manajemen Surat-Menyurat</h3>
                    <button id="tambahSuratBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center">
                        <i class="fas fa-plus mr-2"></i> Buat Surat Baru
                    </button>
                </div>

                <div class="card mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="filterJenisSurat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Jenis Surat</label>
                            <select id="filterJenisSurat" class="form-select w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
                                <option value="">Semua</option>
                                <option value="Keterangan Usaha">Keterangan Usaha</option>
                                <option value="Keterangan Domisili">Keterangan Domisili</option>
                                <option value="Keterangan Tidak Mampu">Keterangan Tidak Mampu</option>
                                <option value="Pengantar KTP">Pengantar KTP</option>
                                <option value="Kelahiran">Kelahiran</option>
                                <option value="Kematian">Kematian</option>
                                <!-- Tambahkan jenis surat lain jika diperlukan -->
                            </select>
                        </div>
                        <div>
                            <label for="filterStatusSurat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status Surat</label>
                            <select id="filterStatusSurat" class="form-select w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
                                <option value="">Semua</option>
                                <option value="Diajukan">Diajukan</option>
                                <option value="Diproses">Diproses</option>
                                <option value="Selesai">Selesai</option>
                                <option value="Ditolak">Ditolak</option>
                            </select>
                        </div>
                        <div>
                            <label for="searchSurat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Cari Surat (No/Nama)</label>
                            <input type="text" id="searchSurat" placeholder="Cari nomor surat atau nama pemohon..." class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
                        </div>
                    </div>
                </div>

                <div class="card table-container">
                    <table class="min-w-full bg-white dark:bg-gray-700 rounded-lg shadow overflow-hidden">
                        <thead class="bg-gray-100 dark:bg-gray-600">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">No. Surat</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Jenis Surat</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Pemohon</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Tanggal Pengajuan</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="suratTableBody" class="divide-y divide-gray-200 dark:divide-gray-600">
                            <!-- Data surat akan dimuat di sini -->
                            <tr>
                                <td colspan="6" class="py-4 px-4 text-center text-gray-500 dark:text-gray-400">Belum ada data surat.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-between items-center mt-6">
                    <button id="prevSuratPage" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg transition-colors duration-200" disabled>Sebelumnya</button>
                    <span id="currentPageSurat" class="text-gray-700 dark:text-gray-300">Halaman 1</span>
                    <button id="nextSuratPage" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg transition-colors duration-200" disabled>Berikutnya</button>
                </div>
            </section>

            <!-- Tanah Module Content -->
            <section id="tanah" class="module-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Manajemen Data Tanah</h3>
                    <button id="tambahTanahBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center">
                        <i class="fas fa-plus mr-2"></i> Tambah Data Tanah
                    </button>
                </div>

                <div class="card mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="filterJenisSertifikat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Jenis Sertifikat</label>
                            <select id="filterJenisSertifikat" class="form-select w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
                                <option value="">Semua</option>
                                <option value="SHM">Sertifikat Hak Milik (SHM)</option>
                                <option value="SHGB">Sertifikat Hak Guna Bangunan (SHGB)</option>
                                <option value="Akta Jual Beli">Akta Jual Beli (AJB)</option>
                                <option value="Girik/Letter C">Girik/Letter C</option>
                                <option value="Lainnya">Lainnya</option>
                            </select>
                        </div>
                        <div>
                            <label for="searchTanah" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Cari Tanah (No. Sertifikat/Pemilik)</label>
                            <input type="text" id="searchTanah" placeholder="Cari nomor sertifikat atau nama pemilik..." class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
                        </div>
                    </div>
                </div>

                <div class="card table-container">
                    <table class="min-w-full bg-white dark:bg-gray-700 rounded-lg shadow overflow-hidden">
                        <thead class="bg-gray-100 dark:bg-gray-600">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">No. Sertifikat</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Pemilik</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Luas (m²)</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Jenis Sertifikat</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Lokasi</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="tanahTableBody" class="divide-y divide-gray-200 dark:divide-gray-600">
                            <!-- Data tanah akan dimuat di sini -->
                            <tr>
                                <td colspan="6" class="py-4 px-4 text-center text-gray-500 dark:text-gray-400">Belum ada data tanah.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-between items-center mt-6">
                    <button id="prevTanahPage" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg transition-colors duration-200" disabled>Sebelumnya</button>
                    <span id="currentPageTanah" class="text-gray-700 dark:text-gray-300">Halaman 1</span>
                    <button id="nextTanahPage" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg transition-colors duration-200" disabled>Berikutnya</button>
                </div>
            </section>

            <!-- Kegiatan Module Content -->
            <section id="kegiatan" class="module-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Manajemen Kegiatan Desa</h3>
                    <button id="tambahKegiatanBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center">
                        <i class="fas fa-plus mr-2"></i> Tambah Kegiatan
                    </button>
                </div>

                <div class="card mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="filterStatusKegiatan" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status Kegiatan</label>
                            <select id="filterStatusKegiatan" class="form-select w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
                                <option value="">Semua</option>
                                <option value="Akan Datang">Akan Datang</option>
                                <option value="Sedang Berlangsung">Sedang Berlangsung</option>
                                <option value="Selesai">Selesai</option>
                                <option value="Dibatalkan">Dibatalkan</option>
                            </select>
                        </div>
                        <div>
                            <label for="searchKegiatan" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Cari Kegiatan (Nama)</label>
                            <input type="text" id="searchKegiatan" placeholder="Cari nama kegiatan..." class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
                        </div>
                    </div>
                </div>

                <div class="card table-container">
                    <table class="min-w-full bg-white dark:bg-gray-700 rounded-lg shadow overflow-hidden">
                        <thead class="bg-gray-100 dark:bg-gray-600">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Nama Kegiatan</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Tanggal</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Lokasi</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="kegiatanTableBody" class="divide-y divide-gray-200 dark:divide-gray-600">
                            <!-- Data kegiatan akan dimuat di sini -->
                            <tr>
                                <td colspan="5" class="py-4 px-4 text-center text-gray-500 dark:text-gray-400">Belum ada data kegiatan.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-between items-center mt-6">
                    <button id="prevKegiatanPage" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg transition-colors duration-200" disabled>Sebelumnya</button>
                    <span id="currentPageKegiatan" class="text-gray-700 dark:text-gray-300">Halaman 1</span>
                    <button id="nextKegiatanPage" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg transition-colors duration-200" disabled>Berikutnya</button>
                </div>
            </section>

            <!-- Keuangan Module Content -->
            <section id="keuangan" class="module-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Manajemen Keuangan Desa</h3>
                    <div class="flex space-x-3">
                        <button id="tambahPemasukanBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center">
                            <i class="fas fa-plus-circle mr-2"></i> Tambah Pemasukan
                        </button>
                        <button id="tambahPengeluaranBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center">
                            <i class="fas fa-minus-circle mr-2"></i> Tambah Pengeluaran
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="card bg-green-50 dark:bg-green-900 border-l-4 border-green-500">
                        <h4 class="text-lg font-semibold text-green-700 dark:text-green-300 mb-2">Total Pemasukan</h4>
                        <p class="text-3xl font-bold text-green-800 dark:text-green-200" id="totalPemasukan">Rp 0</p>
                    </div>
                    <div class="card bg-red-50 dark:bg-red-900 border-l-4 border-red-500">
                        <h4 class="text-lg font-semibold text-red-700 dark:text-red-300 mb-2">Total Pengeluaran</h4>
                        <p class="text-3xl font-bold text-red-800 dark:text-red-200" id="totalPengeluaran">Rp 0</p>
                    </div>
                    <div class="card md:col-span-2 bg-indigo-50 dark:bg-indigo-900 border-l-4 border-indigo-500">
                        <h4 class="text-lg font-semibold text-indigo-700 dark:text-indigo-300 mb-2">Saldo Saat Ini</h4>
                        <p class="text-4xl font-bold text-indigo-800 dark:text-indigo-200" id="saldoKeuangan">Rp 0</p>
                    </div>
                </div>

                <div class="card mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="filterJenisTransaksi" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Jenis Transaksi</label>
                            <select id="filterJenisTransaksi" class="form-select w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
                                <option value="">Semua</option>
                                <option value="Pemasukan">Pemasukan</option>
                                <option value="Pengeluaran">Pengeluaran</option>
                            </select>
                        </div>
                        <div>
                            <label for="filterBulanTahun" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Bulan/Tahun</label>
                            <input type="month" id="filterBulanTahun" class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
                        </div>
                        <div>
                            <label for="searchKeuangan" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Cari Transaksi (Deskripsi)</label>
                            <input type="text" id="searchKeuangan" placeholder="Cari deskripsi transaksi..." class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
                        </div>
                    </div>
                </div>

                <div class="card table-container">
                    <table class="min-w-full bg-white dark:bg-gray-700 rounded-lg shadow overflow-hidden">
                        <thead class="bg-gray-100 dark:bg-gray-600">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Tanggal</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Jenis</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Deskripsi</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Jumlah</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="keuanganTableBody" class="divide-y divide-gray-200 dark:divide-gray-600">
                            <!-- Data keuangan akan dimuat di sini -->
                            <tr>
                                <td colspan="5" class="py-4 px-4 text-center text-gray-500 dark:text-gray-400">Belum ada data keuangan.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-between items-center mt-6">
                    <button id="prevKeuanganPage" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg transition-colors duration-200" disabled>Sebelumnya</button>
                    <span id="currentPageKeuangan" class="text-gray-700 dark:text-gray-300">Halaman 1</span>
                    <button id="nextKeuanganPage" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg transition-colors duration-200" disabled>Berikutnya</button>
                </div>
            </section>

            <!-- Pengaturan Module Content -->
            <section id="pengaturan" class="module-content hidden">
                <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-6">Pengaturan Aplikasi</h3>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card">
                        <h4 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200">Informasi Desa</h4>
                        <form id="desaInfoForm" class="space-y-4">
                            <div>
                                <label for="namaDesa" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nama Desa</label>
                                <input type="text" id="namaDesa" class="form-input mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 text-gray-800 dark:text-gray-200">
                            </div>
                            <div>
                                <label for="alamatDesa" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Alamat Desa</label>
                                <input type="text" id="alamatDesa" class="form-input mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 text-gray-800 dark:text-gray-200">
                            </div>
                            <div>
                                <label for="teleponDesa" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Telepon Desa</label>
                                <input type="tel" id="teleponDesa" class="form-input mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 text-gray-800 dark:text-gray-200">
                            </div>
                            <div>
                                <label for="emailDesa" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email Desa</label>
                                <input type="email" id="emailDesa" class="form-input mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 text-gray-800 dark:text-gray-200">
                            </div>
                            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">Simpan Informasi Desa</button>
                        </form>
                    </div>

                    <div class="card">
                        <h4 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200">Manajemen Admin</h4>
                        <div class="mb-4">
                            <label for="adminEmail" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tambah Admin Baru (Email)</label>
                            <div class="flex space-x-2 mt-1">
                                <input
                                  type="email"
                                  id="adminEmail"
                                  placeholder="email@contoh.com"
                                  class="form-input flex-1 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 text-gray-800 dark:text-gray-200"
                                />
                                <!-- Tombol tambah admin ini sekarang akan memicu pendaftaran melalui Firebase Authentication -->
                                <button id="addAdminBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">Tambah</button>
                            </div>
                            <p id="addAdminError" class="text-red-500 text-sm mt-2 hidden"></p>
                        </div>
                        <h5 class="text-md font-semibold mb-2 text-gray-800 dark:text-gray-200">Daftar Admin</h5>
                        <ul id="adminList" class="space-y-2">
                            <!-- Daftar admin akan dimuat di sini -->
                            <li class="flex justify-between items-center bg-gray-50 dark:bg-gray-700 p-2 rounded-md">
                                <span class="text-gray-700 dark:text-gray-300">admin@desa.com (Anda)</span>
                                <span class="text-green-500 text-sm font-medium">Aktif</span>
                            </li>
                        </ul>
                    </div>

                    <div class="card lg:col-span-2">
                        <h4 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200">Pengaturan Lainnya</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="paginationLimit" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Batas Data per Halaman</label>
                                <input type="number" id="paginationLimit" min="5" max="50" value="10" class="form-input mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 text-gray-800 dark:text-gray-200">
                            </div>
                            <div>
                                <label for="auditLogRetention" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Retensi Log Audit (Hari)</label>
                                <input type="number" id="auditLogRetention" min="7" max="365" value="90" class="form-input mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 text-gray-800 dark:text-gray-200">
                            </div>
                        </div>
                        <button id="savePengaturanLainnyaBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 mt-4">Simpan Pengaturan Lainnya</button>
                    </div>
                </div>
            </section>
          </div>
        </main>
    </div> <!-- End of appContent -->

    <!-- Modals (Initially hidden) -->
    <!-- Modal Tambah/Edit Warga -->
    <div id="wargaModal" class="modal-backdrop hidden">
      <div class="modal-content w-full md:max-w-4xl max-h-[90vh]">
        <h3 id="wargaModalTitle" class="text-2xl font-bold mb-6 text-gray-900 dark:text-gray-100">Tambah Warga Baru</h3>
        <form id="wargaForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="hidden" id="wargaId">
          <div class="md:col-span-2">
            <label for="fotoWarga" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Foto Warga</label>
            <input type="file" id="fotoWarga" accept="image/*" class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
            <div id="fotoWargaPreviewContainer" class="mt-2 flex flex-wrap gap-2">
                <!-- Image preview will be loaded here -->
            </div>
          </div>
          <div>
            <label for="nikWarga" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">NIK</label>
            <input type="text" id="nikWarga" required class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
          </div>
          <div>
            <label for="namaLengkap" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nama Lengkap</label>
            <input type="text" id="namaLengkap" required class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
          </div>
          <div>
            <label for="tempatLahir" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tempat Lahir</label>
            <input type="text" id="tempatLahir" required class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
          </div>
          <div>
            <label for="tanggalLahir" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tanggal Lahir</label>
            <input type="date" id="tanggalLahir" required class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
          </div>
          <div>
            <label for="jenisKelamin" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Jenis Kelamin</label>
            <select id="jenisKelamin" required class="form-select w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
              <option value="">Pilih</option>
              <option value="Laki-laki">Laki-laki</option>
              <option value="Perempuan">Perempuan</option>
            </select>
          </div>
          <div>
            <label for="agama" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Agama</label>
            <select id="agama" required class="form-select w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
                <option value="">Pilih</option>
                <option value="Islam">Islam</option>
                <option value="Kristen Protestan">Kristen Protestan</option>
                <option value="Kristen Katolik">Kristen Katolik</option>
                <option value="Hindu">Hindu</option>
                <option value="Buddha">Buddha</option>
                <option value="Konghucu">Konghucu</option>
                <option value="Lainnya">Lainnya</option>
            </select>
          </div>
          <div>
            <label for="statusPerkawinan" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status Perkawinan</label>
            <select id="statusPerkawinan" required class="form-select w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
              <option value="">Pilih</option>
              <option value="Belum Kawin">Belum Kawin</option>
              <option value="Kawin">Kawin</option>
              <option value="Cerai Hidup">Cerai Hidup</option>
              <option value="Cerai Mati">Cerai Mati</option>
            </select>
          </div>
          <div>
            <label for="pekerjaan" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Pekerjaan</label>
            <input type="text" id="pekerjaan" class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
          </div>
          <div>
            <label for="pendidikanTerakhir" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Pendidikan Terakhir</label>
            <select id="pendidikanTerakhir" class="form-select w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
                <option value="">Pilih</option>
                <option value="Tidak/Belum Sekolah">Tidak/Belum Sekolah</option>
                <option value="SD/Sederajat">SD/Sederajat</option>
                <option value="SMP/Sederajat">SMP/Sederajat</option>
                <option value="SMA/Sederajat">SMA/Sederajat</option>
                <option value="Diploma">Diploma</option>
                <option value="Sarjana">Sarjana</option>
                <option value="Pascasarjana">Pascasarjana</option>
            </select>
          </div>
          <div>
            <label for="alamat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Alamat (Jalan, RT/RW, Dusun)</label>
            <textarea id="alamat" rows="2" class="form-textarea w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2"></textarea>
          </div>
          <div>
            <label for="statusWarga" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status Warga</label>
            <select id="statusWarga" required class="form-select w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
              <option value="Aktif">Aktif</option>
              <option value="Non-Aktif">Non-Aktif</option>
              <option value="Meninggal">Meninggal</option>
              <option value="Pindah">Pindah</option>
            </select>
          </div>
          <div class="md:col-span-2 flex justify-end space-x-3 mt-6">
            <button type="button" id="closeWargaModalBtn" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">Batal</button>
            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">Simpan Warga</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Detail Warga -->
    <div id="detailWargaModal" class="modal-backdrop hidden">
      <div class="modal-content w-full md:max-w-3xl">
        <h3 class="text-2xl font-bold mb-4 text-gray-900 dark:text-gray-100">Detail Data Warga</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Foto:</p>
            <div id="detailFotoWargaContainer" class="mt-1 mb-4">
                <img id="detailFotoWarga" src="https://via.placeholder.com/150" alt="Foto Warga" class="w-32 h-32 object-cover rounded-md shadow">
            </div>
            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Nama Lengkap:</p>
            <p id="detailNamaLengkap" class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2"></p>
            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">NIK:</p>
            <p id="detailNIK" class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2 ocr-font"></p>
            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Tempat, Tanggal Lahir:</p>
            <p id="detailTTL" class="text-gray-800 dark:text-gray-200 mb-2"></p>
            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Jenis Kelamin:</p>
            <p id="detailJenisKelamin" class="text-gray-800 dark:text-gray-200 mb-2"></p>
          </div>
          <div>
            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Agama:</p>
            <p id="detailAgama" class="text-gray-800 dark:text-gray-200 mb-2"></p>
            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Status Perkawinan:</p>
            <p id="detailStatusPerkawinan" class="text-gray-800 dark:text-gray-200 mb-2"></p>
            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Pekerjaan:</p>
            <p id="detailPekerjaan" class="text-gray-800 dark:text-gray-200 mb-2"></p>
            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Pendidikan Terakhir:</p>
            <p id="detailPendidikanTerakhir" class="text-gray-800 dark:text-gray-200 mb-2"></p>
            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Alamat:</p>
            <p id="detailAlamat" class="text-gray-800 dark:text-gray-200 mb-2"></p>
            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Status Warga:</p>
            <p id="detailStatusWarga" class="text-gray-800 dark:text-gray-200 mb-2"></p>
          </div>
        </div>
        <div class="flex justify-end mt-6">
          <button id="closeDetailWargaModalBtn" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">Tutup</button>
        </div>
      </div>
    </div>

    <!-- Modal Tambah/Edit Surat -->
    <div id="suratModal" class="modal-backdrop hidden">
      <div class="modal-content w-full md:max-w-xl max-h-[90vh]">
        <h3 id="suratModalTitle" class="text-2xl font-bold mb-6 text-gray-900 dark:text-gray-100">Buat Surat Baru</h3>
        <form id="suratForm" class="space-y-4">
          <input type="hidden" id="suratId">
          <div>
            <label for="noSurat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nomor Surat</label>
            <input type="text" id="noSurat" required class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
          </div>
          <div>
            <label for="jenisSurat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Jenis Surat</label>
            <select id="jenisSurat" required class="form-select w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
              <option value="">Pilih Jenis Surat</option>
              <option value="Keterangan Usaha">Keterangan Usaha</option>
              <option value="Keterangan Domisili">Keterangan Domisili</option>
              <option value="Keterangan Tidak Mampu">Keterangan Tidak Mampu</option>
              <option value="Pengantar KTP">Pengantar KTP</option>
              <option value="Kelahiran">Kelahiran</option>
              <option value="Kematian">Kematian</option>
            </select>
          </div>
          <div>
            <label for="namaPemohon" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nama Pemohon</label>
            <input type="text" id="namaPemohon" required class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
          </div>
          <div>
            <label for="tanggalPengajuan" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tanggal Pengajuan</label>
            <input type="date" id="tanggalPengajuan" required class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
          </div>
          <div>
            <label for="statusSurat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status Surat</label>
            <select id="statusSurat" required class="form-select w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
              <option value="Diajukan">Diajukan</option>
              <option value="Diproses">Diproses</option>
              <option value="Selesai">Selesai</option>
              <option value="Ditolak">Ditolak</option>
            </select>
          </div>
          <div>
            <label for="keteranganSurat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Keterangan Tambahan</label>
            <textarea id="keteranganSurat" rows="3" class="form-textarea w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2"></textarea>
          </div>
          <div>
            <label for="lampiranSurat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Lampiran (PDF)</label>
            <input type="file" id="lampiranSurat" accept=".pdf" class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
             <div id="lampiranSuratPreviewContainer" class="mt-2 flex flex-wrap gap-2">
                <!-- Attachment preview/links will be loaded here -->
            </div>
          </div>
          <div class="flex justify-end space-x-3 mt-6">
            <button type="button" id="closeSuratModalBtn" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">Batal</button>
            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">Simpan Surat</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Tambah/Edit Tanah -->
    <div id="tanahModal" class="modal-backdrop hidden">
      <div class="modal-content w-full md:max-w-xl max-h-[90vh]">
        <h3 id="tanahModalTitle" class="text-2xl font-bold mb-6 text-gray-900 dark:text-gray-100">Tambah Data Tanah</h3>
        <form id="tanahForm" class="space-y-4">
          <input type="hidden" id="tanahId">
          <div>
            <label for="noSertifikat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nomor Sertifikat</label>
            <input type="text" id="noSertifikat" required class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
          </div>
          <div>
            <label for="pemilikTanah" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nama Pemilik</label>
            <input type="text" id="pemilikTanah" required class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
          </div>
          <div>
            <label for="luasTanah" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Luas Tanah (m²)</label>
            <input type="number" id="luasTanah" required class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
          </div>
          <div>
            <label for="jenisSertifikat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Jenis Sertifikat</label>
            <select id="jenisSertifikat" required class="form-select w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
              <option value="">Pilih Jenis Sertifikat</option>
              <option value="SHM">Sertifikat Hak Milik (SHM)</option>
              <option value="SHGB">Sertifikat Hak Guna Bangunan (SHGB)</option>
              <option value="Akta Jual Beli">Akta Jual Beli (AJB)</option>
              <option value="Girik/Letter C">Girik/Letter C</option>
              <option value="Lainnya">Lainnya</option>
            </select>
          </div>
          <div>
            <label for="lokasiTanah" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Lokasi Tanah</label>
            <textarea id="lokasiTanah" rows="2" class="form-textarea w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2"></textarea>
          </div>
          <div>
            <label for="batasUtara" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Batas Utara</label>
            <input type="text" id="batasUtara" class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
          </div>
          <div>
            <label for="batasSelatan" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Batas Selatan</label>
            <input type="text" id="batasSelatan" class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
          </div>
          <div>
            <label for="batasTimur" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Batas Timur</label>
            <input type="text" id="batasTimur" class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
          </div>
          <div>
            <label for="batasBarat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Batas Barat</label>
            <input type="text" id="batasBarat" class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
          </div>
          <div class="flex justify-end space-x-3 mt-6 md:col-span-2">
            <button type="button" id="closeTanahModalBtn" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">Batal</button>
            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">Simpan Tanah</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Tambah/Edit Kegiatan -->
    <div id="kegiatanModal" class="modal-backdrop hidden">
      <div class="modal-content w-full md:max-w-xl max-h-[90vh]">
        <h3 id="kegiatanModalTitle" class="text-2xl font-bold mb-6 text-gray-900 dark:text-gray-100">Tambah Kegiatan Desa</h3>
        <form id="kegiatanForm" class="space-y-4">
          <input type="hidden" id="kegiatanId">
          <div>
            <label for="namaKegiatan" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nama Kegiatan</label>
            <input type="text" id="namaKegiatan" required class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
          </div>
          <div>
            <label for="deskripsiKegiatan" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Deskripsi Kegiatan</label>
            <textarea id="deskripsiKegiatan" rows="3" class="form-textarea w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2"></textarea>
          </div>
          <div>
            <label for="tanggalKegiatan" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tanggal Kegiatan</label>
            <input type="date" id="tanggalKegiatan" required class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
          </div>
          <div>
            <label for="lokasiKegiatan" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Lokasi Kegiatan</label>
            <input type="text" id="lokasiKegiatan" class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
          </div>
          <div>
            <label for="penanggungJawab" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Penanggung Jawab</label>
            <input type="text" id="penanggungJawab" class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
          </div>
          <div>
            <label for="statusKegiatan" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status Kegiatan</label>
            <select id="statusKegiatan" required class="form-select w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
              <option value="Akan Datang">Akan Datang</option>
              <option value="Sedang Berlangsung">Sedang Berlangsung</option>
              <option value="Selesai">Selesai</option>
              <option value="Dibatalkan">Dibatalkan</option>
            </select>
          </div>
          <div class="flex justify-end space-x-3 mt-6">
            <button type="button" id="closeKegiatanModalBtn" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">Batal</button>
            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">Simpan Kegiatan</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Tambah/Edit Keuangan (Pemasukan/Pengeluaran) -->
    <div id="keuanganModal" class="modal-backdrop hidden">
      <div class="modal-content w-full md:max-w-md max-h-[90vh]">
        <h3 id="keuanganModalTitle" class="text-2xl font-bold mb-6 text-gray-900 dark:text-gray-100">Tambah Transaksi Keuangan</h3>
        <form id="keuanganForm" class="space-y-4">
          <input type="hidden" id="keuanganId">
          <input type="hidden" id="keuanganJenis" value=""> <!-- Will be set to 'Pemasukan' or 'Pengeluaran' -->
          <div>
            <label for="tanggalTransaksi" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tanggal</label>
            <input type="date" id="tanggalTransaksi" required class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
          </div>
          <div>
            <label for="deskripsiTransaksi" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Deskripsi</label>
            <input type="text" id="deskripsiTransaksi" required class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
          </div>
          <div>
            <label for="jumlahTransaksi" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Jumlah (Rp)</label>
            <input type="number" id="jumlahTransaksi" required min="0" class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
          </div>
          <div class="flex justify-end space-x-3 mt-6">
            <button type="button" id="closeKeuanganModalBtn" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">Batal</button>
            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">Simpan Transaksi</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const appContent = document.getElementById("appContent");
        const loginForm = document.getElementById("loginForm");
        const adminLoginForm = document.getElementById("adminLoginForm");
        const loginError = document.getElementById("loginError");
        const logoutButton = document.getElementById("logoutButton");

        // Elemen baru untuk registrasi
        const registerModal = document.getElementById("registerModal");
        const adminRegisterForm = document.getElementById("adminRegisterForm");
        const registerError = document.getElementById("registerError");
        const showRegisterModalLink = document.getElementById("showRegisterModalLink");
        const showLoginModalLink = document.getElementById("showLoginModalLink");
        const addAdminError = document.getElementById("addAdminError"); // Untuk error di form add admin pada pengaturan

        // Objek App utama
        const App = {
          data: {
            warga: [],
            surat: [],
            suratTanah: [], // Sepertinya ini belum digunakan, tapi ada di struktur. Kita akan pakai 'tanah'
            tanah: [], // Mengganti suratTanah
            kegiatan: [],
            keuangan: [],
            pengaturan: {
              namaDesa: "Desa Digital",
              alamatDesa: "Jl. Desa Makmur No. 123",
              teleponDesa: "0812-3456-7890",
              emailDesa: "info@desadigital.go.id",
              admins: [{ email: "admin@desa.com" }], // Contoh admin awal
              paginationLimit: 10,
              auditLogRetention: 90,
            },
            auditLogs: [],
          },
          currentPage: {
            warga: 1,
            surat: 1,
            tanah: 1,
            kegiatan: 1,
            keuangan: 1,
          },
          currentModule: "dashboard",
          chartInstances: {}, // Untuk menyimpan instance Chart.js

          // --- Firebase Integration: Authentication ---
          async authenticate(email, password) {
            try {
              loginError.classList.add("hidden"); // Sembunyikan error sebelumnya
              const userCredential = await auth.signInWithEmailAndPassword(email, password);
              console.log("User logged in:", userCredential.user.email);
              App.showToast("fas fa-check-circle", "text-green-500", "Login berhasil!");
              // UI akan diperbarui oleh onAuthStateChanged
            } catch (error) {
              console.error("Login failed:", error.message);
              App.showToast("fas fa-times-circle", "text-red-500", `Login gagal: ${error.message}`);
              loginError.textContent = `Login gagal: ${error.message}`;
              loginError.classList.remove("hidden");
            }
          },

          async registerUser(email, password) {
            try {
                registerError.classList.add("hidden"); // Sembunyikan error sebelumnya
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                console.log("User registered:", userCredential.user.email);
                App.showToast("fas fa-check-circle", "text-green-500", "Pendaftaran berhasil! Silakan login.");
                registerModal.classList.add("hidden");
                loginForm.classList.remove("hidden"); // Tampilkan kembali form login
            } catch (error) {
                console.error("Registration failed:", error.message);
                let errorMessage = `Pendaftaran gagal: ${error.message}`;
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Email ini sudah terdaftar. Silakan coba login atau gunakan email lain.';
                    App.showToast("fas fa-info-circle", "text-blue-500", "Email sudah terdaftar!");
                } else {
                    App.showToast("fas fa-times-circle", "text-red-500", `Pendaftaran gagal: ${error.message}`);
                }
                registerError.textContent = errorMessage;
                registerError.classList.remove("hidden");
            }
          },

          async logout() {
            try {
              await auth.signOut();
              console.log("User logged out");
              App.showToast("fas fa-sign-out-alt", "text-blue-500", "Anda telah keluar.");
              // UI akan diperbarui oleh onAuthStateChanged
            } catch (error) {
              console.error("Logout failed:", error.message);
              App.showToast("fas fa-times-circle", "text-red-500", `Gagal logout: ${error.message}`);
            }
          },

          // --- Migrasi ke Firebase: Load Data (Contoh untuk `pengaturan`) ---
          // Ini adalah langkah awal untuk mengganti localStorage
          async loadDataFromFirestore(collectionName) {
            try {
              // Jika ini adalah 'pengaturan', kita akan mencoba mengambil dokumen tunggal
              if (collectionName === "pengaturan") {
                  const docRef = db.collection(collectionName).doc("desaSettings"); // Asumsi ada satu dokumen 'desaSettings'
                  const doc = await docRef.get();
                  if (doc.exists) {
                      App.data.pengaturan = doc.data();
                      console.log(`Pengaturan loaded from Firestore:`, App.data.pengaturan);
                  } else {
                      console.log("No 'desaSettings' document found in 'pengaturan' collection. Using default settings.");
                      // Jika tidak ada, simpan pengaturan default ke Firestore untuk pertama kali
                      await App.saveDataToFirestore("pengaturan", "desaSettings", App.data.pengaturan);
                  }
              } else {
                  // Untuk koleksi lain (warga, surat, dll.), kita akan mengambil semua dokumen
                  // Ini akan diubah nanti untuk pagination dan real-time listener
                  const snapshot = await db.collection(collectionName).get();
                  App.data[collectionName] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                  console.log(`${collectionName} loaded from Firestore:`, App.data[collectionName]);
              }
            } catch (error) {
              console.error(`Error loading ${collectionName} from Firestore:`, error);
              App.showToast("fas fa-times-circle", "text-red-500", `Gagal memuat data ${collectionName}.`);
            }
          },

          // --- Migrasi ke Firebase: Save Data (Contoh untuk `pengaturan`) ---
          async saveDataToFirestore(collectionName, docId, data) {
            try {
              await db.collection(collectionName).doc(docId).set(data, { merge: true });
              console.log(`${collectionName} data saved to Firestore with ID: ${docId}`);
            } catch (error) {
              console.error(`Error saving ${collectionName} to Firestore:`, error);
              App.showToast("fas fa-times-circle", "text-red-500", `Gagal menyimpan data ${collectionName}.`);
            }
          },

          // --- Perubahan init() untuk Firebase Auth ---
          init() {
            // Dark mode toggle
            const darkModeToggle = document.getElementById("darkModeToggle");
            const prefersDarkScheme = window.matchMedia("(prefers-color-scheme: dark)");

            const currentTheme = localStorage.getItem("theme");
            if (currentTheme === "dark") {
              document.documentElement.classList.add("dark");
              darkModeToggle.checked = true;
            } else if (currentTheme === "light") {
              document.documentElement.classList.remove("dark");
              darkModeToggle.checked = false;
            } else if (prefersDarkScheme.matches) {
              document.documentElement.classList.add("dark");
              darkModeToggle.checked = true;
            }

            darkModeToggle.addEventListener("change", () => {
              if (darkModeToggle.checked) {
                document.documentElement.classList.add("dark");
                localStorage.setItem("theme", "dark");
              } else {
                document.documentElement.classList.remove("dark");
                localStorage.setItem("theme", "light");
              }
            });

            // Navigasi Sidebar
            document.querySelectorAll(".sidebar-link").forEach((link) => {
              link.addEventListener("click", (e) => {
                e.preventDefault();
                document.querySelectorAll(".sidebar-link").forEach((item) => item.classList.remove("active"));
                e.currentTarget.classList.add("active");

                const targetModule = e.currentTarget.getAttribute("href").substring(1);
                App.switchModule(targetModule);
              });
            });

            // Handle Login Form Submission
            adminLoginForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                const email = document.getElementById("loginEmail").value;
                const password = document.getElementById("loginPassword").value;
                await App.authenticate(email, password);
            });

            // Handle Register Form Submission
            adminRegisterForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                const email = document.getElementById("registerEmail").value;
                const password = document.getElementById("registerPassword").value;
                const confirmPassword = document.getElementById("registerConfirmPassword").value;

                if (password.length < 6) {
                    registerError.textContent = "Kata sandi minimal harus 6 karakter.";
                    registerError.classList.remove("hidden");
                    App.showToast('fas fa-exclamation-circle', 'text-yellow-500', 'Kata sandi terlalu pendek!');
                    return;
                }
                if (password !== confirmPassword) {
                    registerError.textContent = "Konfirmasi kata sandi tidak cocok.";
                    registerError.classList.remove("hidden");
                    App.showToast('fas fa-exclamation-circle', 'text-yellow-500', 'Kata sandi tidak cocok!');
                    return;
                }
                await App.registerUser(email, password);
            });

            // Toggle between Login and Register forms
            showRegisterModalLink.addEventListener('click', (e) => {
                e.preventDefault();
                loginForm.classList.add('hidden');
                registerModal.classList.remove('hidden');
                registerError.classList.add('hidden'); // Clear previous errors
                adminRegisterForm.reset();
            });

            showLoginModalLink.addEventListener('click', (e) => {
                e.preventDefault();
                registerModal.classList.add('hidden');
                loginForm.classList.remove('hidden');
                loginError.classList.add('hidden'); // Clear previous errors
                adminLoginForm.reset();
            });


            // Handle Logout Button
            logoutButton.addEventListener("click", async () => {
                await App.logout();
            });


            // Listener untuk Auth State Changes
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // User is signed in.
                    console.log("User is signed in:", user.email);
                    loginForm.classList.add("hidden");
                    registerModal.classList.add("hidden"); // Pastikan modal register juga tersembunyi
                    appContent.classList.remove("hidden");
                    // Load pengaturan dan data lain setelah login
                    await App.loadDataFromFirestore('pengaturan'); // Load settings for logged-in user
                    // Lanjutkan dengan memuat data lainnya dari Firestore
                    // await App.loadDataFromFirestore('warga'); // Ini akan diimplementasikan nanti
                    // await App.loadDataFromFirestore('surat'); // Ini akan diimplementasikan nanti
                    // App.renderDashboard(); // Render dashboard setelah data dimuat
                    // App.renderWargaTable(); // Render tabel warga jika sudah siap
                    App.showToast('fas fa-user-check', 'text-blue-500', `Selamat datang, ${user.email.split('@')[0]}!`);
                } else {
                    // User is signed out.
                    console.log("User is signed out.");
                    loginForm.classList.remove("hidden");
                    appContent.classList.add("hidden");
                    loginError.classList.add("hidden"); // Sembunyikan error jika ada
                    // Clear any sensitive data or UI related to logged-in user
                    // Redirect to login or show login form
                }
            });


            // Initial module load based on hash or default to dashboard
            const initialModule = window.location.hash ? window.location.hash.substring(1) : "dashboard";
            App.switchModule(initialModule);

            // Hide all modals when clicking outside or on close buttons
            document.querySelectorAll(".modal-backdrop").forEach(modal => {
                modal.addEventListener("click", (e) => {
                    // Hanya sembunyikan jika klik langsung pada backdrop atau tombol dengan ID 'close' di dalamnya
                    if (e.target === modal || e.target.closest("button[id^='close']")) {
                        modal.classList.add("hidden");
                    }
                });
            });

            // Warga Module Event Listeners (Tetap sama, tapi nanti akan diubah untuk Firestore)
            document.getElementById("tambahWargaBtn").addEventListener("click", () => App.showWargaModal());
            document.getElementById("wargaForm").addEventListener("submit", (e) => {
              e.preventDefault();
              App.saveWarga();
            });
            document.getElementById("filterStatus").addEventListener("change", () => App.renderWargaTable());
            document.getElementById("filterGender").addEventListener("change", () => App.renderWargaTable());
            document.getElementById("searchWarga").addEventListener("input", () => App.renderWargaTable());
            document.getElementById("selectAllWarga").addEventListener("change", App.toggleSelectAllWarga);
            document.getElementById("hapusWargaTerpilihBtn").addEventListener("click", App.deleteSelectedWarga);
            document.getElementById("exportWargaBtn").addEventListener("click", () => App.exportToExcel('warga', 'Data Warga Desa'));
            document.getElementById("importWargaInput").addEventListener("change", (e) => App.importFromExcel(e, 'warga'));
            document.getElementById("prevWargaPage").addEventListener("click", () => App.changeWargaPage(-1));
            document.getElementById("nextWargaPage").addEventListener("click", () => App.changeWargaPage(1));


            // Surat Module Event Listeners
            document.getElementById("tambahSuratBtn").addEventListener("click", () => App.showSuratModal());
            document.getElementById("suratForm").addEventListener("submit", (e) => {
              e.preventDefault();
              App.saveSurat();
            });
            document.getElementById("filterJenisSurat").addEventListener("change", () => App.renderSuratTable());
            document.getElementById("filterStatusSurat").addEventListener("change", () => App.renderSuratTable());
            document.getElementById("searchSurat").addEventListener("input", () => App.renderSuratTable());
            document.getElementById("prevSuratPage").addEventListener("click", () => App.changeSuratPage(-1));
            document.getElementById("nextSuratPage").addEventListener("click", () => App.changeSuratPage(1));

            // Tanah Module Event Listeners
            document.getElementById("tambahTanahBtn").addEventListener("click", () => App.showTanahModal());
            document.getElementById("tanahForm").addEventListener("submit", (e) => {
              e.preventDefault();
              App.saveTanah();
            });
            document.getElementById("filterJenisSertifikat").addEventListener("change", () => App.renderTanahTable());
            document.getElementById("searchTanah").addEventListener("input", () => App.renderTanahTable());
            document.getElementById("prevTanahPage").addEventListener("click", () => App.changeTanahPage(-1));
            document.getElementById("nextTanahPage").addEventListener("click", () => App.changeTanahPage(1));

            // Kegiatan Module Event Listeners
            document.getElementById("tambahKegiatanBtn").addEventListener("click", () => App.showKegiatanModal());
            document.getElementById("kegiatanForm").addEventListener("submit", (e) => {
              e.preventDefault();
              App.saveKegiatan();
            });
            document.getElementById("filterStatusKegiatan").addEventListener("change", () => App.renderKegiatanTable());
            document.getElementById("searchKegiatan").addEventListener("input", () => App.renderKegiatanTable());
            document.getElementById("prevKegiatanPage").addEventListener("click", () => App.changeKegiatanPage(-1));
            document.getElementById("nextKegiatanPage").addEventListener("click", () => App.changeKegiatanPage(1));

            // Keuangan Module Event Listeners
            document.getElementById("tambahPemasukanBtn").addEventListener("click", () => App.showKeuanganModal('Pemasukan'));
            document.getElementById("tambahPengeluaranBtn").addEventListener("click", () => App.showKeuanganModal('Pengeluaran'));
            document.getElementById("keuanganForm").addEventListener("submit", (e) => {
              e.preventDefault();
              App.saveKeuangan();
            });
            document.getElementById("filterJenisTransaksi").addEventListener("change", () => App.renderKeuanganTable());
            document.getElementById("filterBulanTahun").addEventListener("change", () => App.renderKeuanganTable());
            document.getElementById("searchKeuangan").addEventListener("input", () => App.renderKeuanganTable());
            document.getElementById("prevKeuanganPage").addEventListener("click", () => App.changeKeuanganPage(-1));
            document.getElementById("nextKeuanganPage").addEventListener("click", () => App.changeKeuanganPage(1));

            // Pengaturan Module Event Listeners
            document.getElementById("desaInfoForm").addEventListener("submit", (e) => {
                e.preventDefault();
                App.savePengaturanDesa();
            });
            // Mengubah event listener untuk addAdminBtn agar memicu pendaftaran
            document.getElementById("addAdminBtn").addEventListener("click", async () => {
                const adminEmailInput = document.getElementById("adminEmail");
                const email = adminEmailInput.value.trim();
                const tempPassword = 'password123'; // Password sementara atau bisa minta input modal lain

                if (!email || !email.includes('@')) {
                    addAdminError.textContent = "Mohon masukkan email yang valid.";
                    addAdminError.classList.remove("hidden");
                    App.showToast('fas fa-exclamation-circle', 'text-yellow-500', 'Email tidak valid.');
                    return;
                }

                if (App.data.pengaturan.admins.some(admin => admin.email === email)) {
                    addAdminError.textContent = "Email ini sudah terdaftar sebagai admin.";
                    addAdminError.classList.remove("hidden");
                    App.showToast('fas fa-info-circle', 'text-blue-500', 'Email sudah terdaftar!');
                    return;
                }

                try {
                    addAdminError.classList.add("hidden");
                    // Buat user di Firebase Authentication. Password sementara disarankan hanya untuk tujuan ini.
                    // Untuk produksi, sebaiknya ada alur undangan atau admin baru mengatur password sendiri.
                    await auth.createUserWithEmailAndPassword(email, tempPassword);

                    // Jika berhasil, tambahkan ke daftar admin lokal dan Firestore
                    App.data.pengaturan.admins.push({ email: email });
                    await App.saveDataToFirestore('pengaturan', 'desaSettings', App.data.pengaturan);
                    App.addAuditLog(`Menambah admin baru: ${email}`);
                    App.showToast('fas fa-check-circle', 'text-green-500', `Admin ${email} berhasil ditambahkan ke Firebase!`);
                    adminEmailInput.value = '';
                    App.renderAdminList();
                } catch (error) {
                    console.error("Error adding new admin:", error.message);
                    let errorMessage = `Gagal menambah admin: ${error.message}`;
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Email ini sudah terdaftar sebagai pengguna. Tambahkan ke daftar admin jika Anda ingin mengelola izin tanpa mendaftar ulang.';
                        App.showToast('fas fa-info-circle', 'text-blue-500', 'Email sudah terdaftar sebagai pengguna!');
                    } else {
                        App.showToast('fas fa-times-circle', 'text-red-500', `Gagal menambah admin: ${error.message}`);
                    }
                    addAdminError.textContent = errorMessage;
                    addAdminError.classList.remove("hidden");
                }
            });

            document.getElementById("savePengaturanLainnyaBtn").addEventListener("click", App.saveOtherSettings);
          },

          // Utility Functions
          switchModule(module) {
            App.currentModule = module;
            document.querySelectorAll(".module-content").forEach((content) => {
              content.classList.add("hidden");
            });
            document.getElementById(module).classList.remove("hidden");
            document.getElementById("currentModuleTitle").textContent = module.charAt(0).toUpperCase() + module.slice(1);

            // Re-render data for the active module
            if (module === "dashboard") {
              // App.renderDashboard(); // Akan memuat data dari Firestore nanti
            } else if (module === "warga") {
              // App.renderWargaTable(); // Akan memuat data dari Firestore nanti
            } else if (module === "surat") {
              // App.renderSuratTable();
            } else if (module === "tanah") {
              // App.renderTanahTable();
            } else if (module === "kegiatan") {
              // App.renderKegiatanTable();
            } else if (module === "keuangan") {
              // App.renderKeuanganTable();
            } else if (module === "pengaturan") {
              App.renderPengaturan(); // Akan memuat dari Firestore nanti
            }
          },

          generateUniqueId() {
            return '_' + Math.random().toString(36).substr(2, 9);
          },

          formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
          },

          formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
          },

          // --- CRUD Operations (Still using localStorage placeholders - WILL BE REPLACED WITH FIRESTORE) ---
          // Warga
          showWargaModal(wargaId = null) {
            const modal = document.getElementById("wargaModal");
            const title = document.getElementById("wargaModalTitle");
            const form = document.getElementById("wargaForm");
            form.reset();
            document.getElementById("fotoWargaPreviewContainer").innerHTML = ''; // Clear preview

            if (wargaId) {
              title.textContent = "Edit Data Warga";
              const warga = App.data.warga.find((w) => w.id === wargaId);
              if (warga) {
                document.getElementById("wargaId").value = warga.id;
                document.getElementById("nikWarga").value = warga.nik;
                document.getElementById("namaLengkap").value = warga.namaLengkap;
                document.getElementById("tempatLahir").value = warga.tempatLahir;
                document.getElementById("tanggalLahir").value = warga.tanggalLahir;
                document.getElementById("jenisKelamin").value = warga.jenisKelamin;
                document.getElementById("agama").value = warga.agama;
                document.getElementById("statusPerkawinan").value = warga.statusPerkawinan;
                document.getElementById("pekerjaan").value = warga.pekerjaan;
                document.getElementById("pendidikanTerakhir").value = warga.pendidikanTerakhir;
                document.getElementById("alamat").value = warga.alamat;
                document.getElementById("statusWarga").value = warga.statusWarga;
                if (warga.foto) {
                    const img = document.createElement('img');
                    img.src = warga.foto;
                    img.className = 'w-24 h-24 object-cover rounded-md shadow';
                    document.getElementById("fotoWargaPreviewContainer").appendChild(img);
                }
              }
            } else {
              title.textContent = "Tambah Warga Baru";
              document.getElementById("wargaId").value = "";
            }
            modal.classList.remove("hidden");
          },

          async saveWarga() {
            const id = document.getElementById("wargaId").value;
            const nik = document.getElementById("nikWarga").value;
            const namaLengkap = document.getElementById("namaLengkap").value;
            const tempatLahir = document.getElementById("tempatLahir").value;
            const tanggalLahir = document.getElementById("tanggalLahir").value;
            const jenisKelamin = document.getElementById("jenisKelamin").value;
            const agama = document.getElementById("agama").value;
            const statusPerkawinan = document.getElementById("statusPerkawinan").value;
            const pekerjaan = document.getElementById("pekerjaan").value;
            const pendidikanTerakhir = document.getElementById("pendidikanTerakhir").value;
            const alamat = document.getElementById("alamat").value;
            const statusWarga = document.getElementById("statusWarga").value;
            const fotoFile = document.getElementById("fotoWarga").files[0];
            let fotoUrl = '';

            // TODO: Upload foto ke Firebase Storage di sini
            if (fotoFile) {
                // Ini akan jadi logika Cloud Storage, untuk saat ini placeholder
                App.showToast('fas fa-info-circle', 'text-blue-500', 'Upload foto ke Cloud Storage akan diimplementasikan.');
                // Contoh placeholder URL
                fotoUrl = URL.createObjectURL(fotoFile);
            } else if (id) {
                // Jika edit dan tidak ada file baru, pertahankan foto lama
                const existingWarga = App.data.warga.find(w => w.id === id);
                if (existingWarga) fotoUrl = existingWarga.foto || '';
            }

            const newWarga = {
              id: id || App.generateUniqueId(),
              nik, namaLengkap, tempatLahir, tanggalLahir, jenisKelamin,
              agama, statusPerkawinan, pekerjaan, pendidikanTerakhir,
              alamat, statusWarga, foto: fotoUrl,
              createdAt: id ? App.data.warga.find(w => w.id === id).createdAt : new Date().toISOString(),
              updatedAt: new Date().toISOString()
            };

            if (id) {
              const index = App.data.warga.findIndex((w) => w.id === id);
              if (index !== -1) {
                App.data.warga[index] = newWarga;
                App.addAuditLog(`Mengedit data warga ${namaLengkap} (NIK: ${nik})`);
                App.showToast('fas fa-check-circle', 'text-green-500', 'Data warga berhasil diperbarui!');
              }
            } else {
              App.data.warga.push(newWarga);
              App.addAuditLog(`Menambah warga baru ${namaLengkap} (NIK: ${nik})`);
              App.showToast('fas fa-check-circle', 'text-green-500', 'Warga baru berhasil ditambahkan!');
            }
            // TODO: Save to Firestore here
            // App.saveDataToFirestore('warga', newWarga.id, newWarga);

            document.getElementById("wargaModal").classList.add("hidden");
            App.renderWargaTable();
            // App.saveData(); // Not needed after Firestore migration
            App.renderDashboard();
          },

          renderWargaTable() {
            // Ini akan membutuhkan perubahan signifikan untuk membaca dari Firestore dengan filter dan pagination
            const tableBody = document.getElementById("wargaTableBody");
            tableBody.innerHTML = "";

            let filteredWarga = App.data.warga;

            const filterStatus = document.getElementById("filterStatus").value;
            if (filterStatus) {
                filteredWarga = filteredWarga.filter(w => w.statusWarga === filterStatus);
            }

            const filterGender = document.getElementById("filterGender").value;
            if (filterGender) {
                filteredWarga = filteredWarga.filter(w => w.jenisKelamin === filterGender);
            }

            const searchWarga = document.getElementById("searchWarga").value.toLowerCase();
            if (searchWarga) {
                filteredWarga = filteredWarga.filter(w =>
                    w.namaLengkap.toLowerCase().includes(searchWarga) ||
                    w.nik.includes(searchWarga)
                );
            }

            // Pagination logic (akan diadaptasi untuk query Firestore)
            const limit = App.data.pengaturan.paginationLimit;
            const startIndex = (App.currentPage.warga - 1) * limit;
            const paginatedWarga = filteredWarga.slice(startIndex, startIndex + limit);

            if (paginatedWarga.length === 0) {
              tableBody.innerHTML = `<tr><td colspan="6" class="py-4 px-4 text-center text-gray-500 dark:text-gray-400">Tidak ada data warga yang ditemukan.</td></tr>`;
              document.getElementById("prevWargaPage").disabled = true;
              document.getElementById("nextWargaPage").disabled = true;
            } else {
              paginatedWarga.forEach((warga) => {
                const row = tableBody.insertRow();
                row.className = "hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150";
                row.innerHTML = `
                  <td class="py-3 px-4 whitespace-nowrap"><input type="checkbox" class="warga-checkbox" data-id="${warga.id}"></td>
                  <td class="py-3 px-4 whitespace-nowrap">
                    <img src="${warga.foto || 'https://via.placeholder.com/50'}" alt="Foto" class="w-10 h-10 rounded-full object-cover">
                  </td>
                  <td class="py-3 px-4 font-medium text-gray-900 dark:text-gray-100">${warga.namaLengkap}</td>
                  <td class="py-3 px-4 text-gray-700 dark:text-gray-300 ocr-font">${warga.nik}</td>
                  <td class="py-3 px-4">${App.getStatusBadge(warga.statusWarga)}</td>
                  <td class="py-3 px-4 whitespace-nowrap">
                    <button onclick="App.showDetailWargaModal('${warga.id}')" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 mr-2"><i class="fas fa-eye"></i></button>
                    <button onclick="App.showWargaModal('${warga.id}')" class="text-yellow-600 hover:text-yellow-800 dark:text-yellow-400 dark:hover:text-yellow-300 mr-2"><i class="fas fa-edit"></i></button>
                    <button onclick="App.deleteWarga('${warga.id}', '${warga.namaLengkap}')" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300"><i class="fas fa-trash-alt"></i></button>
                  </td>
                `;
              });
              document.getElementById("prevWargaPage").disabled = App.currentPage.warga === 1;
              document.getElementById("nextWargaPage").disabled = (startIndex + limit) >= filteredWarga.length;
              document.getElementById("currentPageWarga").textContent = `Halaman ${App.currentPage.warga}`;
            }
          },

          showDetailWargaModal(wargaId) {
            const modal = document.getElementById("detailWargaModal");
            const warga = App.data.warga.find(w => w.id === wargaId);
            if (warga) {
                document.getElementById("detailFotoWarga").src = warga.foto || 'https://via.placeholder.com/150';
                document.getElementById("detailNamaLengkap").textContent = warga.namaLengkap;
                document.getElementById("detailNIK").textContent = warga.nik;
                document.getElementById("detailTTL").textContent = `${warga.tempatLahir}, ${App.formatDate(warga.tanggalLahir)}`;
                document.getElementById("detailJenisKelamin").textContent = warga.jenisKelamin;
                document.getElementById("detailAgama").textContent = warga.agama;
                document.getElementById("detailStatusPerkawinan").textContent = warga.statusPerkawinan;
                document.getElementById("detailPekerjaan").textContent = warga.pekerjaan;
                document.getElementById("detailPendidikanTerakhir").textContent = warga.pendidikanTerakhir;
                document.getElementById("detailAlamat").textContent = warga.alamat;
                document.getElementById("detailStatusWarga").innerHTML = App.getStatusBadge(warga.statusWarga);
            }
            modal.classList.remove("hidden");
          },

          deleteWarga(id, nama) {
            // Menggunakan modal kustom untuk konfirmasi, bukan `confirm()`
            App.showConfirmModal(`Anda yakin ingin menghapus data warga ${nama}?`, async () => {
                // TODO: Delete from Firestore
                App.data.warga = App.data.warga.filter((w) => w.id !== id);
                App.addAuditLog(`Menghapus data warga ${nama} (ID: ${id})`);
                App.showToast('fas fa-check-circle', 'text-green-500', 'Data warga berhasil dihapus!');
                App.renderWargaTable();
                App.renderDashboard();
            });
          },

          toggleSelectAllWarga(event) {
            document.querySelectorAll(".warga-checkbox").forEach(checkbox => {
              checkbox.checked = event.target.checked;
            });
          },

          deleteSelectedWarga() {
            const selectedIds = Array.from(document.querySelectorAll(".warga-checkbox:checked"))
              .map(checkbox => checkbox.dataset.id);

            if (selectedIds.length === 0) {
              App.showToast('fas fa-info-circle', 'text-blue-500', 'Tidak ada warga yang dipilih untuk dihapus.');
              return;
            }

            // Menggunakan modal kustom untuk konfirmasi
            App.showConfirmModal(`Anda yakin ingin menghapus ${selectedIds.length} data warga yang terpilih?`, async () => {
                // TODO: Delete multiple from Firestore
                App.data.warga = App.data.warga.filter(w => !selectedIds.includes(w.id));
                App.addAuditLog(`Menghapus ${selectedIds.length} data warga terpilih`);
                App.showToast('fas fa-check-circle', 'text-green-500', `${selectedIds.length} data warga berhasil dihapus!`);
                document.getElementById("selectAllWarga").checked = false;
                App.renderWargaTable();
                App.renderDashboard();
            });
          },

          changeWargaPage(direction) {
            App.currentPage.warga += direction;
            App.renderWargaTable();
          },

          // Surat
          showSuratModal(suratId = null) {
            const modal = document.getElementById("suratModal");
            const title = document.getElementById("suratModalTitle");
            const form = document.getElementById("suratForm");
            form.reset();
            document.getElementById("lampiranSuratPreviewContainer").innerHTML = ''; // Clear preview

            if (suratId) {
              title.textContent = "Edit Data Surat";
              const surat = App.data.surat.find((s) => s.id === suratId);
              if (surat) {
                document.getElementById("suratId").value = surat.id;
                document.getElementById("noSurat").value = surat.noSurat;
                document.getElementById("jenisSurat").value = surat.jenisSurat;
                document.getElementById("namaPemohon").value = surat.namaPemohon;
                document.getElementById("tanggalPengajuan").value = surat.tanggalPengajuan;
                document.getElementById("statusSurat").value = surat.statusSurat;
                document.getElementById("keteranganSurat").value = surat.keteranganSurat;
                if (surat.lampiranUrl) {
                    const link = document.createElement('a');
                    link.href = surat.lampiranUrl;
                    link.textContent = 'Lihat Lampiran';
                    link.target = '_blank';
                    link.className = 'text-blue-500 hover:underline mr-2';
                    document.getElementById("lampiranSuratPreviewContainer").appendChild(link);
                }
              }
            } else {
              title.textContent = "Buat Surat Baru";
              document.getElementById("suratId").value = "";
              document.getElementById("noSurat").value = App.generateNomorSurat(); // Auto-generate nomor surat
              document.getElementById("tanggalPengajuan").valueAsDate = new Date(); // Set today's date
            }
            modal.classList.remove("hidden");
          },

          async saveSurat() {
            const id = document.getElementById("suratId").value;
            const noSurat = document.getElementById("noSurat").value;
            const jenisSurat = document.getElementById("jenisSurat").value;
            const namaPemohon = document.getElementById("namaPemohon").value;
            const tanggalPengajuan = document.getElementById("tanggalPengajuan").value;
            const statusSurat = document.getElementById("statusSurat").value;
            const keteranganSurat = document.getElementById("keteranganSurat").value;
            const lampiranFile = document.getElementById("lampiranSurat").files[0];
            let lampiranUrl = '';

            // TODO: Upload lampiran ke Firebase Storage di sini
            if (lampiranFile) {
                App.showToast('fas fa-info-circle', 'text-blue-500', 'Upload lampiran ke Cloud Storage akan diimplementasikan.');
                // Contoh placeholder URL
                lampiranUrl = URL.createObjectURL(lampiranFile);
            } else if (id) {
                const existingSurat = App.data.surat.find(s => s.id === id);
                if (existingSurat) lampiranUrl = existingSurat.lampiranUrl || '';
            }

            const newSurat = {
              id: id || App.generateUniqueId(),
              noSurat, jenisSurat, namaPemohon, tanggalPengajuan, statusSurat,
              keteranganSurat, lampiranUrl,
              createdAt: id ? App.data.surat.find(s => s.id === id).createdAt : new Date().toISOString(),
              updatedAt: new Date().toISOString()
            };

            if (id) {
              const index = App.data.surat.findIndex((s) => s.id === id);
              if (index !== -1) {
                App.data.surat[index] = newSurat;
                App.addAuditLog(`Mengedit surat ${noSurat} (${jenisSurat})`);
                App.showToast('fas fa-check-circle', 'text-green-500', 'Data surat berhasil diperbarui!');
              }
            } else {
              App.data.surat.push(newSurat);
              App.addAuditLog(`Menambah surat baru ${noSurat} (${jenisSurat})`);
              App.showToast('fas fa-check-circle', 'text-green-500', 'Surat baru berhasil ditambahkan!');
            }
            // TODO: Save to Firestore here
            // App.saveDataToFirestore('surat', newSurat.id, newSurat);

            document.getElementById("suratModal").classList.add("hidden");
            App.renderSuratTable();
            // App.saveData(); // Not needed after Firestore
            App.renderDashboard();
          },

          deleteSurat(id, noSurat) {
            // Menggunakan modal kustom untuk konfirmasi
            App.showConfirmModal(`Anda yakin ingin menghapus surat ${noSurat}?`, async () => {
                // TODO: Delete from Firestore
                App.data.surat = App.data.surat.filter((s) => s.id !== id);
                App.addAuditLog(`Menghapus surat ${noSurat} (ID: ${id})`);
                App.showToast('fas fa-check-circle', 'text-green-500', 'Data surat berhasil dihapus!');
                App.renderSuratTable();
                App.renderDashboard();
            });
          },

          renderSuratTable() {
            // Ini akan membutuhkan perubahan signifikan untuk membaca dari Firestore
            const tableBody = document.getElementById("suratTableBody");
            tableBody.innerHTML = "";

            let filteredSurat = App.data.surat;

            const filterJenisSurat = document.getElementById("filterJenisSurat").value;
            if (filterJenisSurat) {
                filteredSurat = filteredSurat.filter(s => s.jenisSurat === filterJenisSurat);
            }

            const filterStatusSurat = document.getElementById("filterStatusSurat").value;
            if (filterStatusSurat) {
                filteredSurat = filteredSurat.filter(s => s.statusSurat === filterStatusSurat);
            }

            const searchSurat = document.getElementById("searchSurat").value.toLowerCase();
            if (searchSurat) {
                filteredSurat = filteredSurat.filter(s =>
                    s.noSurat.toLowerCase().includes(searchSurat) ||
                    s.namaPemohon.toLowerCase().includes(searchSurat)
                );
            }

            // Pagination logic
            const limit = App.data.pengaturan.paginationLimit;
            const startIndex = (App.currentPage.surat - 1) * limit;
            const paginatedSurat = filteredSurat.slice(startIndex, startIndex + limit);

            if (paginatedSurat.length === 0) {
              tableBody.innerHTML = `<tr><td colspan="6" class="py-4 px-4 text-center text-gray-500 dark:text-gray-400">Tidak ada data surat yang ditemukan.</td></tr>`;
              document.getElementById("prevSuratPage").disabled = true;
              document.getElementById("nextSuratPage").disabled = true;
            } else {
              paginatedSurat.forEach((surat) => {
                const row = tableBody.insertRow();
                row.className = "hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150";
                row.innerHTML = `
                  <td class="py-3 px-4 font-medium text-gray-900 dark:text-gray-100">${surat.noSurat}</td>
                  <td class="py-3 px-4 text-gray-700 dark:text-gray-300">${surat.jenisSurat}</td>
                  <td class="py-3 px-4 text-gray-700 dark:text-gray-300">${surat.namaPemohon}</td>
                  <td class="py-3 px-4 text-gray-700 dark:text-gray-300">${App.formatDate(surat.tanggalPengajuan)}</td>
                  <td class="py-3 px-4">${App.getStatusBadge(surat.statusSurat)}</td>
                  <td class="py-3 px-4 whitespace-nowrap">
                    <button onclick="App.showSuratModal('${surat.id}')" class="text-yellow-600 hover:text-yellow-800 dark:text-yellow-400 dark:hover:text-yellow-300 mr-2"><i class="fas fa-edit"></i></button>
                    <button onclick="App.deleteSurat('${surat.id}', '${surat.noSurat}')" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300"><i class="fas fa-trash-alt"></i></button>
                    ${surat.lampiranUrl ? `<a href="${surat.lampiranUrl}" target="_blank" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 ml-2"><i class="fas fa-file-pdf"></i></a>` : ''}
                  </td>
                `;
              });
              document.getElementById("prevSuratPage").disabled = App.currentPage.surat === 1;
              document.getElementById("nextSuratPage").disabled = (startIndex + limit) >= filteredSurat.length;
              document.getElementById("currentPageSurat").textContent = `Halaman ${App.currentPage.surat}`;
            }
          },

          changeSuratPage(direction) {
            App.currentPage.surat += direction;
            App.renderSuratTable();
          },

          generateNomorSurat() {
            const date = new Date();
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const counter = App.data.surat.length + 1; // Simple counter, will need better logic with Firestore
            return `SK/DD-${year}${month}${day}-${counter.toString().padStart(3, '0')}`;
          },

          // Tanah
          showTanahModal(tanahId = null) {
            const modal = document.getElementById("tanahModal");
            const title = document.getElementById("tanahModalTitle");
            const form = document.getElementById("tanahForm");
            form.reset();

            if (tanahId) {
              title.textContent = "Edit Data Tanah";
              const tanah = App.data.tanah.find((t) => t.id === tanahId);
              if (tanah) {
                document.getElementById("tanahId").value = tanah.id;
                document.getElementById("noSertifikat").value = tanah.noSertifikat;
                document.getElementById("pemilikTanah").value = tanah.pemilikTanah;
                document.getElementById("luasTanah").value = tanah.luasTanah;
                document.getElementById("jenisSertifikat").value = tanah.jenisSertifikat;
                document.getElementById("lokasiTanah").value = tanah.lokasiTanah;
                document.getElementById("batasUtara").value = tanah.batasUtara;
                document.getElementById("batasSelatan").value = tanah.batasSelatan;
                document.getElementById("batasTimur").value = tanah.batasTimur;
                document.getElementById("batasBarat").value = tanah.batasBarat;
              }
            } else {
              title.textContent = "Tambah Data Tanah Baru";
              document.getElementById("tanahId").value = "";
            }
            modal.classList.remove("hidden");
          },

          async saveTanah() {
            const id = document.getElementById("tanahId").value;
            const noSertifikat = document.getElementById("noSertifikat").value;
            const pemilikTanah = document.getElementById("pemilikTanah").value;
            const luasTanah = parseFloat(document.getElementById("luasTanah").value);
            const jenisSertifikat = document.getElementById("jenisSertifikat").value;
            const lokasiTanah = document.getElementById("lokasiTanah").value;
            const batasUtara = document.getElementById("batasUtara").value;
            const batasSelatan = document.getElementById("batasSelatan").value;
            const batasTimur = document.getElementById("batasTimur").value;
            const batasBarat = document.getElementById("batasBarat").value;

            const newTanah = {
              id: id || App.generateUniqueId(),
              noSertifikat, pemilikTanah, luasTanah, jenisSertifikat, lokasiTanah,
              batasUtara, batasSelatan, batasTimur, batasBarat,
              createdAt: id ? App.data.tanah.find(t => t.id === id).createdAt : new Date().toISOString(),
              updatedAt: new Date().toISOString()
            };

            if (id) {
              const index = App.data.tanah.findIndex((t) => t.id === id);
              if (index !== -1) {
                App.data.tanah[index] = newTanah;
                App.addAuditLog(`Mengedit data tanah ${noSertifikat} (Pemilik: ${pemilikTanah})`);
                App.showToast('fas fa-check-circle', 'text-green-500', 'Data tanah berhasil diperbarui!');
              }
            } else {
              App.data.tanah.push(newTanah);
              App.addAuditLog(`Menambah data tanah baru ${noSertifikat} (Pemilik: ${pemilikTanah})`);
              App.showToast('fas fa-check-circle', 'text-green-500', 'Data tanah baru berhasil ditambahkan!');
            }
            // TODO: Save to Firestore here
            // App.saveDataToFirestore('tanah', newTanah.id, newTanah);

            document.getElementById("tanahModal").classList.add("hidden");
            App.renderTanahTable();
            // App.saveData(); // Not needed after Firestore
            App.renderDashboard();
          },

          deleteTanah(id, noSertifikat) {
            // Menggunakan modal kustom untuk konfirmasi
            App.showConfirmModal(`Anda yakin ingin menghapus data tanah ${noSertifikat}?`, async () => {
                // TODO: Delete from Firestore
                App.data.tanah = App.data.tanah.filter((t) => t.id !== id);
                App.addAuditLog(`Menghapus data tanah ${noSertifikat} (ID: ${id})`);
                App.showToast('fas fa-check-circle', 'text-green-500', 'Data tanah berhasil dihapus!');
                App.renderTanahTable();
                App.renderDashboard();
            });
          },

          renderTanahTable() {
            // Ini akan membutuhkan perubahan signifikan untuk membaca dari Firestore
            const tableBody = document.getElementById("tanahTableBody");
            tableBody.innerHTML = "";

            let filteredTanah = App.data.tanah;

            const filterJenisSertifikat = document.getElementById("filterJenisSertifikat").value;
            if (filterJenisSertifikat) {
                filteredTanah = filteredTanah.filter(t => t.jenisSertifikat === filterJenisSertifikat);
            }

            const searchTanah = document.getElementById("searchTanah").value.toLowerCase();
            if (searchTanah) {
                filteredTanah = filteredTanah.filter(t =>
                    t.noSertifikat.toLowerCase().includes(searchTanah) ||
                    t.pemilikTanah.toLowerCase().includes(searchTanah)
                );
            }

            // Pagination logic
            const limit = App.data.pengaturan.paginationLimit;
            const startIndex = (App.currentPage.tanah - 1) * limit;
            const paginatedTanah = filteredTanah.slice(startIndex, startIndex + limit);

            if (paginatedTanah.length === 0) {
              tableBody.innerHTML = `<tr><td colspan="6" class="py-4 px-4 text-center text-gray-500 dark:text-gray-400">Tidak ada data tanah yang ditemukan.</td></tr>`;
              document.getElementById("prevTanahPage").disabled = true;
              document.getElementById("nextTanahPage").disabled = true;
            } else {
              paginatedTanah.forEach((tanah) => {
                const row = tableBody.insertRow();
                row.className = "hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150";
                row.innerHTML = `
                  <td class="py-3 px-4 font-medium text-gray-900 dark:text-gray-100">${tanah.noSertifikat}</td>
                  <td class="py-3 px-4 text-gray-700 dark:text-gray-300">${tanah.pemilikTanah}</td>
                  <td class="py-3 px-4 text-gray-700 dark:text-gray-300">${tanah.luasTanah} m²</td>
                  <td class="py-3 px-4 text-gray-700 dark:text-gray-300">${tanah.jenisSertifikat}</td>
                  <td class="py-3 px-4 text-gray-700 dark:text-gray-300">${tanah.lokasiTanah}</td>
                  <td class="py-3 px-4 whitespace-nowrap">
                    <button onclick="App.showTanahModal('${tanah.id}')" class="text-yellow-600 hover:text-yellow-800 dark:text-yellow-400 dark:hover:text-yellow-300 mr-2"><i class="fas fa-edit"></i></button>
                    <button onclick="App.deleteTanah('${tanah.id}', '${tanah.noSertifikat}')" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300"><i class="fas fa-trash-alt"></i></button>
                  </td>
                `;
              });
              document.getElementById("prevTanahPage").disabled = App.currentPage.tanah === 1;
              document.getElementById("nextTanahPage").disabled = (startIndex + limit) >= filteredTanah.length;
              document.getElementById("currentPageTanah").textContent = `Halaman ${App.currentPage.tanah}`;
            }
          },

          changeTanahPage(direction) {
            App.currentPage.tanah += direction;
            App.renderTanahTable();
          },

          // Kegiatan
          showKegiatanModal(kegiatanId = null) {
            const modal = document.getElementById("kegiatanModal");
            const title = document.getElementById("kegiatanModalTitle");
            const form = document.getElementById("kegiatanForm");
            form.reset();

            if (kegiatanId) {
              title.textContent = "Edit Data Kegiatan";
              const kegiatan = App.data.kegiatan.find((k) => k.id === kegiatanId);
              if (kegiatan) {
                document.getElementById("kegiatanId").value = kegiatan.id;
                document.getElementById("namaKegiatan").value = kegiatan.namaKegiatan;
                document.getElementById("deskripsiKegiatan").value = kegiatan.deskripsiKegiatan;
                document.getElementById("tanggalKegiatan").value = kegiatan.tanggalKegiatan;
                document.getElementById("lokasiKegiatan").value = kegiatan.lokasiKegiatan;
                document.getElementById("penanggungJawab").value = kegiatan.penanggungJawab;
                document.getElementById("statusKegiatan").value = kegiatan.statusKegiatan;
              }
            } else {
              title.textContent = "Tambah Kegiatan Baru";
              document.getElementById("kegiatanId").value = "";
              document.getElementById("tanggalKegiatan").valueAsDate = new Date(); // Set today's date
            }
            modal.classList.remove("hidden");
          },

          async saveKegiatan() {
            const id = document.getElementById("kegiatanId").value;
            const namaKegiatan = document.getElementById("namaKegiatan").value;
            const deskripsiKegiatan = document.getElementById("deskripsiKegiatan").value;
            const tanggalKegiatan = document.getElementById("tanggalKegiatan").value;
            const lokasiKegiatan = document.getElementById("lokasiKegiatan").value;
            const penanggungJawab = document.getElementById("penanggungJawab").value;
            const statusKegiatan = document.getElementById("statusKegiatan").value;

            const newKegiatan = {
              id: id || App.generateUniqueId(),
              namaKegiatan, deskripsiKegiatan, tanggalKegiatan, lokasiKegiatan,
              penanggungJawab, statusKegiatan,
              createdAt: id ? App.data.kegiatan.find(k => k.id === id).createdAt : new Date().toISOString(),
              updatedAt: new Date().toISOString()
            };

            if (id) {
              const index = App.data.kegiatan.findIndex((k) => k.id === id);
              if (index !== -1) {
                App.data.kegiatan[index] = newKegiatan;
                App.addAuditLog(`Mengedit kegiatan ${namaKegiatan}`);
                App.showToast('fas fa-check-circle', 'text-green-500', 'Data kegiatan berhasil diperbarui!');
              }
            } else {
              App.data.kegiatan.push(newKegiatan);
              App.addAuditLog(`Menambah kegiatan baru ${namaKegiatan}`);
              App.showToast('fas fa-check-circle', 'text-green-500', 'Kegiatan baru berhasil ditambahkan!');
            }
            // TODO: Save to Firestore here
            // App.saveDataToFirestore('kegiatan', newKegiatan.id, newKegiatan);

            document.getElementById("kegiatanModal").classList.add("hidden");
            App.renderKegiatanTable();
            // App.saveData(); // Not needed after Firestore
            App.renderDashboard();
          },

          deleteKegiatan(id, nama) {
            // Menggunakan modal kustom untuk konfirmasi
            App.showConfirmModal(`Anda yakin ingin menghapus kegiatan ${nama}?`, async () => {
                // TODO: Delete from Firestore
                App.data.kegiatan = App.data.kegiatan.filter((k) => k.id !== id);
                App.addAuditLog(`Menghapus kegiatan ${nama} (ID: ${id})`);
                App.showToast('fas fa-check-circle', 'text-green-500', 'Data kegiatan berhasil dihapus!');
                App.renderKegiatanTable();
                App.renderDashboard();
            });
          },

          renderKegiatanTable() {
            // Ini akan membutuhkan perubahan signifikan untuk membaca dari Firestore
            const tableBody = document.getElementById("kegiatanTableBody");
            tableBody.innerHTML = "";

            let filteredKegiatan = App.data.kegiatan;

            const filterStatusKegiatan = document.getElementById("filterStatusKegiatan").value;
            if (filterStatusKegiatan) {
                filteredKegiatan = filteredKegiatan.filter(k => k.statusKegiatan === filterStatusKegiatan);
            }

            const searchKegiatan = document.getElementById("searchKegiatan").value.toLowerCase();
            if (searchKegiatan) {
                filteredKegiatan = filteredKegiatan.filter(k =>
                    k.namaKegiatan.toLowerCase().includes(searchKegiatan)
                );
            }

            // Pagination logic
            const limit = App.data.pengaturan.paginationLimit;
            const startIndex = (App.currentPage.kegiatan - 1) * limit;
            const paginatedKegiatan = filteredKegiatan.slice(startIndex, startIndex + limit);

            if (paginatedKegiatan.length === 0) {
              tableBody.innerHTML = `<tr><td colspan="5" class="py-4 px-4 text-center text-gray-500 dark:text-gray-400">Tidak ada data kegiatan yang ditemukan.</td></tr>`;
              document.getElementById("prevKegiatanPage").disabled = true;
              document.getElementById("nextKegiatanPage").disabled = true;
            } else {
              paginatedKegiatan.forEach((kegiatan) => {
                const row = tableBody.insertRow();
                row.className = "hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150";
                row.innerHTML = `
                  <td class="py-3 px-4 font-medium text-gray-900 dark:text-gray-100">${kegiatan.namaKegiatan}</td>
                  <td class="py-3 px-4 text-gray-700 dark:text-gray-300">${App.formatDate(kegiatan.tanggalKegiatan)}</td>
                  <td class="py-3 px-4 text-gray-700 dark:text-gray-300">${kegiatan.lokasiKegiatan}</td>
                  <td class="py-3 px-4">${App.getStatusBadge(kegiatan.statusKegiatan)}</td>
                  <td class="py-3 px-4 whitespace-nowrap">
                    <button onclick="App.showKegiatanModal('${kegiatan.id}')" class="text-yellow-600 hover:text-yellow-800 dark:text-yellow-400 dark:hover:text-yellow-300 mr-2"><i class="fas fa-edit"></i></button>
                    <button onclick="App.deleteKegiatan('${kegiatan.id}', '${kegiatan.namaKegiatan}')" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300"><i class="fas fa-trash-alt"></i></button>
                  </td>
                `;
              });
              document.getElementById("prevKegiatanPage").disabled = App.currentPage.kegiatan === 1;
              document.getElementById("nextKegiatanPage").disabled = (startIndex + limit) >= filteredKegiatan.length;
              document.getElementById("currentPageKegiatan").textContent = `Halaman ${App.currentPage.kegiatan}`;
            }
          },

          changeKegiatanPage(direction) {
            App.currentPage.kegiatan += direction;
            App.renderKegiatanTable();
          },

          // Keuangan
          showKeuanganModal(jenis, keuanganId = null) {
            const modal = document.getElementById("keuanganModal");
            const title = document.getElementById("keuanganModalTitle");
            const form = document.getElementById("keuanganForm");
            form.reset();
            document.getElementById("keuanganJenis").value = jenis;

            if (keuanganId) {
              title.textContent = `Edit Transaksi ${jenis}`;
              const transaksi = App.data.keuangan.find((t) => t.id === keuanganId);
              if (transaksi) {
                document.getElementById("keuanganId").value = transaksi.id;
                document.getElementById("tanggalTransaksi").value = transaksi.tanggalTransaksi;
                document.getElementById("deskripsiTransaksi").value = transaksi.deskripsiTransaksi;
                document.getElementById("jumlahTransaksi").value = transaksi.jumlahTransaksi;
              }
            } else {
              title.textContent = `Tambah ${jenis}`;
              document.getElementById("keuanganId").value = "";
              document.getElementById("tanggalTransaksi").valueAsDate = new Date(); // Set today's date
            }
            modal.classList.remove("hidden");
          },

          async saveKeuangan() {
            const id = document.getElementById("keuanganId").value;
            const jenis = document.getElementById("keuanganJenis").value;
            const tanggalTransaksi = document.getElementById("tanggalTransaksi").value;
            const deskripsiTransaksi = document.getElementById("deskripsiTransaksi").value;
            const jumlahTransaksi = parseFloat(document.getElementById("jumlahTransaksi").value);

            const newTransaksi = {
              id: id || App.generateUniqueId(),
              jenis, tanggalTransaksi, deskripsiTransaksi, jumlahTransaksi,
              createdAt: id ? App.data.keuangan.find(t => t.id === id).createdAt : new Date().toISOString(),
              updatedAt: new Date().toISOString()
            };

            if (id) {
              const index = App.data.keuangan.findIndex((t) => t.id === id);
              if (index !== -1) {
                App.data.keuangan[index] = newTransaksi;
                App.addAuditLog(`Mengedit transaksi ${jenis}: ${deskripsiTransaksi}`);
                App.showToast('fas fa-check-circle', 'text-green-500', 'Data transaksi berhasil diperbarui!');
              }
            } else {
              App.data.keuangan.push(newTransaksi);
              App.addAuditLog(`Menambah transaksi ${jenis}: ${deskripsiTransaksi}`);
              App.showToast('fas fa-check-circle', 'text-green-500', 'Transaksi baru berhasil ditambahkan!');
            }
            // TODO: Save to Firestore here
            // App.saveDataToFirestore('keuangan', newTransaksi.id, newTransaksi);

            document.getElementById("keuanganModal").classList.add("hidden");
            App.renderKeuanganTable();
            // App.saveData(); // Not needed after Firestore
            App.renderDashboard();
          },

          deleteKeuangan(id, deskripsi) {
            // Menggunakan modal kustom untuk konfirmasi
            App.showConfirmModal(`Anda yakin ingin menghapus transaksi "${deskripsi}"?`, async () => {
                // TODO: Delete from Firestore
                App.data.keuangan = App.data.keuangan.filter((t) => t.id !== id);
                App.addAuditLog(`Menghapus transaksi: ${deskripsi} (ID: ${id})`);
                App.showToast('fas fa-check-circle', 'text-green-500', 'Data transaksi berhasil dihapus!');
                App.renderKeuanganTable();
                App.renderDashboard();
            });
          },

          renderKeuanganTable() {
            // Ini akan membutuhkan perubahan signifikan untuk membaca dari Firestore
            const tableBody = document.getElementById("keuanganTableBody");
            tableBody.innerHTML = "";

            let filteredKeuangan = App.data.keuangan;

            const filterJenisTransaksi = document.getElementById("filterJenisTransaksi").value;
            if (filterJenisTransaksi) {
                filteredKeuangan = filteredKeuangan.filter(t => t.jenis === filterJenisTransaksi);
            }

            const filterBulanTahun = document.getElementById("filterBulanTahun").value;
            if (filterBulanTahun) {
                filteredKeuangan = filteredKeuangan.filter(t => t.tanggalTransaksi.startsWith(filterBulanTahun));
            }

            const searchKeuangan = document.getElementById("searchKeuangan").value.toLowerCase();
            if (searchKeuangan) {
                filteredKeuangan = filteredKeuangan.filter(t =>
                    t.deskripsiTransaksi.toLowerCase().includes(searchKeuangan)
                );
            }

            // Urutkan berdasarkan tanggal terbaru
            filteredKeuangan.sort((a, b) => new Date(b.tanggalTransaksi) - new Date(a.tanggalTransaksi));

            // Pagination logic
            const limit = App.data.pengaturan.paginationLimit;
            const startIndex = (App.currentPage.keuangan - 1) * limit;
            const paginatedKeuangan = filteredKeuangan.slice(startIndex, startIndex + limit);

            if (paginatedKeuangan.length === 0) {
              tableBody.innerHTML = `<tr><td colspan="5" class="py-4 px-4 text-center text-gray-500 dark:text-gray-400">Tidak ada data keuangan yang ditemukan.</td></tr>`;
              document.getElementById("prevKeuanganPage").disabled = true;
              document.getElementById("nextKeuanganPage").disabled = true;
            } else {
              paginatedKeuangan.forEach((transaksi) => {
                const row = tableBody.insertRow();
                row.className = "hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150";
                const amountColorClass = transaksi.jenis === 'Pemasukan' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                row.innerHTML = `
                  <td class="py-3 px-4 text-gray-700 dark:text-gray-300">${App.formatDate(transaksi.tanggalTransaksi)}</td>
                  <td class="py-3 px-4 text-gray-700 dark:text-gray-300">${transaksi.jenis}</td>
                  <td class="py-3 px-4 text-gray-700 dark:text-gray-300">${transaksi.deskripsiTransaksi}</td>
                  <td class="py-3 px-4 font-medium ${amountColorClass}">${App.formatCurrency(transaksi.jumlahTransaksi)}</td>
                  <td class="py-3 px-4 whitespace-nowrap">
                    <button onclick="App.showKeuanganModal('${transaksi.jenis}', '${transaksi.id}')" class="text-yellow-600 hover:text-yellow-800 dark:text-yellow-400 dark:hover:text-yellow-300 mr-2"><i class="fas fa-edit"></i></button>
                    <button onclick="App.deleteKeuangan('${transaksi.id}', '${transaksi.deskripsiTransaksi}')" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300"><i class="fas fa-trash-alt"></i></button>
                  </td>
                `;
              });
              document.getElementById("prevKeuanganPage").disabled = App.currentPage.keuangan === 1;
              document.getElementById("nextKeuanganPage").disabled = (startIndex + limit) >= filteredKeuangan.length;
              document.getElementById("currentPageKeuangan").textContent = `Halaman ${App.currentPage.keuangan}`;
            }
            App.updateKeuanganSummary();
          },

          changeKeuanganPage(direction) {
            App.currentPage.keuangan += direction;
            App.renderKeuanganTable();
          },

          updateKeuanganSummary() {
            const totalPemasukan = App.data.keuangan
              .filter(t => t.jenis === 'Pemasukan')
              .reduce((sum, t) => sum + t.jumlahTransaksi, 0);
            const totalPengeluaran = App.data.keuangan
              .filter(t => t.jenis === 'Pengeluaran')
              .reduce((sum, t) => sum + t.jumlahTransaksi, 0);
            const saldo = totalPemasukan - totalPengeluaran;

            document.getElementById("totalPemasukan").textContent = App.formatCurrency(totalPemasukan);
            document.getElementById("totalPengeluaran").textContent = App.formatCurrency(totalPengeluaran);
            document.getElementById("saldoKeuangan").textContent = App.formatCurrency(saldo);
          },

          // Pengaturan
          async renderPengaturan() {
            // Ini akan memuat dari Firestore
            await App.loadDataFromFirestore('pengaturan'); // Pastikan ini dipanggil
            const settings = App.data.pengaturan;
            document.getElementById("namaDesa").value = settings.namaDesa || "";
            document.getElementById("alamatDesa").value = settings.alamatDesa || "";
            document.getElementById("teleponDesa").value = settings.teleponDesa || "";
            document.getElementById("emailDesa").value = settings.emailDesa || "";
            document.getElementById("paginationLimit").value = settings.paginationLimit || 10;
            document.getElementById("auditLogRetention").value = settings.auditLogRetention || 90;

            App.renderAdminList();
          },

          async savePengaturanDesa() {
            const namaDesa = document.getElementById("namaDesa").value;
            const alamatDesa = document.getElementById("alamatDesa").value;
            const teleponDesa = document.getElementById("teleponDesa").value;
            const emailDesa = document.getElementById("emailDesa").value;

            App.data.pengaturan.namaDesa = namaDesa;
            App.data.pengaturan.alamatDesa = alamatDesa;
            App.data.pengaturan.teleponDesa = teleponDesa;
            App.data.pengaturan.emailDesa = emailDesa;

            // TODO: Save to Firestore
            await App.saveDataToFirestore('pengaturan', 'desaSettings', App.data.pengaturan);
            App.addAuditLog('Memperbarui informasi desa');
            App.showToast('fas fa-check-circle', 'text-green-500', 'Informasi desa berhasil disimpan!');
            // App.saveData(); // Not needed after Firestore
            App.renderDashboard();
          },

          renderAdminList() {
            const adminList = document.getElementById("adminList");
            adminList.innerHTML = "";
            if (App.data.pengaturan.admins && App.data.pengaturan.admins.length > 0) {
                App.data.pengaturan.admins.forEach(admin => {
                    const li = document.createElement("li");
                    li.className = "flex justify-between items-center bg-gray-50 dark:bg-gray-700 p-2 rounded-md";
                    const isCurrentUser = auth.currentUser && auth.currentUser.email === admin.email;
                    li.innerHTML = `
                        <span class="text-gray-700 dark:text-gray-300">${admin.email} ${isCurrentUser ? '(Anda)' : ''}</span>
                        <div>
                            ${isCurrentUser ? '' : `<button onclick="App.removeAdmin('${admin.email}')" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 ml-2"><i class="fas fa-trash-alt"></i></button>`}
                        </div>
                    `;
                    adminList.appendChild(li);
                });
            } else {
                adminList.innerHTML = `<li class="text-gray-500 dark:text-gray-400">Belum ada admin terdaftar.</li>`;
            }
          },

          async addAdmin() {
            const adminEmailInput = document.getElementById("adminEmail");
            const email = adminEmailInput.value.trim();
            const addAdminError = document.getElementById("addAdminError");

            if (!email || !email.includes('@')) {
                addAdminError.textContent = "Mohon masukkan email yang valid.";
                addAdminError.classList.remove("hidden");
                App.showToast('fas fa-exclamation-circle', 'text-yellow-500', 'Email tidak valid.');
                return;
            }

            if (App.data.pengaturan.admins.some(admin => admin.email === email)) {
                addAdminError.textContent = "Email ini sudah terdaftar sebagai admin.";
                addAdminError.classList.remove("hidden");
                App.showToast('fas fa-info-circle', 'text-blue-500', 'Email sudah terdaftar!');
                return;
            }

            // Sebagai contoh, kita akan menggunakan password sementara.
            // Dalam aplikasi nyata, Anda mungkin ingin mengimplementasikan
            // alur undangan di mana pengguna baru mengatur kata sandi mereka sendiri.
            const tempPassword = 'temporaryPassword123'; // Ini password sementara, tidak aman untuk produksi!

            try {
                addAdminError.classList.add("hidden");
                // Mendaftarkan pengguna baru di Firebase Authentication
                await auth.createUserWithEmailAndPassword(email, tempPassword);

                // Jika pendaftaran berhasil, tambahkan email ke daftar admin di pengaturan lokal
                App.data.pengaturan.admins.push({ email: email });
                // Simpan pengaturan yang diperbarui ke Firestore
                await App.saveDataToFirestore('pengaturan', 'desaSettings', App.data.pengaturan);

                App.addAuditLog(`Menambah admin baru: ${email}`);
                App.showToast('fas fa-check-circle', 'text-green-500', `Admin ${email} berhasil didaftarkan di Firebase!`);
                adminEmailInput.value = '';
                App.renderAdminList();
            } catch (error) {
                console.error("Error adding new admin:", error.message);
                let errorMessage = `Gagal menambah admin: ${error.message}`;
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Email ini sudah terdaftar sebagai pengguna. Tambahkan ke daftar admin jika Anda ingin mengelola izin tanpa mendaftar ulang.';
                    App.showToast('fas fa-info-circle', 'text-blue-500', 'Email sudah terdaftar sebagai pengguna!');
                } else {
                    App.showToast('fas fa-times-circle', 'text-red-500', `Gagal menambah admin: ${error.message}`);
                }
                addAdminError.textContent = errorMessage;
                addAdminError.classList.remove("hidden");
            }
          },

          async removeAdmin(emailToRemove) {
            if (auth.currentUser && auth.currentUser.email === emailToRemove) {
                App.showToast('fas fa-exclamation-circle', 'text-red-500', 'Anda tidak dapat menghapus akun admin Anda sendiri.');
                return;
            }
            // Menggunakan modal kustom untuk konfirmasi
            App.showConfirmModal(`Anda yakin ingin menghapus admin ${emailToRemove}? Proses ini akan menghapus akunnya dari Firebase Authentication juga.`, async () => {
                try {
                    // Dapatkan semua pengguna yang terdaftar (membutuhkan admin SDK di backend/Cloud Functions)
                    // Karena ini adalah frontend, kita tidak bisa langsung menghapus user dari sini.
                    // Ini adalah batasan keamanan di Firebase: pengguna hanya bisa menghapus akun mereka sendiri.
                    // Untuk menghapus akun pengguna lain, Anda perlu Cloud Functions atau backend.

                    // Untuk tujuan demo ini, kita hanya akan menghapus dari daftar admins lokal dan Firestore.
                    // Akunnya di Firebase Auth akan tetap ada kecuali dihapus secara manual atau melalui Cloud Functions.
                    App.data.pengaturan.admins = App.data.pengaturan.admins.filter(admin => admin.email !== emailToRemove);
                    await App.saveDataToFirestore('pengaturan', 'desaSettings', App.data.pengaturan);

                    App.addAuditLog(`Menghapus admin: ${emailToRemove}`);
                    App.showToast('fas fa-check-circle', 'text-green-500', `Admin ${emailToRemove} berhasil dihapus dari daftar. (Catatan: Akun Firebase Auth-nya mungkin masih ada dan perlu dihapus manual jika tidak ada Cloud Functions)`);
                    App.renderAdminList();
                } catch (error) {
                    console.error("Error removing admin:", error.message);
                    App.showToast('fas fa-times-circle', 'text-red-500', `Gagal menghapus admin: ${error.message}`);
                }
            });
          },

          async saveOtherSettings() {
            const paginationLimit = parseInt(document.getElementById("paginationLimit").value);
            const auditLogRetention = parseInt(document.getElementById("auditLogRetention").value);

            App.data.pengaturan.paginationLimit = paginationLimit;
            App.data.pengaturan.auditLogRetention = auditLogRetention;

            // TODO: Save to Firestore
            await App.saveDataToFirestore('pengaturan', 'desaSettings', App.data.pengaturan);
            App.addAuditLog('Memperbarui pengaturan aplikasi lainnya');
            App.showToast('fas fa-check-circle', 'text-green-500', 'Pengaturan lainnya berhasil disimpan!');
            // App.saveData(); // Not needed after Firestore
            App.renderDashboard(); // Refresh dashboard if settings affect it
          },


          // Dashboard
          renderDashboard() {
            document.getElementById("totalWarga").textContent = App.data.warga.length;
            document.getElementById("totalSurat").textContent = App.data.surat.length;
            document.getElementById("totalKegiatan").textContent = App.data.kegiatan.filter(k => k.statusKegiatan !== 'Selesai' && k.statusKegiatan !== 'Dibatalkan').length;
            App.updateKeuanganSummary();

            App.renderDemografiChart();
            App.renderRecentSuratList();
            App.renderAuditLogsTable();
          },

          renderDemografiChart() {
            const ctx = document.getElementById('demografiChart').getContext('2d');
            if (App.chartInstances.demografiChart) {
                App.chartInstances.demografiChart.destroy();
            }

            const genderData = App.data.warga.reduce((acc, warga) => {
              acc[warga.jenisKelamin] = (acc[warga.jenisKelamin] || 0) + 1;
              return acc;
            }, {});

            App.chartInstances.demografiChart = new Chart(ctx, {
              type: 'pie',
              data: {
                labels: Object.keys(genderData),
                datasets: [{
                  data: Object.values(genderData),
                  backgroundColor: [
                    'rgba(75, 192, 192, 0.6)', // Laki-laki (Teal)
                    'rgba(255, 99, 132, 0.6)',  // Perempuan (Red)
                    'rgba(200, 200, 200, 0.6)'  // Lainnya
                  ],
                  borderColor: [
                    'rgba(75, 192, 192, 1)',
                    'rgba(255, 99, 132, 1)',
                    'rgba(200, 200, 200, 1)'
                  ],
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: document.documentElement.classList.contains('dark') ? '#e2e8f0' : '#374151'
                        }
                    }
                }
              }
            });
          },

          renderRecentSuratList() {
            const list = document.getElementById("recentSuratList");
            list.innerHTML = "";
            const recentSurat = [...App.data.surat]
              .sort((a, b) => new Date(b.tanggalPengajuan) - new Date(a.tanggalPengajuan))
              .slice(0, 5); // Ambil 5 surat terbaru

            if (recentSurat.length === 0) {
              list.innerHTML = `<li><i class="fas fa-circle-info text-blue-500 mr-2"></i>Belum ada data surat.</li>`;
            } else {
              recentSurat.forEach(surat => {
                const li = document.createElement("li");
                li.innerHTML = `<i class="fas fa-envelope text-indigo-500 mr-2"></i> Surat ${surat.jenisSurat} untuk ${surat.namaPemohon} (${App.formatDate(surat.tanggalPengajuan)}) - ${App.getStatusBadge(surat.statusSurat)}`;
                list.appendChild(li);
              });
            }
          },

          addAuditLog(activity) {
            const userEmail = auth.currentUser ? auth.currentUser.email : "Anonim";
            const newLog = {
              timestamp: new Date().toISOString(),
              activity: activity,
              user: userEmail,
            };
            App.data.auditLogs.unshift(newLog); // Tambahkan ke depan array
            // Batasi jumlah log yang disimpan berdasarkan pengaturan
            const maxLogs = App.data.pengaturan.auditLogRetention * 2; // Misalnya, 2 log per hari
            if (App.data.auditLogs.length > maxLogs) {
                App.data.auditLogs = App.data.auditLogs.slice(0, maxLogs);
            }
            // TODO: Save audit log to Firestore (collection: 'auditLogs')
            // db.collection('auditLogs').add(newLog);
            // App.saveData(); // Not needed after Firestore
            App.renderAuditLogsTable();
          },

          renderAuditLogsTable() {
            const tableBody = document.getElementById("auditLogsTableBody");
            tableBody.innerHTML = "";

            // Filter log berdasarkan retensi (misal: 90 hari terakhir)
            const retentionDays = App.data.pengaturan.auditLogRetention || 90;
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - retentionDays);

            const filteredLogs = App.data.auditLogs.filter(log => new Date(log.timestamp) >= cutoffDate);

            if (filteredLogs.length === 0) {
              tableBody.innerHTML = `<tr><td colspan="3" class="py-4 px-4 text-center text-gray-500 dark:text-gray-400">Belum ada log aktivitas.</td></tr>`;
            } else {
              filteredLogs.slice(0, 10).forEach(log => { // Tampilkan 10 log terbaru di dashboard
                const row = tableBody.insertRow();
                row.className = "hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150";
                row.innerHTML = `
                  <td class="py-3 px-4 text-gray-700 dark:text-gray-300">${new Date(log.timestamp).toLocaleString('id-ID')}</td>
                  <td class="py-3 px-4 text-gray-700 dark:text-gray-300">${log.activity}</td>
                  <td class="py-3 px-4 text-gray-700 dark:text-gray-300">${log.user}</td>
                `;
              });
            }
          },

          // Utility functions for status badges and colors
          getStatusBadge(status) {
            const colors = {
              'Aktif': 'bg-green-100 text-green-800 dark:bg-green-700 dark:text-green-100',
              'Non-Aktif': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-700 dark:text-yellow-100',
              'Meninggal': 'bg-red-100 text-red-800 dark:bg-red-700 dark:text-red-100',
              'Pindah': 'bg-blue-100 text-blue-800 dark:bg-blue-700 dark:text-blue-100',
              'Diajukan': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-700 dark:text-yellow-100',
              'Diproses': 'bg-blue-100 text-blue-800 dark:bg-blue-700 dark:text-blue-100',
              'Selesai': 'bg-green-100 text-green-800 dark:bg-green-700 dark:text-green-100',
              'Ditolak': 'bg-red-100 text-red-800 dark:bg-red-700 dark:text-red-100',
              'Akan Datang': 'bg-purple-100 text-purple-800 dark:bg-purple-700 dark:text-purple-100',
              'Sedang Berlangsung': 'bg-indigo-100 text-indigo-800 dark:bg-indigo-700 dark:text-indigo-100',
              'Dibatalkan': 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300',
            };
            return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium leading-5 font-semibold rounded-full ${colors[status] || "bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-300"}" style="white-space: nowrap;">${status}</span>`;
          },

          // Menampilkan notifikasi toast di pojok kanan atas
          showToast(iconClass, textColorClass, message) {
            const toastContainer = document.getElementById("toast-container");
            if (!toastContainer) {
              console.warn("Toast container not found.");
              return;
            }
            const toast = document.createElement("div");
            toast.className = "toast";
            toast.innerHTML = `<i class="${iconClass} icon ${textColorClass}"></i><span>${message}</span>`;
            toastContainer.appendChild(toast);

            // Beri sedikit penundaan sebelum menampilkan untuk efek transisi
            setTimeout(() => {
              toast.classList.add("show");
            }, 100);

            // Sembunyikan dan hapus toast setelah 3 detik
            setTimeout(() => {
              toast.classList.remove("show");
              // Hapus elemen setelah transisi selesai
              toast.addEventListener("transitionend", () => toast.remove());
            }, 3000);
          },

          // Fungsi untuk menampilkan modal konfirmasi kustom
          showConfirmModal(message, onConfirm) {
              const existingModal = document.getElementById('customConfirmModal');
              if (existingModal) existingModal.remove(); // Hapus jika sudah ada

              const modalHtml = `
                  <div id="customConfirmModal" class="modal-backdrop">
                      <div class="modal-content w-full md:max-w-sm">
                          <p class="text-lg font-semibold mb-6 text-gray-900 dark:text-gray-100">${message}</p>
                          <div class="flex justify-end space-x-3">
                              <button id="cancelConfirmBtn" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">Batal</button>
                              <button id="confirmActionBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">Ya, Hapus</button>
                          </div>
                      </div>
                  </div>
              `;
              document.body.insertAdjacentHTML('beforeend', modalHtml);

              const confirmModal = document.getElementById('customConfirmModal');
              const confirmActionBtn = document.getElementById('confirmActionBtn');
              const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');

              confirmActionBtn.onclick = () => {
                  onConfirm();
                  confirmModal.remove();
              };
              cancelConfirmBtn.onclick = () => {
                  confirmModal.remove();
              };
              // Tutup modal jika klik di luar konten (backdrop)
              confirmModal.addEventListener('click', (e) => {
                  if (e.target === confirmModal) {
                      confirmModal.remove();
                  }
              });
          },

          // Excel Import/Export (akan tetap berjalan di sisi klien, tapi data berasal dari/untuk Firestore)
          exportToExcel(dataType, fileName) {
            const dataToExport = App.data[dataType];
            if (dataToExport.length === 0) {
                App.showToast('fas fa-info-circle', 'text-blue-500', `Tidak ada data ${dataType} untuk diekspor.`);
                return;
            }

            const ws = XLSX.utils.json_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, dataType);
            XLSX.writeFile(wb, `${fileName}_${new Date().toISOString().slice(0,10)}.xlsx`);
            App.addAuditLog(`Mengekspor data ${dataType}`);
            App.showToast('fas fa-check-circle', 'text-green-500', `Data ${dataType} berhasil diekspor!`);
          },

          importFromExcel(event, dataType) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                if (jsonData.length > 0) {
                    // TODO: Ini perlu penanganan lebih lanjut untuk import ke Firestore
                    // Misalnya, validasi data, penanganan duplikat, dan operasi batch Firestore
                    const importedCount = jsonData.length;
                    App.data[dataType] = [...App.data[dataType], ...jsonData.map(item => ({...item, id: App.generateUniqueId()}))]; // Simpan sementara ke array lokal
                    App.addAuditLog(`Mengimpor ${importedCount} data ${dataType} dari Excel`);
                    App.showToast('fas fa-check-circle', 'text-green-500', `${importedCount} data ${dataType} berhasil diimpor (sementara)! Perlu sinkronisasi ke Firebase.`);
                    // App.saveData(); // Not needed after Firestore
                    if (dataType === 'warga') {
                        App.renderWargaTable();
                    }
                    App.renderDashboard();
                } else {
                    App.showToast('fas fa-exclamation-circle', 'text-yellow-500', 'File Excel kosong atau tidak ada data yang valid.');
                }
            };
            reader.readAsArrayBuffer(file);
          },
        };

        // Ekspos objek App ke window agar bisa diakses secara global (misal untuk debugging dan event listener HTML)
        window.App = App;
        // Inisialisasi aplikasi saat DOM selesai dimuat
        App.init();
      });
    </script>
  </body>
</html>
