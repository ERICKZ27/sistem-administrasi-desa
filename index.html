<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistem Administrasi Desa - Profesional</title>
    <!-- Memuat Tailwind CSS untuk styling utilitas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat Chart.js untuk visualisasi grafik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Memuat XLSX untuk fungsionalitas ekspor dan impor ke Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <!-- Memuat Font Awesome untuk ikon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <!-- Memuat Font Inter dari Google Fonts untuk tipografi profesional -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
    <!-- Menambahkan Font untuk KTP / OCR A Std (simulasi) -->
    <link href="https://fonts.googleapis.com/css2?family=OCR+A+Std&display=swap" rel="stylesheet" />

    <!-- Firebase SDK (Modular) -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-analytics.js"; // Import getAnalytics
      import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
      import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, query, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";
      import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-storage.js";

      // Konfigurasi Firebase Anda (Ganti dengan konfigurasi proyek Anda yang sebenarnya dari Firebase Console)
      // Catatan: Pastikan ini aman dan tidak mengekspos API key di produksi jika tidak di Cloud Functions/Env Vars
      const firebaseConfig = {
        apiKey: "AIzaSyAuCgLHRo4MvNRmx0sNjfoZKf4Tw37mW4w", // Ganti dengan API Key Anda
        authDomain: "sistem-administrasi-desa.firebaseapp.com", // Ganti dengan domain proyek Anda
        databaseURL: "https://sistem-administrasi-desa-default-rtdb.asia-southeast1.firebasedatabase.app", // Ditambahkan dari konfigurasi Anda
        projectId: "sistem-administrasi-desa", // Ganti dengan ID proyek Anda
        storageBucket: "sistem-administrasi-desa.appspot.com", // Ganti dengan bucket penyimpanan Anda (gunakan .appspot.com)
        messagingSenderId: "139088027532",
        appId: "1:139088027532:web:fa6d3ce9c9abe236ad40a9",
        measurementId: "G-XE135HPXL8", // Diperbarui dengan ID yang Anda berikan
      };

      // Inisialisasi Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app); // Inisialisasi Analytics
      const db = getFirestore(app);
      const auth = getAuth(app);
      const storage = getStorage(app);

      console.log("Firebase initialized successfully!");

      document.addEventListener("DOMContentLoaded", () => {
        const appContent = document.getElementById("appContent");
        const loginForm = document.getElementById("loginForm");
        const adminLoginForm = document.getElementById("adminLoginForm");
        const loginError = document.getElementById("loginError");
        const logoutButton = document.getElementById("logoutButton");

        const registerModal = document.getElementById("registerModal");
        const adminRegisterForm = document.getElementById("adminRegisterForm");
        const registerError = document.getElementById("registerError");
        const showRegisterModalLink = document.getElementById("showRegisterModalLink");
        const showLoginModalLink = document.getElementById("showLoginModalLink");
        const addAdminError = document.getElementById("addAdminError");

        const App = {
          data: {
            warga: [],
            surat: [],
            tanah: [],
            kegiatan: [],
            keuangan: [],
            pengaturan: {
              namaDesa: "Desa Digital",
              alamatDesa: "Jl. Desa Makmur No. 123",
              teleponDesa: "0812-3456-7890",
              emailDesa: "info@desadigital.go.id",
              admins: [], // Daftar admin dari Firestore
              paginationLimit: 10,
              auditLogRetention: 90,
            },
            auditLogs: [],
          },
          currentPage: {
            warga: 1,
            surat: 1,
            tanah: 1,
            kegiatan: 1,
            keuangan: 1,
          },
          currentModule: "dashboard",
          chartInstances: {},
          isAuthReady: false, // Flag untuk menandai apakah auth sudah siap

          // --- Firebase Authentication ---
          async authenticate(email, password) {
            try {
              loginError.classList.add("hidden");
              const userCredential = await signInWithEmailAndPassword(auth, email, password);
              console.log("User logged in:", userCredential.user.email);
              App.showToast("fas fa-check-circle", "text-green-500", "Login berhasil!");
            } catch (error) {
              console.error("Login failed:", error.message);
              App.showToast("fas fa-times-circle", "text-red-500", `Login gagal: ${error.message}`);
              loginError.textContent = `Login gagal: ${error.message}`;
              loginError.classList.remove("hidden");
            }
          },

          async registerUser(email, password) {
            try {
              registerError.classList.add("hidden");
              const userCredential = await createUserWithEmailAndPassword(auth, email, password);
              // Tambahkan user baru ke koleksi 'users' di Firestore
              await setDoc(doc(db, "users", userCredential.user.uid), {
                email: userCredential.user.email,
                displayName: userCredential.user.email.split("@")[0],
                role: "admin", // Default role
                createdAt: serverTimestamp(),
                lastLoginAt: serverTimestamp(),
              });

              // Tambahkan admin baru ke pengaturan desa
              const settingsRef = doc(db, "pengaturan", "desaSettings");
              const settingsSnap = await getDoc(settingsRef);
              let currentAdmins = [];
              if (settingsSnap.exists()) {
                currentAdmins = settingsSnap.data().admins || [];
              }
              if (!currentAdmins.some(admin => admin.email === email)) {
                currentAdmins.push({ email: email, uid: userCredential.user.uid });
                await setDoc(settingsRef, { admins: currentAdmins }, { merge: true });
              }

              console.log("User registered:", userCredential.user.email);
              App.showToast("fas fa-check-circle", "text-green-500", "Pendaftaran berhasil! Silakan login.");
              registerModal.classList.add("hidden");
              loginForm.classList.remove("hidden");
            } catch (error) {
              console.error("Registration failed:", error.message);
              let errorMessage = `Pendaftaran gagal: ${error.message}`;
              if (error.code === "auth/email-already-in-use") {
                errorMessage = "Email ini sudah terdaftar. Silakan coba login atau gunakan email lain.";
                App.showToast("fas fa-info-circle", "text-blue-500", "Email sudah terdaftar!");
              } else {
                App.showToast("fas fa-times-circle", "text-red-500", `Pendaftaran gagal: ${error.message}`);
              }
              registerError.textContent = errorMessage;
              registerError.classList.remove("hidden");
            }
          },

          async logout() {
            try {
              await signOut(auth);
              console.log("User logged out");
              App.showToast("fas fa-sign-out-alt", "text-blue-500", "Anda telah keluar.");
            } catch (error) {
              console.error("Logout failed:", error.message);
              App.showToast("fas fa-times-circle", "text-red-500", `Gagal logout: ${error.message}`);
            }
          },

          // --- Firebase Firestore & Storage Handling ---
          // Generic function to save/update data to Firestore
          async saveDataToFirestore(collectionName, docId, data, merge = true) {
            try {
              const docRef = doc(db, collectionName, docId);
              await setDoc(docRef, { ...data, updatedAt: serverTimestamp() }, { merge: merge });
              console.log(`${collectionName} data saved with ID: ${docId}`);
            } catch (error) {
              console.error(`Error saving ${collectionName} with ID ${docId}:`, error);
              App.showToast("fas fa-times-circle", "text-red-500", `Gagal menyimpan data ${collectionName}.`);
            }
          },

          // Generic function to add new data to Firestore (auto ID)
          async addDataToFirestore(collectionName, data) {
            try {
              const colRef = collection(db, collectionName);
              const docRef = await addDoc(colRef, { ...data, createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
              console.log(`${collectionName} data added with ID: ${docRef.id}`);
              return docRef.id;
            } catch (error) {
              console.error(`Error adding ${collectionName} data:`, error);
              App.showToast("fas fa-times-circle", "text-red-500", `Gagal menambahkan data ${collectionName}.`);
              return null;
            }
          },

          // Generic function to delete data from Firestore
          async deleteDataFromFirestore(collectionName, docId) {
            try {
              await deleteDoc(doc(db, collectionName, docId));
              console.log(`${collectionName} data with ID ${docId} deleted.`);
            } catch (error) {
              console.error(`Error deleting ${collectionName} with ID ${docId}:`, error);
              App.showToast("fas fa-times-circle", "text-red-500", `Gagal menghapus data ${collectionName}.`);
            }
          },

          // Upload file to Firebase Storage
          async uploadFile(file, path) {
            try {
              const storageRef = ref(storage, path);
              const snapshot = await uploadBytes(storageRef, file);
              const downloadURL = await getDownloadURL(snapshot.ref);
              console.log("File uploaded:", downloadURL);
              App.showToast("fas fa-upload", "text-blue-500", "File berhasil diunggah!");
              return downloadURL;
            } catch (error) {
              console.error("Error uploading file:", error);
              App.showToast("fas fa-times-circle", "text-red-500", `Gagal mengunggah file: ${error.message}`);
              return null;
            }
          },

          // Delete file from Firebase Storage
          async deleteFile(url) {
            try {
              if (!url || !url.includes("firebasestorage.googleapis.com")) return; // Only delete Firebase Storage URLs
              const fileRef = ref(storage, url);
              await deleteObject(fileRef);
              console.log("File deleted from storage:", url);
            } catch (error) {
              console.error("Error deleting file from storage:", error);
              // Show toast only for actual errors, not 'object not found'
              if (error.code !== 'storage/object-not-found') {
                App.showToast("fas fa-times-circle", "text-red-500", `Gagal menghapus file dari penyimpanan: ${error.message}`);
              }
            }
          },

          // --- Data Listeners (Real-time updates) ---
          setupFirestoreListeners() {
            // Pengaturan
            onSnapshot(doc(db, "pengaturan", "desaSettings"), (docSnap) => {
              if (docSnap.exists()) {
                App.data.pengaturan = { ...App.data.pengaturan, ...docSnap.data() };
                console.log("Pengaturan updated:", App.data.pengaturan);
                App.renderPengaturan();
                App.renderDashboard(); // Update dashboard if settings affect it
              } else {
                console.log("No 'desaSettings' document found. Creating default.");
                App.saveDataToFirestore("pengaturan", "desaSettings", App.data.pengaturan); // Create default settings
              }
            }, (error) => console.error("Error listening to pengaturan:", error));

            // Warga
            onSnapshot(collection(db, "warga"), (snapshot) => {
              App.data.warga = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              console.log("Warga updated:", App.data.warga.length);
              App.renderWargaTable();
              App.renderDashboard();
            }, (error) => console.error("Error listening to warga:", error));

            // Surat
            onSnapshot(collection(db, "surat"), (snapshot) => {
              App.data.surat = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              console.log("Surat updated:", App.data.surat.length);
              App.renderSuratTable();
              App.renderDashboard();
            }, (error) => console.error("Error listening to surat:", error));

            // Tanah
            onSnapshot(collection(db, "tanah"), (snapshot) => {
              App.data.tanah = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              console.log("Tanah updated:", App.data.tanah.length);
              App.renderTanahTable();
              App.renderDashboard();
            }, (error) => console.error("Error listening to tanah:", error));

            // Kegiatan
            onSnapshot(collection(db, "kegiatan"), (snapshot) => {
              App.data.kegiatan = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              console.log("Kegiatan updated:", App.data.kegiatan.length);
              App.renderKegiatanTable();
              App.renderDashboard();
            }, (error) => console.error("Error listening to kegiatan:", error));

            // Keuangan
            onSnapshot(collection(db, "keuangan"), (snapshot) => {
              App.data.keuangan = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              console.log("Keuangan updated:", App.data.keuangan.length);
              App.renderKeuanganTable();
              App.renderDashboard();
            }, (error) => console.error("Error listening to keuangan:", error));

            // Audit Logs (only load a limited number, client-side filtering by retention)
            onSnapshot(query(collection(db, "auditLogs")), (snapshot) => {
              App.data.auditLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              // Sort by timestamp descending
              App.data.auditLogs.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
              console.log("Audit Logs updated:", App.data.auditLogs.length);
              App.renderAuditLogsTable();
            }, (error) => console.error("Error listening to auditLogs:", error));
          },

          init() {
            // Dark mode toggle
            const darkModeToggle = document.getElementById("darkModeToggle");
            const prefersDarkScheme = window.matchMedia("(prefers-color-scheme: dark)");

            const currentTheme = localStorage.getItem("theme");
            if (currentTheme === "dark") {
              document.documentElement.classList.add("dark");
              darkModeToggle.checked = true;
            } else if (currentTheme === "light") {
              document.documentElement.classList.remove("dark");
              darkModeToggle.checked = false;
            } else if (prefersDarkScheme.matches) {
              document.documentElement.classList.add("dark");
              darkModeToggle.checked = true;
            }

            darkModeToggle.addEventListener("change", () => {
              if (darkModeToggle.checked) {
                document.documentElement.classList.add("dark");
                localStorage.setItem("theme", "dark");
              } else {
                document.documentElement.classList.remove("dark");
                localStorage.setItem("theme", "light");
              }
              // Re-render chart for theme color update
              App.renderDemografiChart();
            });

            // Navigasi Sidebar
            document.querySelectorAll(".sidebar-link").forEach((link) => {
              link.addEventListener("click", (e) => {
                e.preventDefault();
                document.querySelectorAll(".sidebar-link").forEach((item) => item.classList.remove("active"));
                e.currentTarget.classList.add("active");

                const targetModule = e.currentTarget.getAttribute("href").substring(1);
                App.switchModule(targetModule);
              });
            });

            // Handle Login Form Submission
            adminLoginForm.addEventListener("submit", async (e) => {
              e.preventDefault();
              const email = document.getElementById("loginEmail").value;
              const password = document.getElementById("loginPassword").value;
              await App.authenticate(email, password);
            });

            // Handle Register Form Submission
            adminRegisterForm.addEventListener("submit", async (e) => {
              e.preventDefault();
              const email = document.getElementById("registerEmail").value;
              const password = document.getElementById("registerPassword").value;
              const confirmPassword = document.getElementById("registerConfirmPassword").value;

              if (password.length < 6) {
                registerError.textContent = "Kata sandi minimal harus 6 karakter.";
                registerError.classList.remove("hidden");
                App.showToast("fas fa-exclamation-circle", "text-yellow-500", "Kata sandi terlalu pendek!");
                return;
              }
              if (password !== confirmPassword) {
                registerError.textContent = "Konfirmasi kata sandi tidak cocok.";
                registerError.classList.remove("hidden");
                App.showToast("fas fa-exclamation-circle", "text-yellow-500", "Kata sandi tidak cocok!");
                return;
              }
              await App.registerUser(email, password);
            });

            // Toggle between Login and Register forms
            showRegisterModalLink.addEventListener("click", (e) => {
              e.preventDefault();
              loginForm.classList.add("hidden");
              registerModal.classList.remove("hidden");
              registerError.classList.add("hidden");
              adminRegisterForm.reset();
            });

            showLoginModalLink.addEventListener("click", (e) => {
              e.preventDefault();
              registerModal.classList.add("hidden");
              loginForm.classList.remove("hidden");
              loginError.classList.add("hidden");
              adminLoginForm.reset();
            });

            // Handle Logout Button
            logoutButton.addEventListener("click", async () => {
              await App.logout();
            });

            // Listener untuk Auth State Changes
            onAuthStateChanged(auth, async (user) => {
              if (user) {
                console.log("User is signed in:", user.email, user.uid);
                App.isAuthReady = true;
                loginForm.classList.add("hidden");
                registerModal.classList.add("hidden");
                appContent.classList.remove("hidden");
                App.setupFirestoreListeners(); // Start listening to data after user is authenticated
                App.showToast("fas fa-user-check", "text-blue-500", `Selamat datang, ${user.email.split("@")[0]}!`);
              } else {
                console.log("User is signed out.");
                App.isAuthReady = false;
                loginForm.classList.remove("hidden");
                appContent.classList.add("hidden");
                loginError.classList.add("hidden");
                // Clear all data when user logs out
                App.data = {
                  warga: [], surat: [], tanah: [], kegiatan: [], keuangan: [], auditLogs: [],
                  pengaturan: { namaDesa: "", alamatDesa: "", teleponDesa: "", emailDesa: "", admins: [], paginationLimit: 10, auditLogRetention: 90, }
                };
                // Destroy chart instances to prevent errors
                for (const chartId in App.chartInstances) {
                  if (App.chartInstances[chartId]) {
                    App.chartInstances[chartId].destroy();
                    App.chartInstances[chartId] = null;
                  }
                }
              }
            });

            const initialModule = window.location.hash ? window.location.hash.substring(1) : "dashboard";
            App.switchModule(initialModule);

            // Hide all modals when clicking outside or on close buttons
            document.querySelectorAll(".modal-backdrop").forEach((modal) => {
              modal.addEventListener("click", (e) => {
                if (e.target === modal || e.target.closest("button[id^='close']")) {
                  modal.classList.add("hidden");
                }
              });
            });

            // Warga Module Event Listeners
            document.getElementById("tambahWargaBtn").addEventListener("click", () => App.showWargaModal());
            document.getElementById("wargaForm").addEventListener("submit", (e) => {
              e.preventDefault();
              App.saveWarga();
            });
            document.getElementById("filterStatus").addEventListener("change", () => App.renderWargaTable());
            document.getElementById("filterGender").addEventListener("change", () => App.renderWargaTable());
            document.getElementById("searchWarga").addEventListener("input", () => App.renderWargaTable());
            document.getElementById("selectAllWarga").addEventListener("change", App.toggleSelectAllWarga);
            document.getElementById("hapusWargaTerpilihBtn").addEventListener("click", App.deleteSelectedWarga);
            document.getElementById("exportWargaBtn").addEventListener("click", () => App.exportToExcel("warga", "Data Warga Desa"));
            document.getElementById("importWargaInput").addEventListener("change", (e) => App.importFromExcel(e, "warga"));
            document.getElementById("prevWargaPage").addEventListener("click", () => App.changeWargaPage(-1));
            document.getElementById("nextWargaPage").addEventListener("click", () => App.changeWargaPage(1));

            // Surat Module Event Listeners
            document.getElementById("tambahSuratBtn").addEventListener("click", () => App.showSuratModal());
            document.getElementById("suratForm").addEventListener("submit", (e) => {
              e.preventDefault();
              App.saveSurat();
            });
            document.getElementById("filterJenisSurat").addEventListener("change", () => App.renderSuratTable());
            document.getElementById("filterStatusSurat").addEventListener("change", () => App.renderSuratTable());
            document.getElementById("searchSurat").addEventListener("input", () => App.renderSuratTable());
            document.getElementById("prevSuratPage").addEventListener("click", () => App.changeSuratPage(-1));
            document.getElementById("nextSuratPage").addEventListener("click", () => App.changeSuratPage(1));

            // Tanah Module Event Listeners
            document.getElementById("tambahTanahBtn").addEventListener("click", () => App.showTanahModal());
            document.getElementById("tanahForm").addEventListener("submit", (e) => {
              e.preventDefault();
              App.saveTanah();
            });
            document.getElementById("filterJenisSertifikat").addEventListener("change", () => App.renderTanahTable());
            document.getElementById("searchTanah").addEventListener("input", () => App.renderTanahTable());
            document.getElementById("prevTanahPage").addEventListener("click", () => App.changeTanahPage(-1));
            document.getElementById("nextTanahPage").addEventListener("click", () => App.changeTanahPage(1));

            // Kegiatan Module Event Listeners
            document.getElementById("tambahKegiatanBtn").addEventListener("click", () => App.showKegiatanModal());
            document.getElementById("kegiatanForm").addEventListener("submit", (e) => {
              e.preventDefault();
              App.saveKegiatan();
            });
            document.getElementById("filterStatusKegiatan").addEventListener("change", () => App.renderKegiatanTable());
            document.getElementById("searchKegiatan").addEventListener("input", () => App.renderKegiatanTable());
            document.getElementById("prevKegiatanPage").addEventListener("click", () => App.changeKegiatanPage(-1));
            document.getElementById("nextKegiatanPage").addEventListener("click", () => App.changeKegiatanPage(1));

            // Keuangan Module Event Listeners
            document.getElementById("tambahPemasukanBtn").addEventListener("click", () => App.showKeuanganModal("Pemasukan"));
            document.getElementById("tambahPengeluaranBtn").addEventListener("click", () => App.showKeuanganModal("Pengeluaran"));
            document.getElementById("keuanganForm").addEventListener("submit", (e) => {
              e.preventDefault();
              App.saveKeuangan();
            });
            document.getElementById("filterJenisTransaksi").addEventListener("change", () => App.renderKeuanganTable());
            document.getElementById("filterBulanTahun").addEventListener("change", () => App.renderKeuanganTable());
            document.getElementById("searchKeuangan").addEventListener("input", () => App.renderKeuanganTable());
            document.getElementById("prevKeuanganPage").addEventListener("click", () => App.changeKeuanganPage(-1));
            document.getElementById("nextKeuanganPage").addEventListener("click", () => App.changeKeuanganPage(1));

            // Pengaturan Module Event Listeners
            document.getElementById("desaInfoForm").addEventListener("submit", (e) => {
              e.preventDefault();
              App.savePengaturanDesa();
            });
            document.getElementById("addAdminBtn").addEventListener("click", async () => {
              const adminEmailInput = document.getElementById("adminEmail");
              const email = adminEmailInput.value.trim();
              const tempPassword = "password123"; // Password sementara, TIDAK AMAN UNTUK PRODUKSI NYATA!

              if (!email || !email.includes("@")) {
                addAdminError.textContent = "Mohon masukkan email yang valid.";
                addAdminError.classList.remove("hidden");
                App.showToast("fas fa-exclamation-circle", "text-yellow-500", "Email tidak valid.");
                return;
              }

              addAdminError.classList.add("hidden");
              try {
                // Mencoba membuat user baru di Auth
                const userCredential = await createUserWithEmailAndPassword(auth, email, tempPassword);

                // Tambahkan user baru ke koleksi 'users'
                await setDoc(doc(db, "users", userCredential.user.uid), {
                  email: userCredential.user.email,
                  displayName: userCredential.user.email.split("@")[0],
                  role: "admin",
                  createdAt: serverTimestamp(),
                  lastLoginAt: serverTimestamp(),
                });

                // Update daftar admin di pengaturan
                const settingsRef = doc(db, "pengaturan", "desaSettings");
                const settingsSnap = await getDoc(settingsRef);
                let currentAdmins = [];
                if (settingsSnap.exists()) {
                  currentAdmins = settingsSnap.data().admins || [];
                }
                if (!currentAdmins.some(admin => admin.email === email)) {
                  currentAdmins.push({ email: email, uid: userCredential.user.uid });
                  await setDoc(settingsRef, { admins: currentAdmins }, { merge: true });
                }

                App.addAuditLog(`Menambah admin baru: ${email}`);
                App.showToast("fas fa-check-circle", "text-green-500", `Admin ${email} berhasil ditambahkan!`);
                adminEmailInput.value = "";
                App.renderAdminList();
              } catch (error) {
                console.error("Error adding new admin:", error.message);
                let errorMessage = `Gagal menambah admin: ${error.message}`;
                if (error.code === "auth/email-already-in-use") {
                  errorMessage = "Email ini sudah terdaftar sebagai pengguna. Tidak dapat menambahkan lagi.";
                  App.showToast("fas fa-info-circle", "text-blue-500", "Email sudah terdaftar!");
                } else {
                  App.showToast("fas fa-times-circle", "text-red-500", `Gagal menambah admin: ${error.message}`);
                }
                addAdminError.textContent = errorMessage;
                addAdminError.classList.remove("hidden");
              }
            });


            document.getElementById("savePengaturanLainnyaBtn").addEventListener("click", App.saveOtherSettings);
          },

          // Utility Functions
          switchModule(module) {
            App.currentModule = module;
            document.querySelectorAll(".module-content").forEach((content) => {
              content.classList.add("hidden");
            });
            document.getElementById(module).classList.remove("hidden");
            document.getElementById("currentModuleTitle").textContent = module.charAt(0).toUpperCase() + module.slice(1);
            // No need to re-render here, onSnapshot will handle it
          },

          generateUniqueId() {
            return doc(collection(db, "temp")).id; // Use Firestore's ID generator for consistency
          },

          formatDate(dateInput) {
            if (!dateInput) return "";
            let date;
            if (dateInput instanceof Date) {
                date = dateInput;
            } else if (typeof dateInput === 'string') {
                date = new Date(dateInput);
            } else if (dateInput && typeof dateInput.toDate === 'function') { // Firestore Timestamp
                date = dateInput.toDate();
            } else {
                return ""; // Invalid date format
            }

            return date.toLocaleDateString("id-ID", { year: "numeric", month: "long", day: "numeric" });
          },

          formatCurrency(amount) {
            return new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR", minimumFractionDigits: 0 }).format(amount);
          },

          // --- CRUD Operations ---
          // Warga
          showWargaModal(wargaId = null) {
            const modal = document.getElementById("wargaModal");
            const title = document.getElementById("wargaModalTitle");
            const form = document.getElementById("wargaForm");
            form.reset();
            document.getElementById("fotoWargaPreviewContainer").innerHTML = "";

            if (wargaId) {
              title.textContent = "Edit Data Warga";
              const warga = App.data.warga.find((w) => w.id === wargaId);
              if (warga) {
                document.getElementById("wargaId").value = warga.id;
                document.getElementById("nikWarga").value = warga.nik;
                document.getElementById("namaLengkap").value = warga.namaLengkap;
                document.getElementById("tempatLahir").value = warga.tempatLahir;
                document.getElementById("tanggalLahir").value = warga.tanggalLahir?.split("T")[0] || ""; // For date input compatibility
                document.getElementById("jenisKelamin").value = warga.jenisKelamin;
                document.getElementById("agama").value = warga.agama;
                document.getElementById("statusPerkawinan").value = warga.statusPerkawinan;
                document.getElementById("pekerjaan").value = warga.pekerjaan;
                document.getElementById("pendidikanTerakhir").value = warga.pendidikanTerakhir;
                document.getElementById("alamat").value = warga.alamat;
                document.getElementById("statusWarga").value = warga.statusKependudukan; // Match DB field name
                if (warga.fotoUrl) {
                  const img = document.createElement("img");
                  img.src = warga.fotoUrl;
                  img.className = "w-24 h-24 object-cover rounded-md shadow";
                  document.getElementById("fotoWargaPreviewContainer").appendChild(img);
                }
              }
            } else {
              title.textContent = "Tambah Warga Baru";
              document.getElementById("wargaId").value = "";
            }
            modal.classList.remove("hidden");
          },

          async saveWarga() {
            const id = document.getElementById("wargaId").value;
            const nik = document.getElementById("nikWarga").value;
            const namaLengkap = document.getElementById("namaLengkap").value;
            const tempatLahir = document.getElementById("tempatLahir").value;
            const tanggalLahir = document.getElementById("tanggalLahir").value;
            const jenisKelamin = document.getElementById("jenisKelamin").value;
            const agama = document.getElementById("agama").value;
            const statusPerkawinan = document.getElementById("statusPerkawinan").value;
            const pekerjaan = document.getElementById("pekerjaan").value;
            const pendidikanTerakhir = document.getElementById("pendidikanTerakhir").value;
            const alamat = document.getElementById("alamat").value;
            const statusKependudukan = document.getElementById("statusWarga").value;
            const fotoFile = document.getElementById("fotoWarga").files[0];

            let fotoUrl = "";
            if (id) {
                const existingWarga = App.data.warga.find((w) => w.id === id);
                if (existingWarga) fotoUrl = existingWarga.fotoUrl || "";
            }

            if (fotoFile) {
                if (fotoUrl) await App.deleteFile(fotoUrl); // Delete old photo if exists
                fotoUrl = await App.uploadFile(fotoFile, `warga_photos/${nik}_${Date.now()}_${fotoFile.name}`);
            }

            const wargaData = {
              nik, namaLengkap, tempatLahir, tanggalLahir, jenisKelamin, agama,
              statusPerkawinan, pekerjaan, pendidikanTerakhir, alamat, statusKependudukan,
              fotoUrl: fotoUrl || null, // Ensure fotoUrl is saved
            };

            if (id) {
              await App.saveDataToFirestore("warga", id, wargaData);
              App.addAuditLog(`Mengedit data warga ${namaLengkap} (NIK: ${nik})`);
              App.showToast("fas fa-check-circle", "text-green-500", "Data warga berhasil diperbarui!");
            } else {
              const newId = await App.addDataToFirestore("warga", wargaData);
              if (newId) {
                  App.addAuditLog(`Menambah warga baru ${namaLengkap} (NIK: ${nik})`);
                  App.showToast("fas fa-check-circle", "text-green-500", "Warga baru berhasil ditambahkan!");
              }
            }
            document.getElementById("wargaModal").classList.add("hidden");
          },

          renderWargaTable() {
            const tableBody = document.getElementById("wargaTableBody");
            tableBody.innerHTML = "";

            let filteredWarga = App.data.warga;

            const filterStatus = document.getElementById("filterStatus").value;
            if (filterStatus) {
              filteredWarga = filteredWarga.filter((w) => w.statusKependudukan === filterStatus);
            }

            const filterGender = document.getElementById("filterGender").value;
            if (filterGender) {
              filteredWarga = filteredWarga.filter((w) => w.jenisKelamin === filterGender);
            }

            const searchWarga = document.getElementById("searchWarga").value.toLowerCase();
            if (searchWarga) {
              filteredWarga = filteredWarga.filter((w) => w.namaLengkap.toLowerCase().includes(searchWarga) || w.nik.includes(searchWarga));
            }

            const limit = App.data.pengaturan.paginationLimit;
            const startIndex = (App.currentPage.warga - 1) * limit;
            const paginatedWarga = filteredWarga.slice(startIndex, startIndex + limit);

            if (paginatedWarga.length === 0) {
              tableBody.innerHTML = `<tr><td colspan="6" class="py-4 px-4 text-center text-gray-500 dark:text-gray-400">Tidak ada data warga yang ditemukan.</td></tr>`;
              document.getElementById("prevWargaPage").disabled = true;
              document.getElementById("nextWargaPage").disabled = true;
            } else {
              paginatedWarga.forEach((warga) => {
                const row = tableBody.insertRow();
                row.className = "hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150";
                row.innerHTML = `
                  <td class="py-3 px-4 whitespace-nowrap"><input type="checkbox" class="warga-checkbox" data-id="${warga.id}"></td>
                  <td class="py-3 px-4 whitespace-nowrap">
                    <img src="${warga.fotoUrl || "https://placehold.co/50x50/374151/e2e8f0?text=NF"}" alt="Foto" class="w-10 h-10 rounded-full object-cover">
                  </td>
                  <td class="py-3 px-4 font-medium text-gray-900 dark:text-gray-100">${warga.namaLengkap}</td>
                  <td class="py-3 px-4 text-gray-700 dark:text-gray-300 ocr-font">${warga.nik}</td>
                  <td class="py-3 px-4">${App.getStatusBadge(warga.statusKependudukan)}</td>
                  <td class="py-3 px-4 whitespace-nowrap">
                    <button onclick="App.showDetailWargaModal('${warga.id}')" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 mr-2"><i class="fas fa-eye"></i></button>
                    <button onclick="App.showWargaModal('${warga.id}')" class="text-yellow-600 hover:text-yellow-800 dark:text-yellow-400 dark:hover:text-yellow-300 mr-2"><i class="fas fa-edit"></i></button>
                    <button onclick="App.deleteWarga('${warga.id}', '${warga.namaLengkap}', '${warga.fotoUrl || ''}')" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300"><i class="fas fa-trash-alt"></i></button>
                  </td>
                `;
              });
              document.getElementById("prevWargaPage").disabled = App.currentPage.warga === 1;
              document.getElementById("nextWargaPage").disabled = startIndex + limit >= filteredWarga.length;
              document.getElementById("currentPageWarga").textContent = `Halaman ${App.currentPage.warga}`;
            }
          },

          showDetailWargaModal(wargaId) {
            const modal = document.getElementById("detailWargaModal");
            const warga = App.data.warga.find((w) => w.id === wargaId);
            if (warga) {
              document.getElementById("detailFotoWarga").src = warga.fotoUrl || "https://placehold.co/150x150/374151/e2e8f0?text=NF";
              document.getElementById("detailNamaLengkap").textContent = warga.namaLengkap;
              document.getElementById("detailNIK").textContent = warga.nik;
              document.getElementById("detailTTL").textContent = `${warga.tempatLahir}, ${App.formatDate(warga.tanggalLahir)}`;
              document.getElementById("detailJenisKelamin").textContent = warga.jenisKelamin;
              document.getElementById("detailAgama").textContent = warga.agama;
              document.getElementById("detailStatusPerkawinan").textContent = warga.statusPerkawinan;
              document.getElementById("detailPekerjaan").textContent = warga.pekerjaan;
              document.getElementById("detailPendidikanTerakhir").textContent = warga.pendidikanTerakhir;
              document.getElementById("detailAlamat").textContent = warga.alamat;
              document.getElementById("detailStatusWarga").innerHTML = App.getStatusBadge(warga.statusKependudukan);
            }
            modal.classList.remove("hidden");
          },

          deleteWarga(id, nama, fotoUrl) {
            App.showConfirmModal(`Anda yakin ingin menghapus data warga ${nama}?`, async () => {
              await App.deleteDataFromFirestore("warga", id);
              if (fotoUrl) await App.deleteFile(fotoUrl);
              App.addAuditLog(`Menghapus data warga ${nama} (ID: ${id})`);
              App.showToast("fas fa-check-circle", "text-green-500", "Data warga berhasil dihapus!");
            });
          },

          toggleSelectAllWarga(event) {
            document.querySelectorAll(".warga-checkbox").forEach((checkbox) => {
              checkbox.checked = event.target.checked;
            });
          },

          deleteSelectedWarga() {
            const selectedIds = Array.from(document.querySelectorAll(".warga-checkbox:checked")).map((checkbox) => checkbox.dataset.id);

            if (selectedIds.length === 0) {
              App.showToast("fas fa-info-circle", "text-blue-500", "Tidak ada warga yang dipilih untuk dihapus.");
              return;
            }

            App.showConfirmModal(`Anda yakin ingin menghapus ${selectedIds.length} data warga yang terpilih?`, async () => {
              for (const id of selectedIds) {
                  const wargaToDelete = App.data.warga.find(w => w.id === id);
                  if (wargaToDelete) {
                      await App.deleteDataFromFirestore("warga", id);
                      if (wargaToDelete.fotoUrl) await App.deleteFile(wargaToDelete.fotoUrl);
                  }
              }
              App.addAuditLog(`Menghapus ${selectedIds.length} data warga terpilih`);
              App.showToast("fas fa-check-circle", "text-green-500", `${selectedIds.length} data warga berhasil dihapus!`);
              document.getElementById("selectAllWarga").checked = false;
            });
          },

          changeWargaPage(direction) {
            App.currentPage.warga += direction;
            App.renderWargaTable();
          },

          // Surat
          showSuratModal(suratId = null) {
            const modal = document.getElementById("suratModal");
            const title = document.getElementById("suratModalTitle");
            const form = document.getElementById("suratForm");
            form.reset();
            document.getElementById("lampiranSuratPreviewContainer").innerHTML = "";

            if (suratId) {
              title.textContent = "Edit Data Surat";
              const surat = App.data.surat.find((s) => s.id === suratId);
              if (surat) {
                document.getElementById("suratId").value = surat.id;
                document.getElementById("noSurat").value = surat.nomorSurat;
                document.getElementById("jenisSurat").value = surat.jenisSurat;
                document.getElementById("namaPemohon").value = surat.namaPemohon; // Note: This should ideally link to warga.namaLengkap
                document.getElementById("tanggalPengajuan").value = surat.tanggalPengajuan?.split("T")[0] || "";
                document.getElementById("statusSurat").value = surat.status;
                document.getElementById("keteranganSurat").value = surat.keterangan;
                if (surat.fileSuratUrl) {
                  const link = document.createElement("a");
                  link.href = surat.fileSuratUrl;
                  link.textContent = "Lihat Lampiran";
                  link.target = "_blank";
                  link.className = "text-blue-500 hover:underline mr-2";
                  document.getElementById("lampiranSuratPreviewContainer").appendChild(link);
                }
              }
            } else {
              title.textContent = "Buat Surat Baru";
              document.getElementById("suratId").value = "";
              document.getElementById("noSurat").value = App.generateNomorSurat();
              document.getElementById("tanggalPengajuan").valueAsDate = new Date();
            }
            modal.classList.remove("hidden");
          },

          async saveSurat() {
            const id = document.getElementById("suratId").value;
            const nomorSurat = document.getElementById("noSurat").value;
            const jenisSurat = document.getElementById("jenisSurat").value;
            const namaPemohon = document.getElementById("namaPemohon").value;
            const tanggalPengajuan = document.getElementById("tanggalPengajuan").value;
            const status = document.getElementById("statusSurat").value;
            const keterangan = document.getElementById("keteranganSurat").value;
            const lampiranFile = document.getElementById("lampiranSurat").files[0];

            let fileSuratUrl = "";
            if (id) {
                const existingSurat = App.data.surat.find((s) => s.id === id);
                if (existingSurat) fileSuratUrl = existingSurat.fileSuratUrl || "";
            }

            if (lampiranFile) {
                if (fileSuratUrl) await App.deleteFile(fileSuratUrl);
                fileSuratUrl = await App.uploadFile(lampiranFile, `surat_attachments/${nomorSurat}_${Date.now()}_${lampiranFile.name}`);
            }

            const suratData = {
              nomorSurat, jenisSurat, namaPemohon, tanggalPengajuan, status, keterangan,
              fileSuratUrl: fileSuratUrl || null,
              issuedBy: auth.currentUser ? auth.currentUser.uid : "anonim",
            };

            if (id) {
              await App.saveDataToFirestore("surat", id, suratData);
              App.addAuditLog(`Mengedit surat ${nomorSurat} (${jenisSurat})`);
              App.showToast("fas fa-check-circle", "text-green-500", "Data surat berhasil diperbarui!");
            } else {
              const newId = await App.addDataToFirestore("surat", suratData);
              if (newId) {
                  App.addAuditLog(`Menambah surat baru ${nomorSurat} (${jenisSurat})`);
                  App.showToast("fas fa-check-circle", "text-green-500", "Surat baru berhasil ditambahkan!");
              }
            }
            document.getElementById("suratModal").classList.add("hidden");
          },

          deleteSurat(id, noSurat, fileUrl) {
            App.showConfirmModal(`Anda yakin ingin menghapus surat ${noSurat}?`, async () => {
              await App.deleteDataFromFirestore("surat", id);
              if (fileUrl) await App.deleteFile(fileUrl);
              App.addAuditLog(`Menghapus surat ${noSurat} (ID: ${id})`);
              App.showToast("fas fa-check-circle", "text-green-500", "Data surat berhasil dihapus!");
            });
          },

          renderSuratTable() {
            const tableBody = document.getElementById("suratTableBody");
            tableBody.innerHTML = "";

            let filteredSurat = App.data.surat;

            const filterJenisSurat = document.getElementById("filterJenisSurat").value;
            if (filterJenisSurat) {
              filteredSurat = filteredSurat.filter((s) => s.jenisSurat === filterJenisSurat);
            }

            const filterStatusSurat = document.getElementById("filterStatusSurat").value;
            if (filterStatusSurat) {
              filteredSurat = filteredSurat.filter((s) => s.status === filterStatusSurat);
            }

            const searchSurat = document.getElementById("searchSurat").value.toLowerCase();
            if (searchSurat) {
              filteredSurat = filteredSurat.filter((s) => s.nomorSurat.toLowerCase().includes(searchSurat) || s.namaPemohon.toLowerCase().includes(searchSurat));
            }

            filteredSurat.sort((a, b) => (b.tanggalPengajuan?.toDate() || new Date(b.tanggalPengajuan)) - (a.tanggalPengajuan?.toDate() || new Date(a.tanggalPengajuan)));

            const limit = App.data.pengaturan.paginationLimit;
            const startIndex = (App.currentPage.surat - 1) * limit;
            const paginatedSurat = filteredSurat.slice(startIndex, startIndex + limit);

            if (paginatedSurat.length === 0) {
              tableBody.innerHTML = `<tr><td colspan="6" class="py-4 px-4 text-center text-gray-500 dark:text-gray-400">Tidak ada data surat yang ditemukan.</td></tr>`;
              document.getElementById("prevSuratPage").disabled = true;
              document.getElementById("nextSuratPage").disabled = true;
            } else {
              paginatedSurat.forEach((surat) => {
                const row = tableBody.insertRow();
                row.className = "hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150";
                row.innerHTML = `
                  <td class="py-3 px-4 font-medium text-gray-900 dark:text-gray-100">${surat.nomorSurat}</td>
                  <td class="py-3 px-4 text-gray-700 dark:text-gray-300">${surat.jenisSurat}</td>
                  <td class="py-3 px-4 text-gray-700 dark:text-gray-300">${surat.namaPemohon}</td>
                  <td class="py-3 px-4 text-gray-700 dark:text-gray-300">${App.formatDate(surat.tanggalPengajuan)}</td>
                  <td class="py-3 px-4">${App.getStatusBadge(surat.status)}</td>
                  <td class="py-3 px-4 whitespace-nowrap">
                    <button onclick="App.showSuratModal('${surat.id}')" class="text-yellow-600 hover:text-yellow-800 dark:text-yellow-400 dark:hover:text-yellow-300 mr-2"><i class="fas fa-edit"></i></button>
                    <button onclick="App.deleteSurat('${surat.id}', '${surat.nomorSurat}', '${surat.fileSuratUrl || ''}')" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300"><i class="fas fa-trash-alt"></i></button>
                    ${surat.fileSuratUrl ? `<a href="${surat.fileSuratUrl}" target="_blank" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 ml-2"><i class="fas fa-file-pdf"></i></a>` : ""}
                  </td>
                `;
              });
              document.getElementById("prevSuratPage").disabled = App.currentPage.surat === 1;
              document.getElementById("nextSuratPage").disabled = startIndex + limit >= filteredSurat.length;
              document.getElementById("currentPageSurat").textContent = `Halaman ${App.currentPage.surat}`;
            }
          },

          changeSuratPage(direction) {
            App.currentPage.surat += direction;
            App.renderSuratTable();
          },

          generateNomorSurat() {
            const date = new Date();
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, "0");
            const day = date.getDate().toString().padStart(2, "0");
            const counter = App.data.surat.length + 1; // Simple counter, for production consider a counter in Firestore
            return `SK/DD-${year}${month}${day}-${counter.toString().padStart(3, "0")}`;
          },

          // Tanah
          showTanahModal(tanahId = null) {
            const modal = document.getElementById("tanahModal");
            const title = document.getElementById("tanahModalTitle");
            const form = document.getElementById("tanahForm");
            form.reset();

            if (tanahId) {
              title.textContent = "Edit Data Tanah";
              const tanah = App.data.tanah.find((t) => t.id === tanahId);
              if (tanah) {
                document.getElementById("tanahId").value = tanah.id;
                document.getElementById("noSertifikat").value = tanah.nomorSertifikat;
                document.getElementById("pemilikTanah").value = tanah.pemilikTanah; // This should ideally link to warga.namaLengkap
                document.getElementById("luasTanah").value = tanah.luas;
                document.getElementById("jenisSertifikat").value = tanah.jenisSertifikat;
                document.getElementById("lokasiTanah").value = tanah.lokasi;
                document.getElementById("batasUtara").value = tanah.batasUtara;
                document.getElementById("batasSelatan").value = tanah.batasSelatan;
                document.getElementById("batasTimur").value = tanah.batasTimur;
                document.getElementById("batasBarat").value = tanah.batasBarat;
              }
            } else {
              title.textContent = "Tambah Data Tanah Baru";
              document.getElementById("tanahId").value = "";
            }
            modal.classList.remove("hidden");
          },

          async saveTanah() {
            const id = document.getElementById("tanahId").value;
            const nomorSertifikat = document.getElementById("noSertifikat").value;
            const pemilikTanah = document.getElementById("pemilikTanah").value;
            const luas = parseFloat(document.getElementById("luasTanah").value);
            const jenisSertifikat = document.getElementById("jenisSertifikat").value;
            const lokasi = document.getElementById("lokasiTanah").value;
            const batasUtara = document.getElementById("batasUtara").value;
            const batasSelatan = document.getElementById("batasSelatan").value;
            const batasTimur = document.getElementById("batasTimur").value;
            const batasBarat = document.getElementById("batasBarat").value;

            const tanahData = {
              nomorSertifikat, pemilikTanah, luas, jenisSertifikat, lokasi,
              batasUtara, batasSelatan, batasTimur, batasBarat,
            };

            if (id) {
              await App.saveDataToFirestore("tanah", id, tanahData);
              App.addAuditLog(`Mengedit data tanah ${nomorSertifikat} (Pemilik: ${pemilikTanah})`);
              App.showToast("fas fa-check-circle", "text-green-500", "Data tanah berhasil diperbarui!");
            } else {
              const newId = await App.addDataToFirestore("tanah", tanahData);
              if (newId) {
                  App.addAuditLog(`Menambah data tanah baru ${nomorSertifikat} (Pemilik: ${pemilikTanah})`);
                  App.showToast("fas fa-check-circle", "text-green-500", "Data tanah baru berhasil ditambahkan!");
              }
            }
            document.getElementById("tanahModal").classList.add("hidden");
          },

          deleteTanah(id, noSertifikat) {
            App.showConfirmModal(`Anda yakin ingin menghapus data tanah ${noSertifikat}?`, async () => {
              await App.deleteDataFromFirestore("tanah", id);
              App.addAuditLog(`Menghapus data tanah ${noSertifikat} (ID: ${id})`);
              App.showToast("fas fa-check-circle", "text-green-500", "Data tanah berhasil dihapus!");
            });
          },

          renderTanahTable() {
            const tableBody = document.getElementById("tanahTableBody");
            tableBody.innerHTML = "";

            let filteredTanah = App.data.tanah;

            const filterJenisSertifikat = document.getElementById("filterJenisSertifikat").value;
            if (filterJenisSertifikat) {
              filteredTanah = filteredTanah.filter((t) => t.jenisSertifikat === filterJenisSertifikat);
            }

            const searchTanah = document.getElementById("searchTanah").value.toLowerCase();
            if (searchTanah) {
              filteredTanah = filteredTanah.filter((t) => t.nomorSertifikat.toLowerCase().includes(searchTanah) || t.pemilikTanah.toLowerCase().includes(searchTanah));
            }

            const limit = App.data.pengaturan.paginationLimit;
            const startIndex = (App.currentPage.tanah - 1) * limit;
            const paginatedTanah = filteredTanah.slice(startIndex, startIndex + limit);

            if (paginatedTanah.length === 0) {
              tableBody.innerHTML = `<tr><td colspan="6" class="py-4 px-4 text-center text-gray-500 dark:text-gray-400">Tidak ada data tanah yang ditemukan.</td></tr>`;
              document.getElementById("prevTanahPage").disabled = true;
              document.getElementById("nextTanahPage").disabled = true;
            } else {
              paginatedTanah.forEach((tanah) => {
                const row = tableBody.insertRow();
                row.className = "hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150";
                row.innerHTML = `
                  <td class="py-3 px-4 font-medium text-gray-900 dark:text-gray-100">${tanah.nomorSertifikat}</td>
                  <td class="py-3 px-4 text-gray-700 dark:text-gray-300">${tanah.pemilikTanah}</td>
                  <td class="py-3 px-4 text-gray-700 dark:text-gray-300">${tanah.luas} m²</td>
                  <td class="py-3 px-4 text-gray-700 dark:text-gray-300">${tanah.jenisSertifikat}</td>
                  <td class="py-3 px-4 text-gray-700 dark:text-gray-300">${tanah.lokasi}</td>
                  <td class="py-3 px-4 whitespace-nowrap">
                    <button onclick="App.showTanahModal('${tanah.id}')" class="text-yellow-600 hover:text-yellow-800 dark:text-yellow-400 dark:hover:text-yellow-300 mr-2"><i class="fas fa-edit"></i></button>
                    <button onclick="App.deleteTanah('${tanah.id}', '${tanah.nomorSertifikat}')" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300"><i class="fas fa-trash-alt"></i></button>
                  </td>
                `;
              });
              document.getElementById("prevTanahPage").disabled = App.currentPage.tanah === 1;
              document.getElementById("nextTanahPage").disabled = startIndex + limit >= filteredTanah.length;
              document.getElementById("currentPageTanah").textContent = `Halaman ${App.currentPage.tanah}`;
            }
          },

          changeTanahPage(direction) {
            App.currentPage.tanah += direction;
            App.renderTanahTable();
          },

          // Kegiatan
          showKegiatanModal(kegiatanId = null) {
            const modal = document.getElementById("kegiatanModal");
            const title = document.getElementById("kegiatanModalTitle");
            const form = document.getElementById("kegiatanForm");
            form.reset();

            if (kegiatanId) {
              title.textContent = "Edit Data Kegiatan";
              const kegiatan = App.data.kegiatan.find((k) => k.id === kegiatanId);
              if (kegiatan) {
                document.getElementById("kegiatanId").value = kegiatan.id;
                document.getElementById("namaKegiatan").value = kegiatan.namaKegiatan;
                document.getElementById("deskripsiKegiatan").value = kegiatan.deskripsi;
                document.getElementById("tanggalKegiatan").value = kegiatan.tanggalMulai?.split("T")[0] || ""; // Assuming tanggalMulai for single date
                document.getElementById("lokasiKegiatan").value = kegiatan.lokasi;
                document.getElementById("penanggungJawab").value = kegiatan.penanggungJawabId; // Store ID, display name
                document.getElementById("statusKegiatan").value = kegiatan.status;
              }
            } else {
              title.textContent = "Tambah Kegiatan Baru";
              document.getElementById("kegiatanId").value = "";
              document.getElementById("tanggalKegiatan").valueAsDate = new Date();
            }
            modal.classList.remove("hidden");
          },

          async saveKegiatan() {
            const id = document.getElementById("kegiatanId").value;
            const namaKegiatan = document.getElementById("namaKegiatan").value;
            const deskripsi = document.getElementById("deskripsiKegiatan").value;
            const tanggalMulai = document.getElementById("tanggalKegiatan").value;
            const lokasi = document.getElementById("lokasiKegiatan").value;
            const penanggungJawabId = document.getElementById("penanggungJawab").value;
            const status = document.getElementById("statusKegiatan").value;

            const kegiatanData = {
              namaKegiatan, deskripsi, tanggalMulai, tanggalSelesai: tanggalMulai, // For simplicity, end date same as start
              lokasi, penanggungJawabId, status,
            };

            if (id) {
              await App.saveDataToFirestore("kegiatan", id, kegiatanData);
              App.addAuditLog(`Mengedit kegiatan ${namaKegiatan}`);
              App.showToast("fas fa-check-circle", "text-green-500", "Data kegiatan berhasil diperbarui!");
            } else {
              const newId = await App.addDataToFirestore("kegiatan", kegiatanData);
              if (newId) {
                  App.addAuditLog(`Menambah kegiatan baru ${namaKegiatan}`);
                  App.showToast("fas fa-check-circle", "text-green-500", "Kegiatan baru berhasil ditambahkan!");
              }
            }
            document.getElementById("kegiatanModal").classList.add("hidden");
          },

          deleteKegiatan(id, nama) {
            App.showConfirmModal(`Anda yakin ingin menghapus kegiatan ${nama}?`, async () => {
              await App.deleteDataFromFirestore("kegiatan", id);
              App.addAuditLog(`Menghapus kegiatan ${nama} (ID: ${id})`);
              App.showToast("fas fa-check-circle", "text-green-500", "Data kegiatan berhasil dihapus!");
            });
          },

          renderKegiatanTable() {
            const tableBody = document.getElementById("kegiatanTableBody");
            tableBody.innerHTML = "";

            let filteredKegiatan = App.data.kegiatan;

            const filterStatusKegiatan = document.getElementById("filterStatusKegiatan").value;
            if (filterStatusKegiatan) {
              filteredKegiatan = filteredKegiatan.filter((k) => k.status === filterStatusKegiatan);
            }

            const searchKegiatan = document.getElementById("searchKegiatan").value.toLowerCase();
            if (searchKegiatan) {
              filteredKegiatan = filteredKegiatan.filter((k) => k.namaKegiatan.toLowerCase().includes(searchKegiatan));
            }

            filteredKegiatan.sort((a, b) => (b.tanggalMulai?.toDate() || new Date(b.tanggalMulai)) - (a.tanggalMulai?.toDate() || new Date(a.tanggalMulai)));

            const limit = App.data.pengaturan.paginationLimit;
            const startIndex = (App.currentPage.kegiatan - 1) * limit;
            const paginatedKegiatan = filteredKegiatan.slice(startIndex, startIndex + limit);

            if (paginatedKegiatan.length === 0) {
              tableBody.innerHTML = `<tr><td colspan="5" class="py-4 px-4 text-center text-gray-500 dark:text-gray-400">Tidak ada data kegiatan yang ditemukan.</td></tr>`;
              document.getElementById("prevKegiatanPage").disabled = true;
              document.getElementById("nextKegiatanPage").disabled = true;
            } else {
              paginatedKegiatan.forEach((kegiatan) => {
                const row = tableBody.insertRow();
                row.className = "hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150";
                row.innerHTML = `
                  <td class="py-3 px-4 font-medium text-gray-900 dark:text-gray-100">${kegiatan.namaKegiatan}</td>
                  <td class="py-3 px-4 text-gray-700 dark:text-gray-300">${App.formatDate(kegiatan.tanggalMulai)}</td>
                  <td class="py-3 px-4 text-gray-700 dark:text-gray-300">${kegiatan.lokasi}</td>
                  <td class="py-3 px-4">${App.getStatusBadge(kegiatan.status)}</td>
                  <td class="py-3 px-4 whitespace-nowrap">
                    <button onclick="App.showKegiatanModal('${kegiatan.id}')" class="text-yellow-600 hover:text-yellow-800 dark:text-yellow-400 dark:hover:text-yellow-300 mr-2"><i class="fas fa-edit"></i></button>
                    <button onclick="App.deleteKegiatan('${kegiatan.id}', '${kegiatan.namaKegiatan}')" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300"><i class="fas fa-trash-alt"></i></button>
                  </td>
                `;
              });
              document.getElementById("prevKegiatanPage").disabled = App.currentPage.kegiatan === 1;
              document.getElementById("nextKegiatanPage").disabled = startIndex + limit >= filteredKegiatan.length;
              document.getElementById("currentPageKegiatan").textContent = `Halaman ${App.currentPage.kegiatan}`;
            }
          },

          changeKegiatanPage(direction) {
            App.currentPage.kegiatan += direction;
            App.renderKegiatanTable();
          },

          // Keuangan
          showKeuanganModal(jenis, keuanganId = null) {
            const modal = document.getElementById("keuanganModal");
            const title = document.getElementById("keuanganModalTitle");
            const form = document.getElementById("keuanganForm");
            form.reset();
            document.getElementById("keuanganJenis").value = jenis;

            if (keuanganId) {
              title.textContent = `Edit Transaksi ${jenis}`;
              const transaksi = App.data.keuangan.find((t) => t.id === keuanganId);
              if (transaksi) {
                document.getElementById("keuanganId").value = transaksi.id;
                document.getElementById("tanggalTransaksi").value = transaksi.tanggal?.split("T")[0] || ""; // Assuming 'tanggal' field
                document.getElementById("deskripsiTransaksi").value = transaksi.deskripsi;
                document.getElementById("jumlahTransaksi").value = transaksi.jumlah;
              }
            } else {
              title.textContent = `Tambah ${jenis}`;
              document.getElementById("keuanganId").value = "";
              document.getElementById("tanggalTransaksi").valueAsDate = new Date();
            }
            modal.classList.remove("hidden");
          },

          async saveKeuangan() {
            const id = document.getElementById("keuanganId").value;
            const jenisTransaksi = document.getElementById("keuanganJenis").value;
            const tanggal = document.getElementById("tanggalTransaksi").value;
            const deskripsi = document.getElementById("deskripsiTransaksi").value;
            const jumlah = parseFloat(document.getElementById("jumlahTransaksi").value);

            const keuanganData = {
              jenisTransaksi, tanggal, deskripsi, jumlah,
              recordedBy: auth.currentUser ? auth.currentUser.uid : "anonim",
            };

            if (id) {
              await App.saveDataToFirestore("keuangan", id, keuanganData);
              App.addAuditLog(`Mengedit transaksi ${jenisTransaksi}: ${deskripsi}`);
              App.showToast("fas fa-check-circle", "text-green-500", "Data transaksi berhasil diperbarui!");
            } else {
              const newId = await App.addDataToFirestore("keuangan", keuanganData);
              if (newId) {
                  App.addAuditLog(`Menambah transaksi ${jenisTransaksi}: ${deskripsi}`);
                  App.showToast("fas fa-check-circle", "text-green-500", "Transaksi baru berhasil ditambahkan!");
              }
            }
            document.getElementById("keuanganModal").classList.add("hidden");
          },

          deleteKeuangan(id, deskripsi) {
            App.showConfirmModal(`Anda yakin ingin menghapus transaksi "${deskripsi}"?`, async () => {
              await App.deleteDataFromFirestore("keuangan", id);
              App.addAuditLog(`Menghapus transaksi: ${deskripsi} (ID: ${id})`);
              App.showToast("fas fa-check-circle", "text-green-500", "Data transaksi berhasil dihapus!");
            });
          },

          renderKeuanganTable() {
            const tableBody = document.getElementById("keuanganTableBody");
            tableBody.innerHTML = "";

            let filteredKeuangan = App.data.keuangan;

            const filterJenisTransaksi = document.getElementById("filterJenisTransaksi").value;
            if (filterJenisTransaksi) {
              filteredKeuangan = filteredKeuangan.filter((t) => t.jenisTransaksi === filterJenisTransaksi);
            }

            const filterBulanTahun = document.getElementById("filterBulanTahun").value;
            if (filterBulanTahun) {
              filteredKeuangan = filteredKeuangan.filter((t) => t.tanggal?.startsWith(filterBulanTahun));
            }

            const searchKeuangan = document.getElementById("searchKeuangan").value.toLowerCase();
            if (searchKeuangan) {
              filteredKeuangan = filteredKeuangan.filter((t) => t.deskripsi.toLowerCase().includes(searchKeuangan));
            }

            filteredKeuangan.sort((a, b) => (b.tanggal?.toDate() || new Date(b.tanggal)) - (a.tanggal?.toDate() || new Date(a.tanggal)));

            const limit = App.data.pengaturan.paginationLimit;
            const startIndex = (App.currentPage.keuangan - 1) * limit;
            const paginatedKeuangan = filteredKeuangan.slice(startIndex, startIndex + limit);

            if (paginatedKeuangan.length === 0) {
              tableBody.innerHTML = `<tr><td colspan="5" class="py-4 px-4 text-center text-gray-500 dark:text-gray-400">Tidak ada data keuangan yang ditemukan.</td></tr>`;
              document.getElementById("prevKeuanganPage").disabled = true;
              document.getElementById("nextKeuanganPage").disabled = true;
            } else {
              paginatedKeuangan.forEach((transaksi) => {
                const row = tableBody.insertRow();
                row.className = "hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150";
                const amountColorClass = transaksi.jenisTransaksi === "Pemasukan" ? "text-green-600 dark:text-green-400" : "text-red-600 dark:text-red-400";
                row.innerHTML = `
                  <td class="py-3 px-4 text-gray-700 dark:text-gray-300">${App.formatDate(transaksi.tanggal)}</td>
                  <td class="py-3 px-4 text-gray-700 dark:text-gray-300">${transaksi.jenisTransaksi}</td>
                  <td class="py-3 px-4 text-gray-700 dark:text-gray-300">${transaksi.deskripsi}</td>
                  <td class="py-3 px-4 font-medium ${amountColorClass}">${App.formatCurrency(transaksi.jumlah)}</td>
                  <td class="py-3 px-4 whitespace-nowrap">
                    <button onclick="App.showKeuanganModal('${transaksi.jenisTransaksi}', '${transaksi.id}')" class="text-yellow-600 hover:text-yellow-800 dark:text-yellow-400 dark:hover:text-yellow-300 mr-2"><i class="fas fa-edit"></i></button>
                    <button onclick="App.deleteKeuangan('${transaksi.id}', '${transaksi.deskripsi}')" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300"><i class="fas fa-trash-alt"></i></button>
                  </td>
                `;
              });
              document.getElementById("prevKeuanganPage").disabled = App.currentPage.keuangan === 1;
              document.getElementById("nextKeuanganPage").disabled = startIndex + limit >= filteredKeuangan.length;
              document.getElementById("currentPageKeuangan").textContent = `Halaman ${App.currentPage.keuangan}`;
            }
            App.updateKeuanganSummary();
          },

          changeKeuanganPage(direction) {
            App.currentPage.keuangan += direction;
            App.renderKeuanganTable();
          },

          updateKeuanganSummary() {
            const totalPemasukan = App.data.keuangan.filter((t) => t.jenisTransaksi === "Pemasukan").reduce((sum, t) => sum + t.jumlah, 0);
            const totalPengeluaran = App.data.keuangan.filter((t) => t.jenisTransaksi === "Pengeluaran").reduce((sum, t) => sum + t.jumlah, 0);
            const saldo = totalPemasukan - totalPengeluaran;

            document.getElementById("totalPemasukan").textContent = App.formatCurrency(totalPemasukan);
            document.getElementById("totalPengeluaran").textContent = App.formatCurrency(totalPengeluaran);
            document.getElementById("saldoKeuangan").textContent = App.formatCurrency(saldo);
          },

          // Pengaturan
          renderPengaturan() {
            const settings = App.data.pengaturan;
            document.getElementById("namaDesa").value = settings.namaDesa || "";
            document.getElementById("alamatDesa").value = settings.alamatDesa || "";
            document.getElementById("teleponDesa").value = settings.teleponDesa || "";
            document.getElementById("emailDesa").value = settings.emailDesa || "";
            document.getElementById("paginationLimit").value = settings.paginationLimit || 10;
            document.getElementById("auditLogRetention").value = settings.auditLogRetention || 90;

            App.renderAdminList();
          },

          async savePengaturanDesa() {
            const namaDesa = document.getElementById("namaDesa").value;
            const alamatDesa = document.getElementById("alamatDesa").value;
            const teleponDesa = document.getElementById("teleponDesa").value;
            const emailDesa = document.getElementById("emailDesa").value;

            const updatedSettings = {
              namaDesa, alamatDesa, teleponDesa, emailDesa
            };

            await App.saveDataToFirestore("pengaturan", "desaSettings", updatedSettings, true);
            App.addAuditLog("Memperbarui informasi desa");
            App.showToast("fas fa-check-circle", "text-green-500", "Informasi desa berhasil disimpan!");
          },

          renderAdminList() {
            const adminList = document.getElementById("adminList");
            adminList.innerHTML = "";
            const currentAuthUserEmail = auth.currentUser ? auth.currentUser.email : null;

            if (App.data.pengaturan.admins && App.data.pengaturan.admins.length > 0) {
              App.data.pengaturan.admins.forEach((admin) => {
                const li = document.createElement("li");
                li.className = "flex justify-between items-center bg-gray-50 dark:bg-gray-700 p-2 rounded-md";
                const isCurrentUser = currentAuthUserEmail === admin.email;
                li.innerHTML = `
                  <span class="text-gray-700 dark:text-gray-300">${admin.email} ${isCurrentUser ? "(Anda)" : ""}</span>
                  <div>
                      ${isCurrentUser ? "" : `<button onclick="App.removeAdmin('${admin.email}')" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 ml-2"><i class="fas fa-trash-alt"></i></button>`}
                  </div>
                `;
                adminList.appendChild(li);
              });
            } else {
              adminList.innerHTML = `<li class="text-gray-500 dark:text-gray-400">Belum ada admin terdaftar.</li>`;
            }
          },

          async removeAdmin(emailToRemove) {
            if (auth.currentUser && auth.currentUser.email === emailToRemove) {
              App.showToast("fas fa-exclamation-circle", "text-red-500", "Anda tidak dapat menghapus akun admin Anda sendiri.");
              return;
            }
            App.showConfirmModal(`Anda yakin ingin menghapus admin ${emailToRemove}? Ini akan menghapusnya dari daftar admin di sini, tetapi akun Firebase Authentication-nya perlu dihapus secara manual atau melalui fungsi Cloud.`, async () => {
              try {
                // Update daftar admin di pengaturan Firestore
                const settingsRef = doc(db, "pengaturan", "desaSettings");
                const settingsSnap = await getDoc(settingsRef);
                let currentAdmins = settingsSnap.exists() ? (settingsSnap.data().admins || []) : [];
                currentAdmins = currentAdmins.filter((admin) => admin.email !== emailToRemove);
                await setDoc(settingsRef, { admins: currentAdmins }, { merge: true });

                App.addAuditLog(`Menghapus admin: ${emailToRemove}`);
                App.showToast("fas fa-check-circle", "text-green-500", `Admin ${emailToRemove} berhasil dihapus dari daftar.`);
                // Note: Actual Firebase Auth user deletion requires Admin SDK (Cloud Functions)
                App.renderAdminList();
              } catch (error) {
                console.error("Error removing admin:", error.message);
                App.showToast("fas fa-times-circle", "text-red-500", `Gagal menghapus admin: ${error.message}`);
              }
            });
          },

          async saveOtherSettings() {
            const paginationLimit = parseInt(document.getElementById("paginationLimit").value);
            const auditLogRetention = parseInt(document.getElementById("auditLogRetention").value);

            const updatedSettings = {
              paginationLimit, auditLogRetention
            };

            await App.saveDataToFirestore("pengaturan", "desaSettings", updatedSettings, true);
            App.addAuditLog("Memperbarui pengaturan aplikasi lainnya");
            App.showToast("fas fa-check-circle", "text-green-500", "Pengaturan lainnya berhasil disimpan!");
          },

          // Dashboard
          renderDashboard() {
            document.getElementById("totalWarga").textContent = App.data.warga.length;
            document.getElementById("totalSurat").textContent = App.data.surat.length;
            document.getElementById("totalKegiatan").textContent = App.data.kegiatan.filter((k) => k.status !== "Selesai" && k.status !== "Dibatalkan").length;
            App.updateKeuanganSummary();

            App.renderDemografiChart();
            App.renderRecentSuratList();
            App.renderAuditLogsTable();
          },

          renderDemografiChart() {
            const ctx = document.getElementById("demografiChart").getContext("2d");
            if (App.chartInstances.demografiChart) {
              App.chartInstances.demografiChart.destroy();
            }

            const genderData = App.data.warga.reduce((acc, warga) => {
              acc[warga.jenisKelamin] = (acc[warga.jenisKelamin] || 0) + 1;
              return acc;
            }, {});

            const isDarkMode = document.documentElement.classList.contains("dark");
            const textColor = isDarkMode ? "#e2e8f0" : "#374151"; // Gray-200 or Gray-800
            const gridColor = isDarkMode ? "rgba(255, 255, 255, 0.1)" : "rgba(0, 0, 0, 0.1)";

            App.chartInstances.demografiChart = new Chart(ctx, {
              type: "pie",
              data: {
                labels: Object.keys(genderData),
                datasets: [
                  {
                    data: Object.values(genderData),
                    backgroundColor: [
                      isDarkMode ? "rgba(129, 140, 248, 0.8)" : "rgba(75, 192, 192, 0.8)", // Indigo-400 / Teal
                      isDarkMode ? "rgba(248, 113, 113, 0.8)" : "rgba(255, 99, 132, 0.8)", // Red-400 / Red
                      isDarkMode ? "rgba(107, 114, 128, 0.8)" : "rgba(200, 200, 200, 0.8)", // Gray-500 / Light Gray
                    ],
                    borderColor: isDarkMode ? "#1a202c" : "#ffffff", // Dark background or White background
                    borderWidth: 2,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: "top",
                    labels: {
                      color: textColor,
                    },
                  },
                },
              },
            });
          },

          renderRecentSuratList() {
            const list = document.getElementById("recentSuratList");
            list.innerHTML = "";
            // Ensure tanggalPengajuan is a valid date for sorting
            const recentSurat = [...App.data.surat].sort((a, b) => {
                const dateA = a.tanggalPengajuan ? (a.tanggalPengajuan.toDate ? a.tanggalPengajuan.toDate() : new Date(a.tanggalPengajuan)) : new Date(0);
                const dateB = b.tanggalPengajuan ? (b.tanggalPengajuan.toDate ? b.tanggalPengajuan.toDate() : new Date(b.tanggalPengajuan)) : new Date(0);
                return dateB - dateA;
            }).slice(0, 5);

            if (recentSurat.length === 0) {
              list.innerHTML = `<li><i class="fas fa-circle-info text-blue-500 mr-2"></i>Belum ada data surat.</li>`;
            } else {
              recentSurat.forEach((surat) => {
                const li = document.createElement("li");
                li.innerHTML = `<i class="fas fa-envelope text-indigo-500 mr-2"></i> Surat ${surat.jenisSurat} untuk ${surat.namaPemohon} (${App.formatDate(surat.tanggalPengajuan)}) - ${App.getStatusBadge(surat.status)}`;
                list.appendChild(li);
              });
            }
          },

          async addAuditLog(activity) {
            if (!App.isAuthReady || !auth.currentUser) return; // Don't log if not authenticated
            const userEmail = auth.currentUser.email || "Anonim";
            const userId = auth.currentUser.uid || "anonim";

            const newLog = {
              activity: activity,
              userEmail: userEmail,
              userId: userId,
              timestamp: serverTimestamp(),
            };
            await App.addDataToFirestore("auditLogs", newLog);
          },

          renderAuditLogsTable() {
            const tableBody = document.getElementById("auditLogsTableBody");
            tableBody.innerHTML = "";

            const retentionDays = App.data.pengaturan.auditLogRetention || 90;
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - retentionDays);

            const filteredLogs = App.data.auditLogs.filter((log) => {
                const logDate = log.timestamp ? (log.timestamp.toDate ? log.timestamp.toDate() : new Date(log.timestamp)) : new Date(0);
                return logDate >= cutoffDate;
            });

            if (filteredLogs.length === 0) {
              tableBody.innerHTML = `<tr><td colspan="3" class="py-4 px-4 text-center text-gray-500 dark:text-gray-400">Belum ada log aktivitas.</td></tr>`;
            } else {
              filteredLogs.slice(0, 10).forEach((log) => {
                const row = tableBody.insertRow();
                row.className = "hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150";
                const logDate = log.timestamp ? (log.timestamp.toDate ? log.timestamp.toDate() : new Date(log.timestamp)) : new Date(); // Handle timestamp object
                row.innerHTML = `
                  <td class="py-3 px-4 text-gray-700 dark:text-gray-300">${logDate.toLocaleString("id-ID")}</td>
                  <td class="py-3 px-4 text-gray-700 dark:text-gray-300">${log.activity}</td>
                  <td class="py-3 px-4 text-gray-700 dark:text-gray-300">${log.userEmail || "N/A"}</td>
                `;
              });
            }
          },

          getStatusBadge(status) {
            const colors = {
              Aktif: "bg-green-100 text-green-800 dark:bg-green-700 dark:text-green-100",
              "Non-Aktif": "bg-yellow-100 text-yellow-800 dark:bg-yellow-700 dark:text-yellow-100",
              Meninggal: "bg-red-100 text-red-800 dark:bg-red-700 dark:text-red-100",
              Pindah: "bg-blue-100 text-blue-800 dark:bg-blue-700 dark:text-blue-100",
              Diajukan: "bg-yellow-100 text-yellow-800 dark:bg-yellow-700 dark:text-yellow-100",
              Diproses: "bg-blue-100 text-blue-800 dark:bg-blue-700 dark:text-blue-100",
              Selesai: "bg-green-100 text-green-800 dark:bg-green-700 dark:text-green-100",
              Ditolak: "bg-red-100 text-red-800 dark:bg-red-700 dark:text-red-100",
              "Akan Datang": "bg-purple-100 text-purple-800 dark:bg-purple-700 dark:text-purple-100",
              "Sedang Berlangsung": "bg-indigo-100 text-indigo-800 dark:bg-indigo-700 dark:text-indigo-100",
              Dibatalkan: "bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300",
              "SHM": "bg-blue-100 text-blue-800 dark:bg-blue-700 dark:text-blue-100",
              "SHGB": "bg-purple-100 text-purple-800 dark:bg-purple-700 dark:text-purple-100",
              "Akta Jual Beli": "bg-green-100 text-green-800 dark:bg-green-700 dark:text-green-100",
              "Girik/Letter C": "bg-orange-100 text-orange-800 dark:bg-orange-700 dark:text-orange-100",
              "Lainnya": "bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-300",
              "Pemasukan": "bg-emerald-100 text-emerald-800 dark:bg-emerald-700 dark:text-emerald-100",
              "Pengeluaran": "bg-rose-100 text-rose-800 dark:bg-rose-700 dark:text-rose-100",
            };
            return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium leading-5 font-semibold rounded-full ${
              colors[status] || "bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-300"
            }" style="white-space: nowrap;">${status}</span>`;
          },

          showToast(iconClass, textColorClass, message) {
            const toastContainer = document.getElementById("toast-container");
            if (!toastContainer) {
              console.warn("Toast container not found.");
              return;
            }
            const toast = document.createElement("div");
            toast.className = "toast";
            toast.innerHTML = `<i class="${iconClass} icon ${textColorClass}"></i><span>${message}</span>`;
            toastContainer.appendChild(toast);

            setTimeout(() => {
              toast.classList.add("show");
            }, 100);

            setTimeout(() => {
              toast.classList.remove("show");
              toast.addEventListener("transitionend", () => toast.remove());
            }, 3000);
          },

          showConfirmModal(message, onConfirm) {
            const existingModal = document.getElementById("customConfirmModal");
            if (existingModal) existingModal.remove();

            const modalHtml = `
                  <div id="customConfirmModal" class="modal-backdrop">
                      <div class="modal-content w-full md:max-w-sm">
                          <p class="text-lg font-semibold mb-6 text-gray-900 dark:text-gray-100">${message}</p>
                          <div class="flex justify-end space-x-3">
                              <button id="cancelConfirmBtn" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">Batal</button>
                              <button id="confirmActionBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">Ya, Hapus</button>
                          </div>
                      </div>
                  </div>
              `;
            document.body.insertAdjacentHTML("beforeend", modalHtml);

            const confirmModal = document.getElementById("customConfirmModal");
            const confirmActionBtn = document.getElementById("confirmActionBtn");
            const cancelConfirmBtn = document.getElementById("cancelConfirmBtn");

            confirmActionBtn.onclick = () => {
              onConfirm();
              confirmModal.remove();
            };
            cancelConfirmBtn.onclick = () => {
              confirmModal.remove();
            };
            confirmModal.addEventListener("click", (e) => {
              if (e.target === confirmModal) {
                confirmModal.remove();
              }
            });
          },

          // Excel Import/Export
          exportToExcel(dataType, fileName) {
            const dataToExport = App.data[dataType];
            if (dataToExport.length === 0) {
              App.showToast("fas fa-info-circle", "text-blue-500", `Tidak ada data ${dataType} untuk diekspor.`);
              return;
            }

            const ws = XLSX.utils.json_to_sheet(dataToExport.map(item => {
                // Clean up Firestore Timestamp objects for export
                const newItem = { ...item };
                for (const key in newItem) {
                    if (newItem[key] && typeof newItem[key].toDate === 'function') {
                        newItem[key] = newItem[key].toDate().toISOString();
                    }
                }
                return newItem;
            }));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, dataType);
            XLSX.writeFile(wb, `${fileName}_${new Date().toISOString().slice(0, 10)}.xlsx`);
            App.addAuditLog(`Mengekspor data ${dataType}`);
            App.showToast("fas fa-check-circle", "text-green-500", `Data ${dataType} berhasil diekspor!`);
          },

          importFromExcel(event, dataType) {
            const file = event.target.files[0];
            if (!file) {
              return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: "array" });
              const firstSheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[firstSheetName];
              const jsonData = XLSX.utils.sheet_to_json(worksheet);

              if (jsonData.length > 0) {
                // Batch import to Firestore
                const batch = db.batch();
                const colRef = collection(db, dataType);
                let importedCount = 0;

                for (const item of jsonData) {
                    // Convert dates back if necessary, ensure all fields match Firestore schema
                    const newItem = { ...item };
                    // Example: Convert date strings to ISO format if expected by date inputs
                    if (newItem.tanggalLahir && typeof newItem.tanggalLahir === 'string') newItem.tanggalLahir = newItem.tanggalLahir.split('T')[0];
                    if (newItem.tanggalPengajuan && typeof newItem.tanggalPengajuan === 'string') newItem.tanggalPengajuan = newItem.tanggalPengajuan.split('T')[0];
                    if (newItem.tanggalMulai && typeof newItem.tanggalMulai === 'string') newItem.tanggalMulai = newItem.tanggalMulai.split('T')[0];
                    if (newItem.tanggal && typeof newItem.tanggal === 'string') newItem.tanggal = newItem.tanggal.split('T')[0];

                    const docRef = doc(colRef, newItem.id || App.generateUniqueId()); // Use existing ID or generate new
                    batch.set(docRef, {
                        ...newItem,
                        createdAt: serverTimestamp(), // Will only set on new docs if not present
                        updatedAt: serverTimestamp()
                    }, { merge: true });
                    importedCount++;
                }

                try {
                    await batch.commit();
                    App.addAuditLog(`Mengimpor ${importedCount} data ${dataType} dari Excel`);
                    App.showToast("fas fa-check-circle", "text-green-500", `${importedCount} data ${dataType} berhasil diimpor ke Firebase!`);
                } catch (batchError) {
                    console.error("Error batch importing data:", batchError);
                    App.showToast("fas fa-times-circle", "text-red-500", `Gagal mengimpor data ${dataType}: ${batchError.message}`);
                }
              } else {
                App.showToast("fas fa-exclamation-circle", "text-yellow-500", "File Excel kosong atau tidak ada data yang valid.");
              }
            };
            reader.readAsArrayBuffer(file);
          },
        };

        window.App = App;
        App.init(); // Initialize the app
      });
    </script>

    <style>
      /* Base styles for light mode */
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6; /* Gray-100 */
        color: #374151; /* Gray-800 */
        transition: background-color 0.3s ease, color 0.3s ease;
      }

      /* Dark mode styles */
      .dark body {
        background-color: #0f172a; /* Slate-900, deeper dark */
        color: #e2e8f0; /* Gray-200 */
      }

      /* Common focus styles */
      .header-search-input:focus,
      .form-input:focus,
      .form-select:focus,
      .form-textarea:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5); /* Indigo-500 with opacity */
        border-color: #6366f1; /* Indigo-500 */
      }
      .dark .header-search-input:focus,
      .dark .form-input:focus,
      .dark .form-select:focus,
      .dark .form-textarea:focus {
        box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.5); /* Indigo-400 with opacity */
        border-color: #818cf8; /* Indigo-400 */
      }

      /* Sidebar Active Link */
      .sidebar-link.active {
        background-color: #e0e7ff; /* Indigo-100 */
        color: #4338ca; /* Indigo-700 */
        font-weight: 600;
      }
      .dark .sidebar-link.active {
        background-color: #1e293b; /* Slate-800, provides good contrast */
        color: #a5b4fc; /* Indigo-300, lighter for dark mode */
      }
      .sidebar-link:hover {
        background-color: #f1f5f9; /* Gray-100 */
      }
      .dark .sidebar-link:hover {
        background-color: #334155; /* Slate-700 */
      }


      /* Toast Notifications */
      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .toast {
        background-color: #fff;
        color: #333;
        padding: 10px 15px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 10px;
        opacity: 0;
        transform: translateY(-20px);
        transition: opacity 0.3s ease-out, transform 0.3s ease-out;
      }
      .dark .toast {
        background-color: #2d3748; /* Darker gray for toasts */
        color: #e2e8f0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }
      .toast .icon {
        font-size: 1.2em;
      }
      .toast span {
        font-weight: 500;
      }
      .ocr-font {
        font-family: "OCR A Std", monospace;
      }

      /* Custom scrollbar for Webkit browsers */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px; /* For horizontal scrollbars */
      }
      ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }
      .dark::-webkit-scrollbar-track {
        background: #2d3748; /* Gray-800 */
      }
      ::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
      }
      .dark::-webkit-scrollbar-thumb {
        background: #6b7280; /* Gray-500, a bit lighter for dark mode */
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
      .dark::-webkit-scrollbar-thumb:hover {
        background: #4b5563; /* Gray-600 */
      }

      /* Table container for overflow scroll */
      .table-container {
        overflow-x: auto;
      }

      /* Card styling */
      .card {
        background-color: #ffffff;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        padding: 1.5rem;
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
      }
      .dark .card {
        background-color: #1e293b; /* Slate-800, consistent with sidebar active */
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.25), 0 1px 2px 0 rgba(0, 0, 0, 0.15); /* Slightly less harsh shadow */
      }

      /* Table specific styling */
      table {
        width: 100%; /* Ensure table takes full width of its container */
      }
      thead {
        background-color: #f9fafb; /* Gray-50 */
      }
      .dark thead {
        background-color: #334155; /* Slate-700 */
      }
      tbody {
        background-color: #ffffff;
      }
      .dark tbody {
        background-color: #1e293b; /* Consistent with card/table background */
      }
      tbody tr:nth-child(even) {
        background-color: #f1f5f9; /* Gray-100 for striped rows */
      }
      .dark tbody tr:nth-child(even) {
        background-color: #1a202c; /* Slightly different shade for striped rows in dark mode */
      }
      tbody tr.hover:bg-gray-50 { /* Existing hover */
        background-color: #f9fafb;
      }
      .dark tbody tr.hover\:bg-gray-700 { /* Existing dark hover */
        background-color: #334155;
      }
      td, th {
        border-bottom: 1px solid #e5e7eb; /* Gray-200 */
      }
      .dark td, .dark th {
        border-bottom: 1px solid #475569; /* Slate-600 */
      }
      
      /* Modal backdrop */
      .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6); /* Slightly darker backdrop for more pop */
        z-index: 999;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      /* Modal content */
      .modal-content {
        background-color: #fff;
        padding: 2rem;
        border-radius: 0.5rem;
        max-width: 90%;
        max-height: 90%;
        overflow-y: auto;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.15), 0 4px 6px -2px rgba(0, 0, 0, 0.08); /* Slightly more pronounced shadow */
        position: relative;
        z-index: 1000;
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
      }
      .dark .modal-content {
        background-color: #1e293b; /* Consistent with other dark elements */
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15);
      }

      /* Loader */
      .loader {
        border: 4px solid #f3f3f3; /* Light grey */
        border-top: 4px solid #3498db; /* Blue */
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      
      /* Dark mode toggle switch style */
      .dot {
        background-color: #fff;
      }
      .dark .dot {
        transform: translateX(100%);
        background-color: #a5b4fc; /* Indigo-300 for the dot in dark mode */
      }
      input:checked + .block {
        background-color: #6366f1; /* Indigo-500 when checked */
      }
      .dark input:checked + .block {
        background-color: #818cf8; /* Indigo-400 when checked in dark mode */
      }

      /* Adjusted icon colors for dark mode dashboard cards */
      .dark .card .fa-users { color: #6366f1; } /* Indigo-500 */
      .dark .card .fa-envelope-open-text { color: #22c55e; } /* Green-500 */
      .dark .card .fa-calendar-check { color: #facc15; } /* Yellow-400 */
      .dark .card .fa-wallet { color: #ef4444; } /* Red-500 */

      /* Text colors for dashboard stats */
      .dark #totalWarga { color: #a5b4fc; } /* Indigo-300 */
      .dark #totalSurat { color: #86efac; } /* Green-300 */
      .dark #totalKegiatan { color: #fde047; } /* Yellow-300 */
      .dark #totalKeuangan { color: #fca5a5; } /* Red-300 */

      /* Chart.js legend and title colors (handled in JS but also for consistency) */
      .chart-legend-label {
          color: var(--chart-text-color, #374151); /* Fallback to light mode color */
      }
      .dark .chart-legend-label {
          color: var(--chart-text-color, #e2e8f0); /* Fallback to dark mode color */
      }

    </style>
  </head>
  <body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200 flex h-screen">
    <!-- Login Form -->
    <div id="loginForm" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
      <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl w-96">
        <h2 class="text-3xl font-bold text-center text-indigo-700 dark:text-indigo-400 mb-6">Login Admin Desa</h2>
        <form id="adminLoginForm" class="space-y-4">
          <div>
            <label for="loginEmail" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email Admin</label>
            <input type="email" id="loginEmail" name="email" required class="form-input mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 text-gray-800 dark:text-gray-200" />
          </div>
          <div>
            <label for="loginPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Kata Sandi</label>
            <input
              type="password"
              id="loginPassword"
              name="password"
              required
              class="form-input mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 text-gray-800 dark:text-gray-200"
            />
          </div>
          <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">Login</button>
          <p id="loginError" class="text-red-500 text-sm mt-2 text-center hidden">Email atau kata sandi salah.</p>
        </form>
        <p class="text-center text-gray-600 dark:text-gray-400 mt-4">Belum punya akun? <a href="#" id="showRegisterModalLink" class="text-indigo-600 hover:underline">Daftar di sini</a></p>
      </div>
    </div>

    <!-- Register Modal (Baru ditambahkan) -->
    <div id="registerModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
      <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl w-96">
        <h2 class="text-3xl font-bold text-center text-indigo-700 dark:text-indigo-400 mb-6">Daftar Admin Baru</h2>
        <form id="adminRegisterForm" class="space-y-4">
          <div>
            <label for="registerEmail" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email</label>
            <input
              type="email"
              id="registerEmail"
              name="email"
              required
              class="form-input mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 text-gray-800 dark:text-gray-200"
            />
          </div>
          <div>
            <label for="registerPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Kata Sandi (min. 6 karakter)</label>
            <input
              type="password"
              id="registerPassword"
              name="password"
              required
              class="form-input mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 text-gray-800 dark:text-gray-200"
            />
          </div>
          <div>
            <label for="registerConfirmPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Konfirmasi Kata Sandi</label>
            <input
              type="password"
              id="registerConfirmPassword"
              name="confirmPassword"
              required
              class="form-input mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 text-gray-800 dark:text-gray-200"
            />
          </div>
          <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">Daftar</button>
          <p id="registerError" class="text-red-500 text-sm mt-2 text-center hidden"></p>
        </form>
        <p class="text-center text-gray-600 dark:text-gray-400 mt-4">Sudah punya akun? <a href="#" id="showLoginModalLink" class="text-indigo-600 hover:underline">Login di sini</a></p>
      </div>
    </div>

    <!-- Main App Content (Sembunyikan sampai login berhasil) -->
    <div id="appContent" class="flex h-screen w-full hidden">
      <!-- Sidebar -->
      <aside class="w-64 bg-white dark:bg-gray-800 shadow-md flex flex-col justify-between transition-colors duration-300">
        <div class="p-6">
          <h1 class="text-2xl font-extrabold text-indigo-700 dark:text-indigo-400 mb-8">Desa Digital</h1>
          <nav>
            <ul class="space-y-2">
              <li>
                <a href="#dashboard" class="sidebar-link active flex items-center p-3 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200"
                  ><i class="fas fa-chart-line mr-3"></i>Dashboard</a
                >
              </li>
              <li>
                <a href="#warga" class="sidebar-link flex items-center p-3 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200"><i class="fas fa-users mr-3"></i>Data Warga</a>
              </li>
              <li>
                <a href="#surat" class="sidebar-link flex items-center p-3 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200"
                  ><i class="fas fa-envelope mr-3"></i>Surat-Menyurat</a
                >
              </li>
              <li>
                <a href="#tanah" class="sidebar-link flex items-center p-3 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200"
                  ><i class="fas fa-map-marked-alt mr-3"></i>Data Tanah</a
                >
              </li>
              <li>
                <a href="#kegiatan" class="sidebar-link flex items-center p-3 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200"
                  ><i class="fas fa-calendar-alt mr-3"></i>Kegiatan Desa</a
                >
              </li>
              <li>
                <a href="#keuangan" class="sidebar-link flex items-center p-3 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200"
                  ><i class="fas fa-cash-register mr-3"></i>Keuangan Desa</a
                >
              </li>
              <li>
                <a href="#pengaturan" class="sidebar-link flex items-center p-3 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200"
                  ><i class="fas fa-cogs mr-3"></i>Pengaturan</a
                >
              </li>
            </ul>
          </nav>
        </div>
        <div class="p-6 border-t border-gray-200 dark:border-gray-700 transition-colors duration-300">
          <button id="logoutButton" class="w-full flex items-center justify-center p-3 text-red-600 dark:text-red-400 rounded-lg hover:bg-red-50 dark:hover:bg-red-900 transition-colors duration-200">
            <i class="fas fa-sign-out-alt mr-3"></i>Keluar
          </button>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 p-8 overflow-y-auto bg-gray-100 dark:bg-gray-900 transition-colors duration-300">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
          <h2 class="text-3xl font-bold text-gray-900 dark:text-gray-100" id="currentModuleTitle">Dashboard</h2>
          <div class="flex items-center space-x-4">
            <label for="darkModeToggle" class="flex items-center cursor-pointer">
              <span class="mr-2 text-gray-700 dark:text-gray-300">Mode Gelap</span>
              <div class="relative">
                <input type="checkbox" id="darkModeToggle" class="sr-only" />
                <div class="block bg-gray-600 w-14 h-8 rounded-full"></div>
                <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition transform"></div>
              </div>
            </label>
            <div class="relative">
              <input
                type="text"
                placeholder="Cari..."
                class="header-search-input bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-full py-2 pl-4 pr-10 text-gray-800 dark:text-gray-200 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
              />
              <i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>
            <img src="https://via.placeholder.com/40/6366f1/ffffff?text=AD" alt="Avatar Admin" class="w-10 h-10 rounded-full border-2 border-indigo-500" />
          </div>
        </header>

        <!-- Toast Container -->
        <div id="toast-container" class="toast-container"></div>

        <!-- Content Area (This will change dynamically) -->
        <div id="contentArea">
          <!-- Dashboard Content -->
          <section id="dashboard" class="module-content">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
              <div class="card flex items-center justify-between">
                <div>
                  <h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Total Warga</h3>
                  <p class="text-3xl font-bold text-indigo-700 dark:text-indigo-300" id="totalWarga">0</p>
                </div>
                <i class="fas fa-users text-5xl text-indigo-200 dark:text-indigo-600"></i>
              </div>
              <div class="card flex items-center justify-between">
                <div>
                  <h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Surat Terbit</h3>
                  <p class="text-3xl font-bold text-green-700 dark:text-green-300" id="totalSurat">0</p>
                </div>
                <i class="fas fa-envelope-open-text text-5xl text-green-200 dark:text-green-600"></i>
              </div>
              <div class="card flex items-center justify-between">
                <div>
                  <h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Kegiatan Aktif</h3>
                  <p class="text-3xl font-bold text-yellow-700 dark:text-yellow-300" id="totalKegiatan">0</p>
                </div>
                <i class="fas fa-calendar-check text-5xl text-yellow-200 dark:text-yellow-600"></i>
              </div>
              <div class="card flex items-center justify-between">
                <div>
                  <h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Keuangan (Saldo)</h3>
                  <p class="text-3xl font-bold text-red-700 dark:text-red-300" id="totalKeuangan">Rp 0</p>
                </div>
                <i class="fas fa-wallet text-5xl text-red-200 dark:text-red-600"></i>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div class="card">
                <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200">Statistik Demografi Warga</h3>
                <canvas id="demografiChart"></canvas>
              </div>
              <div class="card">
                <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200">Aktivitas Surat Terakhir</h3>
                <ul id="recentSuratList" class="space-y-2 text-gray-700 dark:text-gray-300">
                  <!-- Data surat terbaru akan dimuat di sini -->
                  <li><i class="fas fa-circle-info text-blue-500 mr-2"></i>Belum ada data surat.</li>
                </ul>
              </div>
              <div class="card lg:col-span-2">
                <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200">Log Aktivitas Terbaru</h3>
                <div class="table-container">
                  <table class="min-w-full rounded-lg shadow overflow-hidden">
                    <thead class="bg-gray-100 dark:bg-gray-600">
                      <tr>
                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Waktu</th>
                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Aktivitas</th>
                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Pengguna</th>
                      </tr>
                    </thead>
                    <tbody id="auditLogsTableBody" class="divide-y divide-gray-200 dark:divide-gray-600">
                      <!-- Log aktivitas akan dimuat di sini -->
                      <tr>
                        <td colspan="3" class="py-4 px-4 text-center text-gray-500 dark:text-gray-400">Belum ada log aktivitas.</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>

          <!-- Warga Module Content -->
          <section id="warga" class="module-content hidden">
            <div class="flex justify-between items-center mb-6">
              <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Manajemen Data Warga</h3>
              <button id="tambahWargaBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center">
                <i class="fas fa-plus mr-2"></i> Tambah Warga Baru
              </button>
            </div>

            <!-- Filter dan Search -->
            <div class="card mb-6">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label for="filterStatus" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
                  <select id="filterStatus" class="form-select w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
                    <option value="">Semua</option>
                    <option value="Aktif">Aktif</option>
                    <option value="Non-Aktif">Non-Aktif</option>
                    <option value="Meninggal">Meninggal</option>
                    <option value="Pindah">Pindah</option>
                  </select>
                </div>
                <div>
                  <label for="filterGender" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Jenis Kelamin</label>
                  <select id="filterGender" class="form-select w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
                    <option value="">Semua</option>
                    <option value="Laki-laki">Laki-laki</option>
                    <option value="Perempuan">Perempuan</option>
                  </select>
                </div>
                <div>
                  <label for="searchWarga" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Cari Warga (Nama/NIK)</label>
                  <input
                    type="text"
                    id="searchWarga"
                    placeholder="Cari nama atau NIK..."
                    class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2"
                  />
                </div>
              </div>
            </div>

            <!-- Tombol Aksi Massal & Impor/Ekspor -->
            <div class="flex justify-between items-center mb-6">
              <div class="flex space-x-3">
                <button id="exportWargaBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center">
                  <i class="fas fa-file-excel mr-2"></i> Ekspor Data
                </button>
                <label for="importWargaInput" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center cursor-pointer">
                  <i class="fas fa-file-import mr-2"></i> Impor Data
                </label>
                <input type="file" id="importWargaInput" accept=".xlsx, .xls" class="hidden" />
              </div>
              <button id="hapusWargaTerpilihBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center">
                <i class="fas fa-trash-alt mr-2"></i> Hapus Terpilih
              </button>
            </div>

            <!-- Tabel Data Warga -->
            <div class="card table-container">
              <table class="min-w-full rounded-lg shadow overflow-hidden">
                <thead class="bg-gray-100 dark:bg-gray-600">
                  <tr>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"><input type="checkbox" id="selectAllWarga" /></th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Foto</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Nama Lengkap</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">NIK</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Aksi</th>
                  </tr>
                </thead>
                <tbody id="wargaTableBody" class="divide-y divide-gray-200 dark:divide-gray-600">
                  <!-- Data warga akan dimuat di sini -->
                  <tr>
                    <td colspan="6" class="py-4 px-4 text-center text-gray-500 dark:text-gray-400">Belum ada data warga.</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
            <div class="flex justify-between items-center mt-6">
              <button id="prevWargaPage" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg transition-colors duration-200" disabled>
                Sebelumnya
              </button>
              <span id="currentPageWarga" class="text-gray-700 dark:text-gray-300">Halaman 1</span>
              <button id="nextWargaPage" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg transition-colors duration-200" disabled>
                Berikutnya
              </button>
            </div>
          </section>

          <!-- Surat Module Content -->
          <section id="surat" class="module-content hidden">
            <div class="flex justify-between items-center mb-6">
              <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Manajemen Surat-Menyurat</h3>
              <button id="tambahSuratBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center">
                <i class="fas fa-plus mr-2"></i> Buat Surat Baru
              </button>
            </div>

            <div class="card mb-6">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label for="filterJenisSurat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Jenis Surat</label>
                  <select id="filterJenisSurat" class="form-select w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
                    <option value="">Semua</option>
                    <option value="Keterangan Usaha">Keterangan Usaha</option>
                    <option value="Keterangan Domisili">Keterangan Domisili</option>
                    <option value="Keterangan Tidak Mampu">Keterangan Tidak Mampu</option>
                    <option value="Pengantar KTP">Pengantar KTP</option>
                    <option value="Kelahiran">Kelahiran</option>
                    <option value="Kematian">Kematian</option>
                    <!-- Tambahkan jenis surat lain jika diperlukan -->
                  </select>
                </div>
                <div>
                  <label for="filterStatusSurat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status Surat</label>
                  <select id="filterStatusSurat" class="form-select w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
                    <option value="">Semua</option>
                    <option value="Diajukan">Diajukan</option>
                    <option value="Diproses">Diproses</option>
                    <option value="Selesai">Selesai</option>
                    <option value="Ditolak">Ditolak</option>
                  </select>
                </div>
                <div>
                  <label for="searchSurat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Cari Surat (No/Nama)</label>
                  <input
                    type="text"
                    id="searchSurat"
                    placeholder="Cari nomor surat atau nama pemohon..."
                    class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2"
                  />
                </div>
              </div>
            </div>

            <div class="card table-container">
              <table class="min-w-full rounded-lg shadow overflow-hidden">
                <thead class="bg-gray-100 dark:bg-gray-600">
                  <tr>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">No. Surat</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Jenis Surat</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Pemohon</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Tanggal Pengajuan</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Aksi</th>
                  </tr>
                </thead>
                <tbody id="suratTableBody" class="divide-y divide-gray-200 dark:divide-gray-600">
                  <!-- Data surat akan dimuat di sini -->
                  <tr>
                    <td colspan="6" class="py-4 px-4 text-center text-gray-500 dark:text-gray-400">Belum ada data surat.</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="flex justify-between items-center mt-6">
              <button id="prevSuratPage" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg transition-colors duration-200" disabled>
                Sebelumnya
              </button>
              <span id="currentPageSurat" class="text-gray-700 dark:text-gray-300">Halaman 1</span>
              <button id="nextSuratPage" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg transition-colors duration-200" disabled>
                Berikutnya
              </button>
            </div>
          </section>

          <!-- Tanah Module Content -->
          <section id="tanah" class="module-content hidden">
            <div class="flex justify-between items-center mb-6">
              <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Manajemen Data Tanah</h3>
              <button id="tambahTanahBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center">
                <i class="fas fa-plus mr-2"></i> Tambah Data Tanah
              </button>
            </div>

            <div class="card mb-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="filterJenisSertifikat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Jenis Sertifikat</label>
                  <select id="filterJenisSertifikat" class="form-select w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
                    <option value="">Semua</option>
                    <option value="SHM">Sertifikat Hak Milik (SHM)</option>
                    <option value="SHGB">Sertifikat Hak Guna Bangunan (SHGB)</option>
                    <option value="Akta Jual Beli">Akta Jual Beli (AJB)</option>
                    <option value="Girik/Letter C">Girik/Letter C</option>
                    <option value="Lainnya">Lainnya</option>
                  </select>
                </div>
                <div>
                  <label for="searchTanah" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Cari Tanah (No. Sertifikat/Pemilik)</label>
                  <input
                    type="text"
                    id="searchTanah"
                    placeholder="Cari nomor sertifikat atau nama pemilik..."
                    class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2"
                  />
                </div>
              </div>
            </div>

            <div class="card table-container">
              <table class="min-w-full rounded-lg shadow overflow-hidden">
                <thead class="bg-gray-100 dark:bg-gray-600">
                  <tr>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">No. Sertifikat</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Pemilik</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Luas (m²)</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Jenis Sertifikat</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Lokasi</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Aksi</th>
                  </tr>
                </thead>
                <tbody id="tanahTableBody" class="divide-y divide-gray-200 dark:divide-gray-600">
                  <!-- Data tanah akan dimuat di sini -->
                  <tr>
                    <td colspan="6" class="py-4 px-4 text-center text-gray-500 dark:text-gray-400">Belum ada data tanah.</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="flex justify-between items-center mt-6">
              <button id="prevTanahPage" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg transition-colors duration-200" disabled>
                Sebelumnya
              </button>
              <span id="currentPageTanah" class="text-gray-700 dark:text-gray-300">Halaman 1</span>
              <button id="nextTanahPage" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg transition-colors duration-200" disabled>
                Berikutnya
              </button>
            </div>
          </section>

          <!-- Kegiatan Module Content -->
          <section id="kegiatan" class="module-content hidden">
            <div class="flex justify-between items-center mb-6">
              <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Manajemen Kegiatan Desa</h3>
              <button id="tambahKegiatanBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center">
                <i class="fas fa-plus mr-2"></i> Tambah Kegiatan
              </button>
            </div>

            <div class="card mb-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="filterStatusKegiatan" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status Kegiatan</label>
                  <select id="filterStatusKegiatan" class="form-select w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
                    <option value="">Semua</option>
                    <option value="Akan Datang">Akan Datang</option>
                    <option value="Sedang Berlangsung">Sedang Berlangsung</option>
                    <option value="Selesai">Selesai</option>
                    <option value="Dibatalkan">Dibatalkan</option>
                  </select>
                </div>
                <div>
                  <label for="searchKegiatan" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Cari Kegiatan (Nama)</label>
                  <input
                    type="text"
                    id="searchKegiatan"
                    placeholder="Cari nama kegiatan..."
                    class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2"
                  />
                </div>
              </div>
            </div>

            <div class="card table-container">
              <table class="min-w-full rounded-lg shadow overflow-hidden">
                <thead class="bg-gray-100 dark:bg-gray-600">
                  <tr>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Nama Kegiatan</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Tanggal</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Lokasi</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Aksi</th>
                  </tr>
                </thead>
                <tbody id="kegiatanTableBody" class="divide-y divide-gray-200 dark:divide-gray-600">
                  <!-- Data kegiatan akan dimuat di sini -->
                  <tr>
                    <td colspan="5" class="py-4 px-4 text-center text-gray-500 dark:text-gray-400">Belum ada data kegiatan.</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="flex justify-between items-center mt-6">
              <button id="prevKegiatanPage" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg transition-colors duration-200" disabled>
                Sebelumnya
              </button>
              <span id="currentPageKegiatan" class="text-gray-700 dark:text-gray-300">Halaman 1</span>
              <button id="nextKegiatanPage" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg transition-colors duration-200" disabled>
                Berikutnya
              </button>
            </div>
          </section>

          <!-- Keuangan Module Content -->
          <section id="keuangan" class="module-content hidden">
            <div class="flex justify-between items-center mb-6">
              <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Manajemen Keuangan Desa</h3>
              <div class="flex space-x-3">
                <button id="tambahPemasukanBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center">
                  <i class="fas fa-plus-circle mr-2"></i> Tambah Pemasukan
                </button>
                <button id="tambahPengeluaranBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 flex items-center">
                  <i class="fas fa-minus-circle mr-2"></i> Tambah Pengeluaran
                </button>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div class="card bg-green-50 dark:bg-green-900 border-l-4 border-green-500">
                <h4 class="text-lg font-semibold text-green-700 dark:text-green-300 mb-2">Total Pemasukan</h4>
                <p class="text-3xl font-bold text-green-800 dark:text-green-200" id="totalPemasukan">Rp 0</p>
              </div>
              <div class="card bg-red-50 dark:bg-red-900 border-l-4 border-red-500">
                <h4 class="text-lg font-semibold text-red-700 dark:text-red-300 mb-2">Total Pengeluaran</h4>
                <p class="text-3xl font-bold text-red-800 dark:text-red-200" id="totalPengeluaran">Rp 0</p>
              </div>
              <div class="card md:col-span-2 bg-indigo-50 dark:bg-indigo-900 border-l-4 border-indigo-500">
                <h4 class="text-lg font-semibold text-indigo-700 dark:text-indigo-300 mb-2">Saldo Saat Ini</h4>
                <p class="text-4xl font-bold text-indigo-800 dark:text-indigo-200" id="saldoKeuangan">Rp 0</p>
              </div>
            </div>

            <div class="card mb-6">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label for="filterJenisTransaksi" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Jenis Transaksi</label>
                  <select id="filterJenisTransaksi" class="form-select w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
                    <option value="">Semua</option>
                    <option value="Pemasukan">Pemasukan</option>
                    <option value="Pengeluaran">Pengeluaran</option>
                  </select>
                </div>
                <div>
                  <label for="filterBulanTahun" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Bulan/Tahun</label>
                  <input type="month" id="filterBulanTahun" class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2" />
                </div>
                <div>
                  <label for="searchKeuangan" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Cari Transaksi (Deskripsi)</label>
                  <input
                    type="text"
                    id="searchKeuangan"
                    placeholder="Cari deskripsi transaksi..."
                    class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2"
                  />
                </div>
              </div>
            </div>

            <div class="card table-container">
              <table class="min-w-full rounded-lg shadow overflow-hidden">
                <thead class="bg-gray-100 dark:bg-gray-600">
                  <tr>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Tanggal</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Jenis</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Deskripsi</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Jumlah</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Aksi</th>
                  </tr>
                </thead>
                <tbody id="keuanganTableBody" class="divide-y divide-gray-200 dark:divide-gray-600">
                  <!-- Data keuangan akan dimuat di sini -->
                  <tr>
                    <td colspan="5" class="py-4 px-4 text-center text-gray-500 dark:text-gray-400">Belum ada data keuangan.</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="flex justify-between items-center mt-6">
              <button id="prevKeuanganPage" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg transition-colors duration-200" disabled>
                Sebelumnya
              </button>
              <span id="currentPageKeuangan" class="text-gray-700 dark:text-gray-300">Halaman 1</span>
              <button id="nextKeuanganPage" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg transition-colors duration-200" disabled>
                Berikutnya
              </button>
            </div>
          </section>

          <!-- Pengaturan Module Content -->
          <section id="pengaturan" class="module-content hidden">
            <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-6">Pengaturan Aplikasi</h3>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div class="card">
                <h4 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200">Informasi Desa</h4>
                <form id="desaInfoForm" class="space-y-4">
                  <div>
                    <label for="namaDesa" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nama Desa</label>
                    <input type="text" id="namaDesa" class="form-input mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 text-gray-800 dark:text-gray-200" />
                  </div>
                  <div>
                    <label for="alamatDesa" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Alamat Desa</label>
                    <input type="text" id="alamatDesa" class="form-input mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 text-gray-800 dark:text-gray-200" />
                  </div>
                  <div>
                    <label for="teleponDesa" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Telepon Desa</label>
                    <input type="tel" id="teleponDesa" class="form-input mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 text-gray-800 dark:text-gray-200" />
                  </div>
                  <div>
                    <label for="emailDesa" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email Desa</label>
                    <input type="email" id="emailDesa" class="form-input mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 text-gray-800 dark:text-gray-200" />
                  </div>
                  <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">Simpan Informasi Desa</button>
                </form>
              </div>

              <div class="card">
                <h4 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200">Manajemen Admin</h4>
                <div class="mb-4">
                  <label for="adminEmail" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tambah Admin Baru (Email)</label>
                  <div class="flex space-x-2 mt-1">
                    <input
                      type="email"
                      id="adminEmail"
                      placeholder="email@contoh.com"
                      class="form-input flex-1 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 text-gray-800 dark:text-gray-200"
                    />
                    <!-- Tombol tambah admin ini sekarang akan memicu pendaftaran melalui Firebase Authentication -->
                    <button id="addAdminBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">Tambah</button>
                  </div>
                  <p id="addAdminError" class="text-red-500 text-sm mt-2 hidden"></p>
                </div>
                <h5 class="text-md font-semibold mb-2 text-gray-800 dark:text-gray-200">Daftar Admin</h5>
                <ul id="adminList" class="space-y-2">
                  <!-- Daftar admin akan dimuat di sini -->
                  <li class="flex justify-between items-center bg-gray-50 dark:bg-gray-700 p-2 rounded-md">
                    <span class="text-gray-700 dark:text-gray-300">Memuat admin...</span>
                  </li>
                </ul>
              </div>

              <div class="card lg:col-span-2">
                <h4 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200">Pengaturan Lainnya</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label for="paginationLimit" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Batas Data per Halaman</label>
                    <input
                      type="number"
                      id="paginationLimit"
                      min="5"
                      max="50"
                      value="10"
                      class="form-input mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 text-gray-800 dark:text-gray-200"
                    />
                  </div>
                  <div>
                    <label for="auditLogRetention" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Retensi Log Audit (Hari)</label>
                    <input
                      type="number"
                      id="auditLogRetention"
                      min="7"
                      max="365"
                      value="90"
                      class="form-input mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 text-gray-800 dark:text-gray-200"
                    />
                  </div>
                </div>
                <button id="savePengaturanLainnyaBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 mt-4">Simpan Pengaturan Lainnya</button>
              </div>
            </div>
          </section>
        </div>
      </main>
    </div>
    <!-- End of appContent -->

    <!-- Modals (Initially hidden) -->
    <!-- Modal Tambah/Edit Warga -->
    <div id="wargaModal" class="modal-backdrop hidden">
      <div class="modal-content w-full md:max-w-4xl max-h-[90vh]">
        <h3 id="wargaModalTitle" class="text-2xl font-bold mb-6 text-gray-900 dark:text-gray-100">Tambah Warga Baru</h3>
        <form id="wargaForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="hidden" id="wargaId" />
          <div class="md:col-span-2">
            <label for="fotoWarga" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Foto Warga</label>
            <input type="file" id="fotoWarga" accept="image/*" class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2" />
            <div id="fotoWargaPreviewContainer" class="mt-2 flex flex-wrap gap-2">
              <!-- Image preview will be loaded here -->
            </div>
          </div>
          <div>
            <label for="nikWarga" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">NIK</label>
            <input type="text" id="nikWarga" required class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2" />
          </div>
          <div>
            <label for="namaLengkap" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nama Lengkap</label>
            <input type="text" id="namaLengkap" required class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2" />
          </div>
          <div>
            <label for="tempatLahir" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tempat Lahir</label>
            <input type="text" id="tempatLahir" required class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2" />
          </div>
          <div>
            <label for="tanggalLahir" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tanggal Lahir</label>
            <input type="date" id="tanggalLahir" required class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2" />
          </div>
          <div>
            <label for="jenisKelamin" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Jenis Kelamin</label>
            <select id="jenisKelamin" required class="form-select w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
              <option value="">Pilih</option>
              <option value="Laki-laki">Laki-laki</option>
              <option value="Perempuan">Perempuan</option>
            </select>
          </div>
          <div>
            <label for="agama" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Agama</label>
            <select id="agama" required class="form-select w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
              <option value="">Pilih</option>
              <option value="Islam">Islam</option>
              <option value="Kristen Protestan">Kristen Protestan</option>
              <option value="Kristen Katolik">Kristen Katolik</option>
              <option value="Hindu">Hindu</option>
              <option value="Buddha">Buddha</option>
              <option value="Konghucu">Konghucu</option>
              <option value="Lainnya">Lainnya</option>
            </select>
          </div>
          <div>
            <label for="statusPerkawinan" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status Perkawinan</label>
            <select id="statusPerkawinan" required class="form-select w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
              <option value="">Pilih</option>
              <option value="Belum Kawin">Belum Kawin</option>
              <option value="Kawin">Kawin</option>
              <option value="Cerai Hidup">Cerai Hidup</option>
              <option value="Cerai Mati">Cerai Mati</option>
            </select>
          </div>
          <div>
            <label for="pekerjaan" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Pekerjaan</label>
            <input type="text" id="pekerjaan" class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2" />
          </div>
          <div>
            <label for="pendidikanTerakhir" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Pendidikan Terakhir</label>
            <select id="pendidikanTerakhir" class="form-select w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
              <option value="">Pilih</option>
              <option value="Tidak/Belum Sekolah">Tidak/Belum Sekolah</option>
              <option value="SD/Sederajat">SD/Sederajat</option>
              <option value="SMP/Sederajat">SMP/Sederajat</option>
              <option value="SMA/Sederajat">SMA/Sederajat</option>
              <option value="Diploma">Diploma</option>
              <option value="Sarjana">Sarjana</option>
              <option value="Pascasarjana">Pascasarjana</option>
            </select>
          </div>
          <div>
            <label for="alamat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Alamat (Jalan, RT/RW, Dusun)</label>
            <textarea id="alamat" rows="2" class="form-textarea w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2"></textarea>
          </div>
          <div>
            <label for="statusWarga" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status Warga</label>
            <select id="statusWarga" required class="form-select w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
              <option value="Aktif">Aktif</option>
              <option value="Non-Aktif">Non-Aktif</option>
              <option value="Meninggal">Meninggal</option>
              <option value="Pindah">Pindah</option>
            </select>
          </div>
          <div class="md:col-span-2 flex justify-end space-x-3 mt-6">
            <button
              type="button"
              id="closeWargaModalBtn"
              class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200"
            >
              Batal
            </button>
            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">Simpan Warga</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Detail Warga -->
    <div id="detailWargaModal" class="modal-backdrop hidden">
      <div class="modal-content w-full md:max-w-3xl">
        <h3 class="text-2xl font-bold mb-4 text-gray-900 dark:text-gray-100">Detail Data Warga</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Foto:</p>
            <div id="detailFotoWargaContainer" class="mt-1 mb-4">
              <img id="detailFotoWarga" src="https://via.placeholder.com/150" alt="Foto Warga" class="w-32 h-32 object-cover rounded-md shadow" />
            </div>
            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Nama Lengkap:</p>
            <p id="detailNamaLengkap" class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2"></p>
            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">NIK:</p>
            <p id="detailNIK" class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2 ocr-font"></p>
            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Tempat, Tanggal Lahir:</p>
            <p id="detailTTL" class="text-gray-800 dark:text-gray-200 mb-2"></p>
            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Jenis Kelamin:</p>
            <p id="detailJenisKelamin" class="text-gray-800 dark:text-gray-200 mb-2"></p>
          </div>
          <div>
            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Agama:</p>
            <p id="detailAgama" class="text-gray-800 dark:text-gray-200 mb-2"></p>
            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Status Perkawinan:</p>
            <p id="detailStatusPerkawinan" class="text-gray-800 dark:text-gray-200 mb-2"></p>
            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Pekerjaan:</p>
            <p id="detailPekerjaan" class="text-gray-800 dark:text-gray-200 mb-2"></p>
            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Pendidikan Terakhir:</p>
            <p id="detailPendidikanTerakhir" class="text-gray-800 dark:text-gray-200 mb-2"></p>
            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Alamat:</p>
            <p id="detailAlamat" class="text-gray-800 dark:text-gray-200 mb-2"></p>
            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Status Warga:</p>
            <p id="detailStatusWarga" class="text-gray-800 dark:text-gray-200 mb-2"></p>
          </div>
        </div>
        <div class="flex justify-end mt-6">
          <button id="closeDetailWargaModalBtn" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">
            Tutup
          </button>
        </div>
      </div>
    </div>

    <!-- Modal Tambah/Edit Surat -->
    <div id="suratModal" class="modal-backdrop hidden">
      <div class="modal-content w-full md:max-w-xl max-h-[90vh]">
        <h3 id="suratModalTitle" class="text-2xl font-bold mb-6 text-gray-900 dark:text-gray-100">Buat Surat Baru</h3>
        <form id="suratForm" class="space-y-4">
          <input type="hidden" id="suratId" />
          <div>
            <label for="noSurat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nomor Surat</label>
            <input type="text" id="noSurat" required class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2" />
          </div>
          <div>
            <label for="jenisSurat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Jenis Surat</label>
            <select id="jenisSurat" required class="form-select w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
              <option value="">Pilih Jenis Surat</option>
              <option value="Keterangan Usaha">Keterangan Usaha</option>
              <option value="Keterangan Domisili">Keterangan Domisili</option>
              <option value="Keterangan Tidak Mampu">Keterangan Tidak Mampu</option>
              <option value="Pengantar KTP">Pengantar KTP</option>
              <option value="Kelahiran">Kelahiran</option>
              <option value="Kematian">Kematian</option>
            </select>
          </div>
          <div>
            <label for="namaPemohon" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nama Pemohon</label>
            <input type="text" id="namaPemohon" required class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2" />
          </div>
          <div>
            <label for="tanggalPengajuan" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tanggal Pengajuan</label>
            <input type="date" id="tanggalPengajuan" required class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2" />
          </div>
          <div>
            <label for="statusSurat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status Surat</label>
            <select id="statusSurat" required class="form-select w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
              <option value="Diajukan">Diajukan</option>
              <option value="Diproses">Diproses</option>
              <option value="Selesai">Selesai</option>
              <option value="Ditolak">Ditolak</option>
            </select>
          </div>
          <div>
            <label for="keteranganSurat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Keterangan Tambahan</label>
            <textarea id="keteranganSurat" rows="3" class="form-textarea w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2"></textarea>
          </div>
          <div>
            <label for="lampiranSurat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Lampiran (PDF)</label>
            <input type="file" id="lampiranSurat" accept=".pdf" class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2" />
            <div id="lampiranSuratPreviewContainer" class="mt-2 flex flex-wrap gap-2">
              <!-- Attachment preview/links will be loaded here -->
            </div>
          </div>
          <div class="flex justify-end space-x-3 mt-6">
            <button
              type="button"
              id="closeSuratModalBtn"
              class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200"
            >
              Batal
            </button>
            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">Simpan Surat</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Tambah/Edit Tanah -->
    <div id="tanahModal" class="modal-backdrop hidden">
      <div class="modal-content w-full md:max-w-xl max-h-[90vh]">
        <h3 id="tanahModalTitle" class="text-2xl font-bold mb-6 text-gray-900 dark:text-gray-100">Tambah Data Tanah</h3>
        <form id="tanahForm" class="space-y-4">
          <input type="hidden" id="tanahId" />
          <div>
            <label for="noSertifikat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nomor Sertifikat</label>
            <input type="text" id="noSertifikat" required class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2" />
          </div>
          <div>
            <label for="pemilikTanah" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nama Pemilik</label>
            <input type="text" id="pemilikTanah" required class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2" />
          </div>
          <div>
            <label for="luasTanah" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Luas Tanah (m²)</label>
            <input type="number" id="luasTanah" required class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2" />
          </div>
          <div>
            <label for="jenisSertifikat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Jenis Sertifikat</label>
            <select id="jenisSertifikat" required class="form-select w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
              <option value="">Pilih Jenis Sertifikat</option>
              <option value="SHM">Sertifikat Hak Milik (SHM)</option>
              <option value="SHGB">Sertifikat Hak Guna Bangunan (SHGB)</option>
              <option value="Akta Jual Beli">Akta Jual Beli (AJB)</option>
              <option value="Girik/Letter C">Girik/Letter C</option>
              <option value="Lainnya">Lainnya</option>
            </select>
          </div>
          <div>
            <label for="lokasiTanah" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Lokasi Tanah</label>
            <textarea id="lokasiTanah" rows="2" class="form-textarea w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2"></textarea>
          </div>
          <div>
            <label for="batasUtara" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Batas Utara</label>
            <input type="text" id="batasUtara" class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2" />
          </div>
          <div>
            <label for="batasSelatan" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Batas Selatan</label>
            <input type="text" id="batasSelatan" class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2" />
          </div>
          <div>
            <label for="batasTimur" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Batas Timur</label>
            <input type="text" id="batasTimur" class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2" />
          </div>
          <div>
            <label for="batasBarat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Batas Barat</label>
            <input type="text" id="batasBarat" class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2" />
          </div>
          <div class="flex justify-end space-x-3 mt-6 md:col-span-2">
            <button
              type="button"
              id="closeTanahModalBtn"
              class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200"
            >
              Batal
            </button>
            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">Simpan Tanah</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Tambah/Edit Kegiatan -->
    <div id="kegiatanModal" class="modal-backdrop hidden">
      <div class="modal-content w-full md:max-w-xl max-h-[90vh]">
        <h3 id="kegiatanModalTitle" class="text-2xl font-bold mb-6 text-gray-900 dark:text-gray-100">Tambah Kegiatan Desa</h3>
        <form id="kegiatanForm" class="space-y-4">
          <input type="hidden" id="kegiatanId" />
          <div>
            <label for="namaKegiatan" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nama Kegiatan</label>
            <input type="text" id="namaKegiatan" required class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2" />
          </div>
          <div>
            <label for="deskripsiKegiatan" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Deskripsi Kegiatan</label>
            <textarea id="deskripsiKegiatan" rows="3" class="form-textarea w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2"></textarea>
          </div>
          <div>
            <label for="tanggalKegiatan" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tanggal Kegiatan</label>
            <input type="date" id="tanggalKegiatan" required class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2" />
          </div>
          <div>
            <label for="lokasiKegiatan" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Lokasi Kegiatan</label>
            <input type="text" id="lokasiKegiatan" class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2" />
          </div>
          <div>
            <label for="penanggungJawab" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Penanggung Jawab</label>
            <input type="text" id="penanggungJawab" class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2" />
          </div>
          <div>
            <label for="statusKegiatan" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status Kegiatan</label>
            <select id="statusKegiatan" required class="form-select w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2">
              <option value="Akan Datang">Akan Datang</option>
              <option value="Sedang Berlangsung">Sedang Berlangsung</option>
              <option value="Selesai">Selesai</option>
              <option value="Dibatalkan">Dibatalkan</option>
            </select>
          </div>
          <div class="flex justify-end space-x-3 mt-6">
            <button
              type="button"
              id="closeKegiatanModalBtn"
              class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200"
            >
              Batal
            </button>
            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">Simpan Kegiatan</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Tambah/Edit Keuangan (Pemasukan/Pengeluaran) -->
    <div id="keuanganModal" class="modal-backdrop hidden">
      <div class="modal-content w-full md:max-w-md max-h-[90vh]">
        <h3 id="keuanganModalTitle" class="text-2xl font-bold mb-6 text-gray-900 dark:text-gray-100">Tambah Transaksi Keuangan</h3>
        <form id="keuanganForm" class="space-y-4">
          <input type="hidden" id="keuanganId" />
          <input type="hidden" id="keuanganJenis" value="" />
          <!-- Will be set to 'Pemasukan' or 'Pengeluaran' -->
          <div>
            <label for="tanggalTransaksi" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tanggal</label>
            <input type="date" id="tanggalTransaksi" required class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2" />
          </div>
          <div>
            <label for="deskripsiTransaksi" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Deskripsi</label>
            <input type="text" id="deskripsiTransaksi" required class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2" />
          </div>
          <div>
            <label for="jumlahTransaksi" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Jumlah (Rp)</label>
            <input type="number" id="jumlahTransaksi" required min="0" class="form-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 rounded-md shadow-sm p-2" />
          </div>
          <div class="flex justify-end space-x-3 mt-6">
            <button
              type="button"
              id="closeKeuanganModalBtn"
              class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200"
            >
              Batal
            </button>
            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">Simpan Transaksi</button>
          </div>
        </form>
      </div>
    </div>
  </body>
</html>
